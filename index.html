<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<title>Áî∞‰∏≠„ÅÆ‰∏ÄÂïè‰∏ÄÁ≠î</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Áî∞‰∏≠„ÅÆ‰∏ÄÂïè‰∏ÄÁ≠î">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#FF8C00">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --orange-50: #FFF8F0;
  --orange-100: #FFECD6;
  --orange-200: #FFD4A8;
  --orange-400: #FFA94D;
  --orange-500: #FF8C00;
  --orange-600: #E67A00;
  --orange-700: #CC6B00;
  --green-400: #4ADE80;
  --green-500: #22C55E;
  --green-600: #16A34A;
  --blue-400: #60A5FA;
  --blue-500: #3B82F6;
  --yellow-400: #FACC15;
  --yellow-500: #EAB308;
  --red-400: #F87171;
  --red-500: #EF4444;
  --gray-100: #F3F4F6;
  --gray-200: #E5E7EB;
  --gray-300: #D1D5DB;
  --gray-400: #9CA3AF;
  --gray-500: #6B7280;
  --gray-600: #4B5563;
  --gray-700: #374151;
  --gray-800: #1F2937;
  --gray-900: #111827;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
  --shadow-xl: 0 16px 50px rgba(0,0,0,0.15);
  --radius: 16px;
  --radius-sm: 10px;
}

body {
  font-family: 'Zen Maru Gothic', sans-serif;
  background: linear-gradient(145deg, #FFF5EB 0%, #FFF0E0 30%, #FFE8D0 100%);
  min-height: 100vh;
  min-height: 100dvh;
  color: var(--gray-800);
  overflow-x: hidden;
  -webkit-tap-highlight-color: transparent;
  -webkit-text-size-adjust: 100%;
  touch-action: manipulation;
}

body::before {
  content: '';
  position: fixed;
  top: -120px;
  right: -120px;
  width: 350px;
  height: 350px;
  background: radial-gradient(circle, rgba(255,140,0,0.12) 0%, transparent 70%);
  border-radius: 50%;
  z-index: 0;
}
body::after {
  content: '';
  position: fixed;
  bottom: -80px;
  left: -80px;
  width: 250px;
  height: 250px;
  background: radial-gradient(circle, rgba(255,169,77,0.1) 0%, transparent 70%);
  border-radius: 50%;
  z-index: 0;
}

.app {
  max-width: 480px;
  margin: 0 auto;
  padding: 20px 16px 100px;
  padding-top: calc(20px + env(safe-area-inset-top));
  padding-bottom: calc(100px + env(safe-area-inset-bottom));
  padding-left: calc(16px + env(safe-area-inset-left));
  padding-right: calc(16px + env(safe-area-inset-right));
  position: relative;
  z-index: 1;
}

/* Header */
.header {
  text-align: center;
  padding: 24px 0 20px;
}
.header h1 {
  font-size: 28px;
  font-weight: 900;
  color: var(--orange-600);
  letter-spacing: -0.5px;
}
.header h1 span { font-size: 32px; }
.header p {
  font-size: 13px;
  color: var(--gray-500);
  margin-top: 4px;
  font-weight: 500;
}
.header { position: relative; min-height: 40px; }
.header h1 { padding-right: 90px; }
.header-btns {
  position: absolute;
  top: 0;
  right: 0;
  display: flex;
  gap: 6px;
}
/* Import screen only has one button */
#screen-import .header {
  display: flex;
  justify-content: flex-end;
  min-height: 40px;
}
#screen-import .help-toggle {
  position: static;
}
.help-toggle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  background: var(--gray-100);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.sound-toggle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  background: var(--gray-100);
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.sound-toggle.muted { opacity: 0.4; }

/* Help modal */
.help-modal {
  max-height: 80vh;
  padding: 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.help-scroll {
  padding: 28px 22px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  flex: 1;
  overscroll-behavior: contain;
}
.help-section {
  margin-bottom: 20px;
}
.help-section h3 {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--orange-600);
}
.help-section p {
  font-size: 13px;
  color: var(--gray-600);
  line-height: 1.7;
  margin-bottom: 6px;
}
.help-prompt {
  background: var(--gray-100);
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 12px;
  color: var(--gray-700);
  margin: 6px 0;
  line-height: 1.5;
  font-style: italic;
}

/* Celebration */
.celebration-modal { text-align: center; }

/* Demo picker */
.demo-picker-modal { max-height: 80vh; }
.demo-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 50vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.demo-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--gray-50);
  border: 1.5px solid var(--gray-200);
  border-radius: 12px;
  padding: 14px 16px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-700);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}
.demo-item:hover { border-color: var(--orange-400); background: var(--orange-50); }
.demo-item span {
  font-size: 12px;
  color: var(--gray-400);
  font-weight: 500;
  flex-shrink: 0;
}

/* Format tabs */
.format-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
.format-tab {
  padding: 6px 12px;
  border-radius: 20px;
  border: 1.5px solid var(--gray-200);
  background: white;
  font-family: inherit;
  font-size: 12px;
  font-weight: 600;
  color: var(--gray-500);
  cursor: pointer;
  transition: all 0.2s;
}
.format-tab.active {
  background: var(--orange-500);
  color: white;
  border-color: var(--orange-500);
}

/* Screen transitions */
.screen { display: none; animation: fadeIn 0.3s ease; }
.screen.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Import screen */
.import-area {
  background: white;
  border-radius: var(--radius);
  padding: 32px 24px;
  text-align: center;
  box-shadow: var(--shadow-md);
  border: 2px dashed var(--orange-200);
  cursor: pointer;
  transition: all 0.25s;
  position: relative;
  overflow: hidden;
}
.import-area:hover {
  border-color: var(--orange-400);
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}
.import-area.dragover {
  border-color: var(--orange-500);
  background: var(--orange-50);
}
.import-icon {
  width: 64px;
  height: 64px;
  margin: 0 auto 16px;
  background: var(--orange-100);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
}
.import-area h3 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--gray-800);
}
.import-area p {
  font-size: 13px;
  color: var(--gray-400);
  line-height: 1.6;
}
.import-area input { display: none; }

.format-hint {
  margin-top: 20px;
  background: var(--gray-100);
  border-radius: var(--radius-sm);
  padding: 16px;
  text-align: left;
}
.format-hint code {
  display: block;
  font-family: 'DM Sans', monospace;
  font-size: 13px;
  color: var(--gray-600);
  line-height: 1.8;
}

.demo-btn {
  margin-top: 16px;
  background: var(--orange-500);
  color: white;
  border: none;
  padding: 14px 28px;
  border-radius: 50px;
  font-family: inherit;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 15px rgba(255,140,0,0.3);
}
.demo-btn:hover {
  background: var(--orange-600);
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(255,140,0,0.4);
}

/* ===== Deck Selector ===== */
.deck-list-section {
  margin-bottom: 20px;
}
.deck-list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.deck-list-header h3 {
  font-size: 14px;
  font-weight: 700;
  color: var(--gray-500);
}
.deck-list-count {
  font-size: 12px;
  font-weight: 600;
  color: var(--gray-400);
}
.deck-list-scroll {
  max-height: 200px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  border-radius: var(--radius);
  border: 1.5px solid var(--gray-200);
  background: var(--gray-50);
}
.deck-list-scroll::-webkit-scrollbar { width: 3px; }
.deck-list-scroll::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 2px; }
.deck-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  cursor: pointer;
  transition: all 0.15s;
  border-bottom: 1px solid var(--gray-100);
}
.deck-item:last-child { border-bottom: none; }
.deck-item:hover { background: var(--orange-50); }
.deck-item.active {
  background: white;
  box-shadow: inset 3px 0 0 var(--orange-500);
}
.deck-item .di-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: linear-gradient(135deg, var(--orange-400), var(--orange-600));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
}
.deck-item .di-info {
  flex: 1;
  min-width: 0;
}
.deck-item .di-name {
  font-size: 14px;
  font-weight: 700;
  color: var(--gray-800);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.deck-item .di-meta {
  font-size: 11px;
  color: var(--gray-400);
  margin-top: 1px;
}
.deck-item .di-actions {
  display: flex;
  gap: 2px;
  flex-shrink: 0;
}
.deck-item .di-btn {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: none;
  background: transparent;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.deck-item .di-btn:hover { background: var(--gray-100); }
.deck-item .di-btn.delete { color: var(--gray-300); font-size: 14px; }
.deck-item .di-btn.delete:hover { background: #FEE2E2; color: var(--red-500); }
.deck-mini-progress {
  display: flex;
  gap: 3px;
  margin-top: 4px;
}
.deck-mini-progress .mini-bar {
  height: 4px;
  border-radius: 2px;
  transition: width 0.3s;
}

/* Dashboard */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 20px;
}
.stat-card {
  background: white;
  border-radius: var(--radius-sm);
  padding: 12px 6px;
  text-align: center;
  box-shadow: var(--shadow-sm);
  transition: transform 0.2s;
}
.stat-card:hover { transform: translateY(-2px); }
.stat-num {
  font-size: 22px;
  font-weight: 900;
  font-family: 'DM Sans', sans-serif;
}
.stat-label {
  font-size: 10px;
  font-weight: 700;
  margin-top: 4px;
  letter-spacing: -0.2px;
}
.stat-card.disabled {
  opacity: 0.35;
  cursor: default;
  pointer-events: none;
}
.stat-card.disabled:hover { transform: none; }
.stat-card.all .stat-num { color: var(--gray-700); }
.stat-card.all .stat-label { color: var(--gray-700); }
.stat-card.unlearned .stat-num { color: var(--gray-400); }
.stat-card.unlearned .stat-label { color: var(--gray-400); }
.stat-card.weak .stat-num { color: var(--red-500); }
.stat-card.weak .stat-label { color: var(--red-500); }
.stat-card.fuzzy .stat-num { color: var(--yellow-500); }
.stat-card.fuzzy .stat-label { color: var(--yellow-500); }
.stat-card.bookmarked .stat-num { color: var(--orange-500); }
.stat-card.bookmarked .stat-label { color: var(--orange-500); }
.stat-card.mastered .stat-num { color: var(--green-500); }
.stat-card.mastered .stat-label { color: var(--green-500); }

/* Progress bar */
.progress-bar-container {
  background: white;
  border-radius: var(--radius-sm);
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}
.progress-bar-container h4 {
  font-size: 13px;
  color: var(--gray-500);
  margin-bottom: 10px;
  font-weight: 500;
}
.progress-bar {
  height: 14px;
  border-radius: 7px;
  background: var(--gray-200);
  overflow: hidden;
  display: flex;
}
.progress-segment {
  height: 100%;
  transition: width 0.5s ease;
}
.progress-segment.mastered { background: var(--green-500); }
.progress-segment.fuzzy { background: var(--yellow-400); }
.progress-segment.weak { background: var(--red-400); }

/* Action buttons */
.action-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}
.action-btn {
  background: white;
  border: none;
  border-radius: var(--radius);
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  cursor: pointer;
  box-shadow: var(--shadow-md);
  transition: all 0.25s;
  text-align: left;
}
.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}
.action-btn:active { transform: scale(0.98); }
.action-btn .icon {
  width: 50px;
  height: 50px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  flex-shrink: 0;
}
.action-btn.study .icon { background: linear-gradient(135deg, var(--orange-400), var(--orange-600)); }
.action-btn.review .icon { background: linear-gradient(135deg, var(--blue-400), var(--blue-500)); }
.action-btn.list .icon { background: linear-gradient(135deg, var(--green-400), var(--green-600)); }
.action-btn.edit-words .icon { background: linear-gradient(135deg, var(--gray-400), var(--gray-600)); }
.action-btn .text h3 {
  font-size: 16px;
  font-weight: 700;
  color: var(--gray-800);
}
.action-btn .text p {
  font-size: 12px;
  color: var(--gray-400);
  margin-top: 2px;
}

.secondary-actions {
  display: flex;
  gap: 10px;
}
.secondary-btn {
  flex: 1;
  background: white;
  border: none;
  border-radius: var(--radius-sm);
  padding: 14px;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-600);
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  transition: all 0.2s;
}
.secondary-btn:hover { background: var(--gray-100); }

/* Quiz screen */
.quiz-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}
.quiz-back {
  background: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.quiz-back:hover { background: var(--gray-100); }
.quiz-progress-text {
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-500);
}
.quiz-progress-bar {
  height: 6px;
  background: var(--gray-200);
  border-radius: 3px;
  margin-bottom: 30px;
  overflow: hidden;
}
.quiz-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--orange-400), var(--orange-500));
  border-radius: 3px;
  transition: width 0.4s ease;
}

#screen-quiz {
  height: calc(100vh - 40px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  display: none;
  flex-direction: column;
  overflow: hidden;
}
#screen-quiz.active {
  display: flex;
}
.quiz-card {
  background: white;
  border-radius: 24px;
  padding: 24px 20px 20px;
  text-align: center;
  box-shadow: var(--shadow-lg);
  margin-bottom: 12px;
  position: relative;
  overflow: hidden;
  flex: 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
}
.quiz-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--orange-400), var(--orange-500));
}
.quiz-card .level-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  margin-bottom: 12px;
  align-self: center;
}
.quiz-card .english-word {
  font-family: 'DM Sans', sans-serif;
  font-size: 32px;
  font-weight: 700;
  color: var(--gray-900);
  margin-bottom: 8px;
  letter-spacing: -0.5px;
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  word-break: break-word;
  overflow-wrap: break-word;
  line-height: 1.3;
  max-height: 35vh;
  overflow: hidden;
}

/* ===== Answer reveal area ===== */
.answer-reveal {
  margin-top: 16px;
  position: relative;
}
.answer-tap-hint {
  font-size: 14px;
  color: var(--gray-400);
  font-weight: 500;
  padding: 12px 0 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.answer-tap-hint .tap-icon {
  font-size: 18px;
  animation: tapBounce 2s ease infinite;
}
@keyframes tapBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}
.answer-text-area {
  display: none;
  font-size: 24px;
  color: var(--orange-500);
  font-weight: 700;
  padding: 8px 0 4px;
  animation: revealFade 0.3s ease;
}
.quiz-card.revealed .answer-tap-hint { display: none; }
.quiz-card.revealed .answer-text-area { display: block; }
.quiz-card.revealed { cursor: default; }

/* Bookmark button */
.bookmark-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 2px solid var(--gray-200);
  background: white;
  font-size: 20px;
  cursor: pointer;
  z-index: 10;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.6;
  flex-shrink: 0;
}
.bookmark-btn.active {
  background: var(--orange-500);
  border-color: var(--orange-500);
  opacity: 1;
}
.card-bookmark {
  position: absolute;
  bottom: 16px;
  right: 16px;
  width: 40px;
  height: 40px;
  font-size: 18px;
}

@keyframes revealFade {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.choices {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.choice-btn {
  background: white;
  border: 2px solid var(--gray-200);
  border-radius: 14px;
  padding: 16px 20px;
  font-family: inherit;
  font-size: 16px;
  font-weight: 600;
  color: var(--gray-700);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
  position: relative;
  overflow: hidden;
}
.choice-btn:hover:not(.disabled) {
  border-color: var(--orange-400);
  background: var(--orange-50);
}
.choice-btn.correct {
  border-color: var(--green-500);
  background: #F0FFF4;
  color: var(--green-600);
  animation: correctPulse 0.4s ease;
}
.choice-btn.wrong {
  border-color: var(--red-500);
  background: #FFF5F5;
  color: var(--red-500);
  animation: shake 0.4s ease;
}
.choice-btn.disabled { pointer-events: none; }
.choice-btn.show-correct {
  border-color: var(--green-500);
  background: #F0FFF4;
}

@keyframes correctPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  75% { transform: translateX(6px); }
}

/* Know / Don't Know buttons */
.know-buttons-wrap {
  margin-top: 20px;
}
.know-buttons {
  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: center;
}
.know-btn {
  flex: 1;
  padding: 18px;
  border-radius: 14px;
  font-family: inherit;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid;
}
.know-btn.dont-know {
  background: #FFF5F5;
  border-color: var(--red-400);
  color: var(--red-500);
}
.know-btn.dont-know:hover { background: #FEE2E2; }
.know-btn.know {
  background: #F0FFF4;
  border-color: var(--green-400);
  color: var(--green-600);
}
.know-btn.know:hover { background: #DCFCE7; }

/* Quiz result */
.quiz-result {
  background: white;
  border-radius: 24px;
  padding: 40px 24px;
  text-align: center;
  box-shadow: var(--shadow-lg);
}
.quiz-result .result-icon {
  font-size: 56px;
  margin-bottom: 16px;
}
.quiz-result h2 {
  font-size: 24px;
  font-weight: 900;
  color: var(--gray-800);
  margin-bottom: 8px;
}
.quiz-result p {
  font-size: 14px;
  color: var(--gray-500);
  margin-bottom: 24px;
  line-height: 1.6;
}
.result-stats {
  display: flex;
  justify-content: center;
  gap: 24px;
  margin-bottom: 28px;
}
.result-stat {
  text-align: center;
}
.result-stat .num {
  font-family: 'DM Sans', sans-serif;
  font-size: 28px;
  font-weight: 700;
}
.result-stat .label {
  font-size: 12px;
  color: var(--gray-400);
  margin-top: 2px;
}
.result-btn {
  background: var(--orange-500);
  color: white;
  border: none;
  padding: 16px 40px;
  border-radius: 50px;
  font-family: inherit;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(255,140,0,0.3);
  transition: all 0.2s;
}
.result-btn:hover {
  background: var(--orange-600);
  transform: translateY(-1px);
}
.result-btn.review-btn {
  background: white;
  color: var(--orange-500);
  border: 2px solid var(--orange-500);
  box-shadow: none;
  margin-bottom: 10px;
}
.result-btn.review-btn:hover {
  background: var(--orange-50);
}
.missed-section {
  text-align: left;
  margin: 20px 0;
  width: 100%;
}
.missed-section h4 {
  font-size: 14px;
  font-weight: 700;
  color: var(--red-500);
  margin-bottom: 10px;
  text-align: center;
}
.missed-list {
  max-height: 240px;
  overflow-y: auto;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-sm);
  -webkit-overflow-scrolling: touch;
}
.missed-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  border-bottom: 1px solid var(--gray-100);
  font-size: 14px;
}
.missed-item:last-child { border-bottom: none; }
.missed-eng {
  font-weight: 600;
  color: var(--gray-800);
}
.missed-jpn {
  color: var(--red-400);
  font-size: 13px;
}

/* Level change summary */
.level-change-section {
  width: 100%;
  margin: 20px 0;
  text-align: left;
}
.level-change-section h4 {
  font-size: 14px;
  font-weight: 700;
  color: var(--gray-600);
  margin-bottom: 12px;
  text-align: center;
}
.lc-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  animation: lcRowSlide 0.4s ease both;
}
.lc-label {
  font-size: 13px;
  font-weight: 700;
  color: var(--gray-600);
  width: 60px;
  text-align: right;
  flex-shrink: 0;
}
.lc-bar-wrap {
  flex: 1;
  height: 28px;
  background: var(--gray-100);
  border-radius: 8px;
  overflow: hidden;
  position: relative;
}
.lc-bar {
  height: 100%;
  border-radius: 8px;
  display: flex;
  align-items: center;
  padding-left: 10px;
  font-size: 13px;
  font-weight: 700;
  color: white;
  min-width: 28px;
}
.lc-count {
  font-size: 13px;
  font-weight: 700;
}
.lc-diff {
  font-size: 16px;
  font-weight: 900;
  width: 40px;
  flex-shrink: 0;
  opacity: 0;
}
.lc-diff.plus { color: var(--green-500); }
.lc-diff.minus { color: var(--red-500); }
@keyframes diffPop {
  0% { opacity: 0; transform: scale(0.5) translateY(8px); }
  60% { opacity: 1; transform: scale(1.2) translateY(-2px); }
  100% { opacity: 1; transform: scale(1) translateY(0); }
}
@keyframes lcRowSlide {
  from { opacity: 0; transform: translateX(-20px); }
  to { opacity: 1; transform: translateX(0); }
}

/* Search bar */
.search-bar {
  display: flex;
  align-items: center;
  background: white;
  border-radius: 12px;
  padding: 10px 14px;
  margin-bottom: 12px;
  box-shadow: var(--shadow-sm);
  border: 2px solid var(--gray-200);
  transition: border-color 0.2s;
}
.search-bar:focus-within { border-color: var(--orange-400); }
.search-bar .search-icon { font-size: 16px; margin-right: 8px; }
.search-bar input {
  flex: 1;
  border: none;
  outline: none;
  font-family: inherit;
  font-size: 15px;
  background: transparent;
  color: var(--gray-800);
}
.search-bar input::placeholder { color: var(--gray-300); }
.search-clear {
  display: none;
  border: none;
  background: var(--gray-200);
  color: var(--gray-500);
  width: 24px;
  height: 24px;
  border-radius: 50%;
  font-size: 12px;
  cursor: pointer;
  align-items: center;
  justify-content: center;
}
.search-clear.show { display: flex; }

/* Deck tabs in word list */
.deck-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
  overflow-x: auto;
  padding-bottom: 4px;
  -webkit-overflow-scrolling: touch;
}
.deck-tabs::-webkit-scrollbar { display: none; }
.deck-tab {
  padding: 8px 16px;
  border-radius: 20px;
  border: 2px solid var(--gray-200);
  background: white;
  font-family: inherit;
  font-size: 13px;
  font-weight: 700;
  color: var(--gray-500);
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
}
.deck-tab:hover { border-color: var(--orange-300); }
.deck-tab.active {
  background: var(--orange-500);
  border-color: var(--orange-500);
  color: white;
}

/* Word list */
.word-list-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}
.word-list-header h2 {
  font-size: 20px;
  font-weight: 900;
  flex: 1;
}
.filter-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.filter-tab {
  padding: 8px 14px;
  border-radius: 20px;
  border: none;
  font-family: inherit;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
  color: var(--gray-500);
  box-shadow: var(--shadow-sm);
}
.filter-tab.active { color: white; }
.filter-tab.all.active { background: var(--gray-700); }
.filter-tab.unlearned.active { background: var(--gray-400); }
.filter-tab.weak.active { background: var(--red-500); }
.filter-tab.fuzzy.active { background: var(--yellow-500); }
.filter-tab.bookmarked.active { background: var(--orange-500); }
.filter-tab.mastered.active { background: var(--green-500); }

.word-items {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 60vh;
  overflow-y: auto;
  padding-right: 4px;
}
.word-items::-webkit-scrollbar { width: 4px; }
.word-items::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 2px; }

.word-item {
  background: white;
  border-radius: var(--radius-sm);
  padding: 12px 14px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  box-shadow: var(--shadow-sm);
  transition: all 0.2s;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
}
.word-item:hover { transform: translateX(4px); }
.word-item .level-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
  margin-top: 5px;
}
.word-item .level-dot.unlearned { background: var(--gray-300); }
.word-item .level-dot.weak { background: var(--red-500); }
.word-item .level-dot.fuzzy { background: var(--yellow-500); }
.word-item .level-dot.bookmarked { background: var(--orange-500); }
.word-item .level-dot.mastered { background: var(--green-500); }
.word-item .eng {
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-800);
  flex: 1;
  min-width: 0;
  word-break: break-word;
  line-height: 1.4;
  transition: all 0.2s;
}
.word-item .eng.hidden-question {
  color: transparent;
  background: var(--gray-200);
  border-radius: 4px;
  min-height: 20px;
}
.word-item .jpn-container {
  position: relative;
  flex-shrink: 0;
  max-width: 45%;
}
.word-item .jpn {
  font-size: 13px;
  color: var(--gray-500);
  transition: all 0.2s;
  word-break: break-word;
}
.word-item .jpn.hidden-answer {
  color: transparent;
  background: var(--gray-200);
  border-radius: 4px;
  padding: 2px 8px;
  font-size: 12px;
  position: relative;
  min-width: 60px;
  text-align: center;
}
.word-item .jpn.hidden-answer::after {
  content: '„Çø„ÉÉ„Éó';
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--gray-400);
  font-size: 11px;
  font-weight: 600;
}

/* Quiz mode selector */
.answer-toggle-btn {
  background: var(--gray-100);
  border: 1.5px solid var(--gray-200);
  border-radius: 20px;
  padding: 6px 14px;
  font-family: inherit;
  font-size: 12px;
  font-weight: 700;
  color: var(--gray-500);
  cursor: pointer;
  transition: all 0.2s;
}
.answer-toggle-btn.hiding {
  background: var(--orange-500);
  color: white;
  border-color: var(--orange-500);
}
#screen-quiz-setup {
  display: none;
  min-height: calc(100vh - 140px);
  flex-direction: column;
  justify-content: center;
}
#screen-quiz-setup.active {
  display: flex;
}
#screen-level-select {
  display: none;
  min-height: calc(100vh - 140px);
  flex-direction: column;
  justify-content: center;
}
#screen-level-select.active {
  display: flex;
}
.mode-selector {
  background: white;
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow-lg);
  margin-bottom: 20px;
}
.mode-selector h3 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  text-align: center;
}
.setup-section-label {
  font-size: 13px;
  font-weight: 700;
  color: var(--gray-500);
  margin-bottom: 8px;
  margin-top: 16px;
}
.setup-word-list {
  max-height: 40vh;
  overflow-y: auto;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  -webkit-overflow-scrolling: touch;
}
.setup-word-item {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  border-bottom: 1px solid var(--gray-100);
  font-size: 14px;
}
.setup-word-item:last-child { border-bottom: none; }
.setup-word-item .sw-eng {
  flex: 1;
  font-weight: 600;
  color: var(--gray-800);
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.setup-word-item .sw-jpn {
  color: var(--gray-400);
  font-size: 13px;
  flex-shrink: 0;
  max-width: 45%;
  text-align: right;
}
.mode-toggle {
  display: flex;
  gap: 0;
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid var(--gray-200);
  margin-bottom: 8px;
}
.mode-toggle-btn {
  flex: 1;
  padding: 14px;
  border: none;
  background: white;
  font-family: inherit;
  font-size: 15px;
  font-weight: 700;
  color: var(--gray-400);
  cursor: pointer;
  transition: all 0.2s;
}
.mode-toggle-btn.active {
  background: var(--orange-500);
  color: white;
}
.drill-desc {
  font-size: 12px;
  color: var(--orange-500);
  text-align: center;
  margin-bottom: 8px;
  font-weight: 600;
}

/* Level select screen */
.level-select-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.level-select-card {
  background: white;
  border-radius: var(--radius);
  padding: 24px 16px;
  text-align: center;
  box-shadow: var(--shadow-md);
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}
.level-select-card:hover { transform: translateY(-2px); }
.level-select-card:active { transform: scale(0.97); }
.level-select-card.disabled {
  opacity: 0.35;
  cursor: default;
  pointer-events: none;
}
.level-select-card.disabled:hover { transform: none; }
.level-select-card .ls-icon { font-size: 28px; margin-bottom: 8px; }
.level-select-card .ls-label {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 4px;
}
.level-select-card .ls-count {
  font-size: 22px;
  font-weight: 900;
  font-family: 'DM Sans', sans-serif;
}
.level-select-card.all .ls-label, .level-select-card.all .ls-count { color: var(--gray-700); }
.level-select-card.unlearned .ls-label, .level-select-card.unlearned .ls-count { color: var(--gray-400); }
.level-select-card.bookmarked .ls-label, .level-select-card.bookmarked .ls-count { color: var(--orange-500); }
.level-select-card.weak .ls-label, .level-select-card.weak .ls-count { color: var(--red-500); }
.level-select-card.fuzzy .ls-label, .level-select-card.fuzzy .ls-count { color: var(--yellow-500); }
.level-select-card.mastered .ls-label, .level-select-card.mastered .ls-count { color: var(--green-500); }
.mode-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.mode-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
}
.mode-option:hover { border-color: var(--orange-300); }
.mode-option.selected { border-color: var(--orange-500); background: var(--orange-50); }
.mode-option .mode-icon { font-size: 24px; }
.mode-option .mode-text h4 {
  font-size: 14px;
  font-weight: 700;
}
.mode-option .mode-text p {
  font-size: 11px;
  color: var(--gray-400);
  margin-top: 1px;
}

.count-selector {
  margin-top: 16px;
  text-align: center;
}
.count-selector label {
  font-size: 13px;
  color: var(--gray-500);
  font-weight: 500;
}
.count-selector select {
  margin-left: 8px;
  padding: 6px 12px;
  border: 2px solid var(--gray-200);
  border-radius: 8px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-700);
  cursor: pointer;
}
.start-quiz-btn {
  width: 100%;
  margin-top: 16px;
  background: var(--orange-500);
  color: white;
  border: none;
  padding: 16px;
  border-radius: 50px;
  font-family: inherit;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(255,140,0,0.3);
  transition: all 0.2s;
}
.start-quiz-btn:hover { background: var(--orange-600); }
.start-quiz-btn:disabled {
  background: var(--gray-300);
  box-shadow: none;
  cursor: not-allowed;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--gray-800);
  color: white;
  padding: 14px 24px;
  border-radius: 50px;
  font-size: 14px;
  font-weight: 600;
  z-index: 1000;
  box-shadow: var(--shadow-xl);
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.toast.show {
  opacity: 1;
  visibility: visible;
}

/* Level badge colors */
.badge-unlearned { background: var(--gray-200); color: var(--gray-500); }
.badge-weak { background: #FEE2E2; color: var(--red-500); }
.badge-fuzzy { background: #FEF9C3; color: var(--yellow-500); }
.badge-bookmarked { background: var(--orange-100); color: var(--orange-500); }
.badge-mastered { background: #DCFCE7; color: var(--green-600); }

/* Confirm modal */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 2000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 24px;
  animation: fadeInOverlay 0.2s ease;
}
.confirm-overlay.show { display: flex; }
@keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
.confirm-modal {
  background: white;
  border-radius: 20px;
  padding: 32px 24px 24px;
  text-align: center;
  max-width: 340px;
  width: 100%;
  box-shadow: var(--shadow-xl);
  animation: modalPop 0.25s ease;
}
@keyframes modalPop {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
.confirm-modal .confirm-icon {
  font-size: 40px;
  margin-bottom: 12px;
}
.confirm-modal h3 {
  font-size: 18px;
  font-weight: 900;
  color: var(--gray-800);
  margin-bottom: 8px;
}
.confirm-modal p {
  font-size: 13px;
  color: var(--gray-500);
  line-height: 1.6;
  margin-bottom: 24px;
}
.confirm-buttons {
  display: flex;
  gap: 10px;
}
.confirm-cancel {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  border: 2px solid var(--gray-200);
  background: white;
  font-family: inherit;
  font-size: 15px;
  font-weight: 700;
  color: var(--gray-600);
  cursor: pointer;
  transition: all 0.2s;
}
.confirm-cancel:hover { background: var(--gray-100); }
.confirm-danger {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: var(--red-500);
  font-family: inherit;
  font-size: 15px;
  font-weight: 700;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(239,68,68,0.3);
}
.confirm-danger:hover { background: #DC2626; }
.rename-input {
  width: 100%;
  padding: 12px 14px;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  font-family: inherit;
  font-size: 15px;
  margin-bottom: 16px;
  outline: none;
  transition: border-color 0.2s;
  box-sizing: border-box;
}
.rename-input:focus { border-color: var(--orange-400); }

/* Word editor */
.editor-header {
  padding: 0;
  margin-bottom: 16px;
}
.editor-header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.editor-title {
  font-size: 22px;
  font-weight: 900;
  color: var(--gray-800);
}
.editor-add-btn {
  background: var(--orange-500);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 6px 14px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
}
.editor-word-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.editor-word-item {
  position: relative;
  overflow: hidden;
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-sm);
  margin-bottom: 2px;
}
.editor-word-item .ew-inner {
  background: white;
  padding: 12px 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
  z-index: 1;
  transition: transform 0.25s ease;
  cursor: pointer;
}
.editor-word-item .ew-content {
  flex: 1;
  min-width: 0;
}
.editor-word-item .ew-eng {
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-800);
  word-break: break-word;
  line-height: 1.4;
}
.editor-word-item .ew-jpn {
  font-size: 12px;
  color: var(--gray-400);
  margin-top: 2px;
  word-break: break-word;
}
.ew-delete-bg {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  width: 80px;
  background: var(--red-500);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
}
.ew-drag-handle {
  color: var(--gray-300);
  font-size: 18px;
  cursor: grab;
  padding: 0 2px;
  flex-shrink: 0;
  touch-action: none;
  user-select: none;
  -webkit-user-select: none;
}
.editor-word-item.dragging {
  opacity: 0.85;
  z-index: 100;
  box-shadow: 0 8px 24px rgba(0,0,0,0.18);
  transform: scale(1.02);
}
.editor-word-item.drag-over-top {
  border-top: 2.5px solid var(--orange-500);
}
.editor-word-item.drag-over-bottom {
  border-bottom: 2.5px solid var(--orange-500);
}
.edit-word-modal .rename-input { margin-bottom: 10px; }

/* Reset button */
.reset-area {
  margin-top: 20px;
  text-align: center;
}
.reset-btn {
  background: none;
  border: none;
  color: var(--gray-400);
  font-family: inherit;
  font-size: 12px;
  cursor: pointer;
  padding: 8px 16px;
  transition: color 0.2s;
}
.reset-btn:hover { color: var(--red-500); }
</style>
</head>
<body>
<div class="app">

  <!-- Screen: Import -->
  <div id="screen-import" class="screen active">
    <div class="header">
      <button class="help-toggle" onclick="showHelp()">‚ùì</button>
    </div>
    <div class="import-area" id="dropZone">
      <div class="import-icon">üìÑ</div>
      <h3>CSV„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄ</h3>
      <p>„Çø„ÉÉ„Éó„Åó„Å¶„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû<br><small>Â∑¶„Å´ÂïèÈ°å„ÄÅÂè≥„Å´Á≠î„Åà „ÅÆCSVÂΩ¢Âºè</small></p>
      <input type="file" id="fileInput" accept=".csv,.txt">
    </div>
    <div class="format-hint">
      <h4 style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--gray-600);">üìã CSV„Éï„Ç©„Éº„Éû„ÉÉ„Éà‰æãÔºàÂ∑¶:ÂïèÈ°å, Âè≥:Á≠î„ÅàÔºâ</h4>
      <div class="format-tabs">
        <button class="format-tab active" onclick="switchFormatTab(0, this)">Ëã±ÂçòË™û</button>
        <button class="format-tab" onclick="switchFormatTab(1, this)">Ê≠¥Âè≤</button>
        <button class="format-tab" onclick="switchFormatTab(2, this)">Êï∞Â≠¶ÂÖ¨Âºè</button>
        <button class="format-tab" onclick="switchFormatTab(3, this)">SPI</button>
        <button class="format-tab" onclick="switchFormatTab(4, this)">ÂÖ¨ÂãôÂì°Ë©¶È®ì</button>
        <button class="format-tab" onclick="switchFormatTab(5, this)">Ë≥áÊ†ºË©¶È®ì</button>
      </div>
      <code id="formatExample">
        abandon,Ë¶ãÊç®„Å¶„Çã<br>
        accomplish,ÈÅîÊàê„Åô„Çã<br>
        adequate,ÂçÅÂàÜ„Å™
      </code>
    </div>
    <div style="text-align:center;margin-top:20px;">
      <button class="demo-btn" onclick="loadDemo()">„Éá„É¢ÂïèÈ°å„ÅßË©¶„Åô</button>
    </div>
  </div>

  <!-- Screen: Dashboard -->
  <div id="screen-dashboard" class="screen">
    <!-- Deck selector - compact list -->
    <div class="deck-list-section">
      <div class="deck-list-header">
        <h3>üìö „Éá„ÉÉ„Ç≠</h3>
        <span class="deck-list-count" id="deckPickerCount">1/1</span>
      </div>
      <div class="deck-list-scroll" id="deckListScroll">
        <div id="deckList"></div>
      </div>
      <div style="margin-top:10px;">
        <button class="secondary-btn" style="width:100%;" onclick="document.getElementById('fileInputAdd').click()">Ôºã Êñ∞„Åó„ÅÑCSV„ÇíËøΩÂä†</button>
        <input type="file" id="fileInputAdd" accept=".csv,.txt" style="display:none" onchange="handleFileAdd(this.files[0])">
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card all" style="cursor:pointer;">
        <div class="stat-num" id="count-all">0</div>
        <div class="stat-label">ÂÖ®„Å¶</div>
      </div>
      <div class="stat-card unlearned" style="cursor:pointer;">
        <div class="stat-num" id="count-unlearned">0</div>
        <div class="stat-label">Êú™Â≠¶Áøí</div>
      </div>
      <div class="stat-card bookmarked" style="cursor:pointer;">
        <div class="stat-num" id="count-bookmarked">0</div>
        <div class="stat-label">‰øùÂ≠òÊ∏à„Åø</div>
      </div>
      <div class="stat-card weak" style="cursor:pointer;">
        <div class="stat-num" id="count-weak">0</div>
        <div class="stat-label">Ëã¶Êâã</div>
      </div>
      <div class="stat-card fuzzy" style="cursor:pointer;">
        <div class="stat-num" id="count-fuzzy">0</div>
        <div class="stat-label">„ÅÜ„ÇçË¶ö„Åà</div>
      </div>
      <div class="stat-card mastered" style="cursor:pointer;">
        <div class="stat-num" id="count-mastered">0</div>
        <div class="stat-label">Ë¶ö„Åà„Åü</div>
      </div>
    </div>

    <div class="action-section">
      <button class="action-btn study" onclick="showLevelSelect()">
        <div class="icon">üìù</div>
        <div class="text">
          <h3>Â≠¶Áøí„ÇíÂßã„ÇÅ„Çã</h3>
          <p>ÁØÑÂõ≤„ÇíÈÅ∏„Çì„Åß‰∏ÄÂïè‰∏ÄÁ≠î„Çπ„Çø„Éº„Éà</p>
        </div>
      </button>
    </div>

    <div class="action-section">
      <button class="action-btn edit-words" onclick="showWordEditor()">
        <div class="icon">‚úèÔ∏è</div>
        <div class="text">
          <h3>ÂïèÈ°å„ÇíÁ∑®ÈõÜ</h3>
          <p>ËøΩÂä†„ÉªÁ∑®ÈõÜ„ÉªÂâäÈô§</p>
        </div>
      </button>
      <button class="action-btn list" onclick="showWordList()">
        <div class="icon">üìñ</div>
        <div class="text">
          <h3>ÂçòË™û‰∏ÄË¶ß</h3>
          <p>„Åô„Åπ„Å¶„ÅÆÂçòË™û„ÇíÁ¢∫Ë™ç</p>
        </div>
      </button>
    </div>

    <div class="reset-area">
      <button class="reset-btn" onclick="confirmAction('„Åì„ÅÆ„Éá„ÉÉ„Ç≠„ÅÆÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà', '„Åô„Åπ„Å¶„ÅÆÂçòË™û„Åå„ÄåÊú™Â≠¶Áøí„Äç„Å´Êàª„Çä„Åæ„Åô„ÄÇ„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ', doResetCurrentDeck)">üóëÔ∏è „Åì„ÅÆ„Éá„ÉÉ„Ç≠„Çí„É™„Çª„ÉÉ„Éà</button>
      <button class="reset-btn" onclick="confirmAction('„Åô„Åπ„Å¶„ÅÆ„Éá„ÉÉ„Ç≠„ÇíÂâäÈô§', '„Åô„Åπ„Å¶„ÅÆ„Éá„ÉÉ„Ç≠„Å®Â≠¶Áøí„Éá„Éº„Çø„ÅåÂÆåÂÖ®„Å´ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ', doResetAll)">üóëÔ∏è „Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§</button>
    </div>
  </div>

  <!-- Screen: Level Select -->
  <div id="screen-level-select" class="screen">
    <div class="quiz-header">
      <button class="quiz-back" onclick="showScreen('dashboard')">‚Üê</button>
      <span class="quiz-progress-text">Âá∫È°åÁØÑÂõ≤„ÇíÈÅ∏Êäû</span>
      <div style="width:40px"></div>
    </div>
    <div class="level-select-grid" id="levelSelectGrid"></div>
  </div>

  <!-- Screen: Quiz Setup -->
  <div id="screen-quiz-setup" class="screen">
    <div class="quiz-header">
      <button class="quiz-back" id="setupBackBtn" onclick="showScreen('dashboard')">‚Üê</button>
      <span class="quiz-progress-text" id="setupTitle">Êú™Â≠¶Áøí</span>
      <div style="width:40px"></div>
    </div>
    <div class="mode-selector">
      <h4 class="setup-section-label">„É¢„Éº„Éâ</h4>
      <div class="mode-toggle" id="modeToggle">
        <button class="mode-toggle-btn active" onclick="selectMode('normal', this)">„Éé„Éº„Éû„É´</button>
        <button class="mode-toggle-btn" onclick="selectMode('drill', this)">ÁâπË®ì</button>
      </div>
      <div class="drill-desc" id="drillDesc" style="display:none;">„ÄåÁü•„Çâ„Å™„ÅÑ„Äç„ÇíÈÅ∏„Çì„Å†ÂçòË™û„ÇíË¶ö„Åà„Çã„Åæ„ÅßÁπ∞„ÇäËøî„ÅóÂá∫È°å„Åó„Åæ„Åô</div>
      <h4 class="setup-section-label">Âá∫È°åÂΩ¢Âºè</h4>
      <div class="mode-toggle" id="reverseToggle">
        <button class="mode-toggle-btn active" onclick="selectReverse(false, this)">ÂïèÈ°å‚ÜíÁ≠î„Åà</button>
        <button class="mode-toggle-btn" onclick="selectReverse(true, this)">Á≠î„Åà‚ÜíÂïèÈ°å</button>
      </div>
      <h4 class="setup-section-label">Ë™≠„Åø‰∏ä„Åí</h4>
      <div class="mode-toggle" id="ttsToggle">
        <button class="mode-toggle-btn active" onclick="selectTTS('question', this)">ÂïèÈ°å„ÅÆ„Åø</button>
        <button class="mode-toggle-btn" onclick="selectTTS('answer', this)">Á≠î„Åà„ÅÆ„Åø</button>
        <button class="mode-toggle-btn" onclick="selectTTS('both', this)">‰∏°Êñπ</button>
        <button class="mode-toggle-btn" onclick="selectTTS('none', this)">„Å™„Åó</button>
      </div>
      <div class="count-selector">
        <label>Âá∫È°åÊï∞Ôºö</label>
        <select id="quizCount">
          <option value="10">10Âïè</option>
          <option value="20">20Âïè</option>
          <option value="30">30Âïè</option>
          <option value="40">40Âïè</option>
          <option value="50">50Âïè</option>
          <option value="60">60Âïè</option>
          <option value="70">70Âïè</option>
          <option value="80">80Âïè</option>
          <option value="90">90Âïè</option>
          <option value="100">100Âïè</option>
          <option value="110">110Âïè</option>
          <option value="120">120Âïè</option>
          <option value="130">130Âïè</option>
          <option value="140">140Âïè</option>
          <option value="150">150Âïè</option>
          <option value="160">160Âïè</option>
          <option value="170">170Âïè</option>
          <option value="180">180Âïè</option>
          <option value="190">190Âïè</option>
          <option value="200">200Âïè</option>
          <option value="all">„Åô„Åπ„Å¶</option>
        </select>
      </div>
      <button class="start-quiz-btn" id="startQuizBtn" onclick="startQuiz()">„Çπ„Çø„Éº„ÉàÔºÅ</button>
    </div>
  </div>

  <!-- Screen: Quiz -->
  <div id="screen-quiz" class="screen">
    <div class="quiz-header">
      <button class="quiz-back" onclick="confirmQuit()">‚Üê</button>
      <span class="quiz-progress-text" id="quizProgressText">1 / 10</span>
      <div style="width:40px"></div>
    </div>
    <div class="quiz-progress-bar">
      <div class="quiz-progress-fill" id="quizProgressFill"></div>
    </div>
    <div class="quiz-card" id="quizCard" onclick="revealAnswer()">
      <div class="level-badge" id="quizBadge">Êú™Â≠¶Áøí</div>
      <div class="english-word" id="quizWord"></div>
      <div class="answer-reveal" id="answerReveal"></div>
      <button class="bookmark-btn card-bookmark" id="bookmarkBtn" onclick="event.stopPropagation();toggleBookmark()">üìå</button>
    </div>
    <div id="quizBody"></div>
  </div>

  <!-- Screen: Result -->
  <div id="screen-result" class="screen">
    <div class="quiz-result" id="resultContent"></div>
  </div>

  <!-- Screen: Word List -->
  <div id="screen-wordlist" class="screen">
    <div class="word-list-header">
      <button class="quiz-back" onclick="showScreen('dashboard')">‚Üê</button>
      <h2>ÂçòË™û‰∏ÄË¶ß</h2>
    </div>
    <div class="search-bar">
      <span class="search-icon">üîç</span>
      <input type="text" id="wordSearchInput" placeholder="ÂçòË™û„ÇíÊ§úÁ¥¢..." oninput="onWordSearch()">
      <button class="search-clear" id="searchClear" onclick="clearWordSearch()">‚úï</button>
    </div>
    <div class="deck-tabs" id="deckTabs"></div>
    <div class="filter-tabs" id="filterTabs"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:8px;">
      <button class="answer-toggle-btn" id="questionToggleBtn" onclick="toggleAllQuestions()">ÂïèÈ°å„ÇíÈö†„Åô</button>
      <button class="answer-toggle-btn" id="answerToggleBtn" onclick="toggleAllAnswers()">Á≠î„Åà„ÇíÈö†„Åô</button>
    </div>
    <div class="word-items" id="wordItems"></div>
  </div>

  <!-- Screen: Word Editor -->
  <div id="screen-word-editor" class="screen">
    <div class="editor-header">
      <div class="editor-header-top">
        <button class="quiz-back" onclick="showScreen('dashboard'); renderDeckList(); updateDashboard();">‚Üê</button>
        <button class="editor-add-btn" onclick="addWordDirect()">ÔºãËøΩÂä†</button>
      </div>
      <h2 class="editor-title">ÂïèÈ°å„ÇíÁ∑®ÈõÜ</h2>
      <div class="search-bar" style="margin-top:10px;">
        <span class="search-icon">üîç</span>
        <input type="text" id="editorSearchInput" placeholder="ÂïèÈ°å„ÇíÊ§úÁ¥¢..." oninput="onEditorSearch()" autocomplete="off">
        <button class="search-clear" id="editorSearchClear" onclick="clearEditorSearch()">‚úï</button>
      </div>
    </div>
    <div class="editor-word-list" id="editorWordList"></div>
  </div>

</div>

  <!-- Modal: Edit Word -->
  <div class="confirm-overlay" id="editWordOverlay" onclick="closeEditWord()">
    <div class="confirm-modal edit-word-modal" onclick="event.stopPropagation()">
      <div class="confirm-icon">‚úèÔ∏è</div>
      <h3 id="editWordTitle">ÂçòË™û„ÇíÁ∑®ÈõÜ</h3>
      <input type="text" id="editWordEng" class="rename-input" placeholder="ÂïèÈ°åÊñá„ÇíÂÖ•Âäõ" autocomplete="off" autocorrect="off" data-form-type="other">
      <input type="text" id="editWordJpn" class="rename-input" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ" autocomplete="off" autocorrect="off" data-form-type="other">
      <div id="insertPositionRow" style="display:none;margin-bottom:14px;">
        <label style="font-size:12px;font-weight:600;color:var(--gray-500);display:block;margin-bottom:6px;">ÊåøÂÖ•‰ΩçÁΩÆ</label>
        <select id="insertPosition" class="rename-input" style="margin-bottom:0;padding:10px 12px;font-size:14px;"></select>
      </div>
      <div class="confirm-buttons">
        <button class="confirm-cancel" onclick="closeEditWord()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="confirm-danger" style="background:var(--orange-500);box-shadow:0 4px 12px rgba(255,140,0,0.3);" onclick="saveWord()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

<!-- Help overlay -->
<div class="confirm-overlay" id="helpOverlay" onclick="closeHelp()">
  <div class="confirm-modal help-modal" onclick="event.stopPropagation()">
    <div class="help-scroll">
      <h2 style="text-align:center;margin-bottom:16px;">üìñ ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</h2>

      <div class="help-section">
        <h3>ü§ñ AI„ÅßCSV„Éï„Ç°„Ç§„É´„Çí‰Ωú„Çã</h3>
        <p>ChatGPT„ÄÅGemini„ÄÅClaude„Å™„Å©„Å´‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´È†º„ÇÄ„Å®ÂïèÈ°åÈõÜ„Çí‰Ωú„Çå„Åæ„ÅôÔºö</p>
        <div class="help-prompt">„ÄåTOEICÈ†ªÂá∫Ëã±ÂçòË™û100ÂÄã„Çí„ÄéËã±ÂçòË™û,Êó•Êú¨Ë™ûË®≥„Äè„ÅÆÂΩ¢Âºè„ÅßCSV„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„Äç</div>
        <p>‰ªñ„Å´„ÇÇÔºö</p>
        <div class="help-prompt">„ÄåÊó•Êú¨Âè≤„ÅÆÈáçË¶ÅÂπ¥Âè∑50ÂÄã„Çí„ÄéÂá∫Êù•‰∫ã,Âπ¥Âè∑„Äè„ÅÆCSV„Å´„Åó„Å¶„Äç</div>
        <div class="help-prompt">„ÄåIT„Éë„Çπ„Éù„Éº„Éà„ÅÆÁî®Ë™û30ÂÄã„Çí„ÄéÁî®Ë™û,ÊÑèÂë≥„Äè„ÅÆCSV„Å´„Åó„Å¶„Äç</div>
      </div>

      <div class="help-section">
        <h3>üíæ CSV„Éï„Ç°„Ç§„É´„ÅÆ‰øùÂ≠òÊñπÊ≥ï</h3>
        <p><strong>„Çπ„Éû„Éõ„ÅÆÂ†¥ÂêàÔºö</strong></p>
        <p>AI„ÅÆÂõûÁ≠î„Çí„Ç≥„Éî„Éº ‚Üí „É°„É¢Â∏≥„Ç¢„Éó„É™„Å´Ë≤º„Çä‰ªò„Åë ‚Üí ÂÖ±Êúâ„É°„Éã„É•„Éº„Åã„Çâ„Äå„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò„Äç„Åß <code>.txt</code> „Åæ„Åü„ÅØ <code>.csv</code> „Åß‰øùÂ≠ò</p>
        <p><strong>PC„ÅÆÂ†¥ÂêàÔºö</strong></p>
        <p>„É°„É¢Â∏≥„Å´Ë≤º„Çä‰ªò„Åë ‚Üí„ÄåÂêçÂâç„Çí‰ªò„Åë„Å¶‰øùÂ≠ò„Äç‚Üí „Éï„Ç°„Ç§„É´Âêç„Çí <code>„Äá„Äá.csv</code> „Å´„Åó„Å¶‰øùÂ≠ò</p>
      </div>

      <div class="help-section">
        <h3>üì• „Éï„Ç°„Ç§„É´„ÅÆÂèñ„ÇäËæº„ÅøÊñπ</h3>
        <p>„Éõ„Éº„É†ÁîªÈù¢„ÅÆ„ÄåÔºã Êñ∞„Åó„ÅÑCSV„ÇíËøΩÂä†„Äç„Çí„Çø„ÉÉ„Éó ‚Üí ‰øùÂ≠ò„Åó„Åü„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åô„Çã„Å†„ÅëÔºÅ</p>
      </div>

      <div class="help-section">
        <h3>üìã CSV„ÅÆÂΩ¢Âºè</h3>
        <p>1Ë°å„Å´„ÄåÂïèÈ°å,Á≠î„Åà„Äç„Çí„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßÊõ∏„Åç„Åæ„ÅôÔºö</p>
        <code style="display:block;margin:8px 0;">apple,„Çä„Çì„Åî<br>ÈéåÂÄâÂπïÂ∫ú„ÅÆÊàêÁ´ã,1185Âπ¥<br>TCP/IP,ÈÄö‰ø°„Éó„É≠„Éà„Ç≥„É´</code>
      </div>

      <div class="help-section">
        <h3>üìù Â≠¶Áøí„ÅÆ‰Ωø„ÅÑÊñπ</h3>
        <p><strong>„Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„Éº„ÉâÔºö</strong> ÂêÑÁä∂ÊÖãÔºàÊú™Â≠¶Áøí„ÉªËã¶Êâã„Å™„Å©Ôºâ„Çí„Çø„ÉÉ„Éó„ÅßÁõ¥Êé•Â≠¶ÁøíÈñãÂßã</p>
        <p><strong>„Éé„Éº„Éû„É´„É¢„Éº„ÉâÔºö</strong> Áü•„Å£„Å¶„Çã/Áü•„Çâ„Å™„ÅÑ„Åß‰ªïÂàÜ„Åë„ÄÇÊ≠£Ëß£„ÅßÁä∂ÊÖã„Åå„Ç¢„ÉÉ„Éó</p>
        <p><strong>ÁâπË®ì„É¢„Éº„ÉâÔºö</strong> ÈñìÈÅï„Åà„ÅüÂïèÈ°å„ÇíË¶ö„Åà„Çã„Åæ„ÅßÁπ∞„ÇäËøî„ÅóÂá∫È°å</p>
        <p><strong>üìå ‰øùÂ≠òÔºö</strong> Ê∞ó„Å´„Å™„ÇãÂçòË™û„Çí„Éî„É≥„Åó„Å¶Âæå„Åß„Åæ„Å®„ÇÅ„Å¶Âæ©Áøí</p>
      </div>

      <button class="result-btn" style="width:100%;margin-top:16px;" onclick="closeHelp()">Èñâ„Åò„Çã</button>
    </div>
  </div>
</div>

<!-- Celebration overlay -->
<canvas id="confettiCanvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;"></canvas>
<div class="confirm-overlay" id="celebrationOverlay">
  <div class="confirm-modal celebration-modal" onclick="event.stopPropagation()">
    <div style="font-size:60px;margin-bottom:12px;">üéä</div>
    <h2 style="color:var(--orange-500);margin-bottom:8px;">ÂÆåÂÖ®Âà∂Ë¶áÔºÅ</h2>
    <p style="font-size:15px;color:var(--gray-600);margin-bottom:4px;"><strong id="celebrationDeck"></strong></p>
    <p style="font-size:28px;font-weight:900;color:var(--green-500);margin-bottom:8px;"><span id="celebrationCount">0</span>Ë™û „Åô„Åπ„Å¶Ë¶ö„Åà„ÅüÔºÅ</p>
    <p style="font-size:14px;color:var(--gray-500);margin-bottom:20px;line-height:1.6;">Êú¨ÂΩì„Å´„Åô„Åî„ÅÑÔºÅ„ÅÇ„Å™„Åü„ÅÆÂä™Âäõ„ÅÆÊàêÊûú„Åß„Åô„ÄÇ<br>„Åì„ÅÆË™øÂ≠ê„ÅßÊ¨°„ÅÆ„Éá„ÉÉ„Ç≠„Å´„ÇÇÊåëÊà¶„Åó„Çà„ÅÜÔºÅ</p>
    <button class="result-btn" onclick="closeCelebration()">„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅüí™</button>
  </div>
</div>

<!-- Demo picker overlay -->
<div class="confirm-overlay" id="demoPickerOverlay" onclick="closeDemoPicker()">
  <div class="confirm-modal demo-picker-modal" onclick="event.stopPropagation()">
    <h3 style="text-align:center;margin-bottom:16px;">üìö „Éá„É¢ÂïèÈ°å„ÇíÈÅ∏Êäû</h3>
    <div class="demo-list">
      <button class="demo-item" onclick="loadDemoData('korean')">üá∞üá∑ ÈüìÂõΩË™û ‰∏≠Á¥ö<span>99Ë™û</span></button>
      <button class="demo-item" onclick="loadDemoData('education_law')">üìú ÊïôËÇ≤Âü∫Êú¨Ê≥ï„ÉªÂ≠¶Ê†°ÊïôËÇ≤Ê≥ï<span>10Ë™û</span></button>
      <button class="demo-item" onclick="loadDemoData('curriculum')">üè´ Â∞èÂ≠¶Ê†°Â≠¶ÁøíÊåáÂ∞éË¶ÅÈ†ò<span>10Ë™û</span></button>
      <button class="demo-item" onclick="loadDemoData('student_guidance')">üìñ ÁîüÂæíÊåáÂ∞éÊèêË¶Å<span>10Ë™û</span></button>
      <button class="demo-item" onclick="loadDemoData('pe_exam')">üèÉ ÊïôÊé° ‰øùÂÅ•‰ΩìËÇ≤<span>10Ë™û</span></button>
      <button class="demo-item" onclick="loadDemoData('kochi_exam')">‚úèÔ∏è ÊïôÊé° ÊïôËÅ∑ÊïôÈ§ä<span>10Ë™û</span></button>
    </div>
    <button class="confirm-cancel" style="width:100%;margin-top:12px;" onclick="closeDemoPicker()">Èñâ„Åò„Çã</button>
  </div>
</div>

<div class="confirm-overlay" id="confirmOverlay" onclick="closeConfirm()">
  <div class="confirm-modal" onclick="event.stopPropagation()">
    <div class="confirm-icon">‚ö†Ô∏è</div>
    <h3 id="confirmTitle">Êú¨ÂΩì„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü</h3>
    <p id="confirmDesc">„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ</p>
    <div class="confirm-buttons">
      <button class="confirm-cancel" onclick="closeConfirm()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="confirm-danger" id="confirmDangerBtn">„É™„Çª„ÉÉ„Éà„Åô„Çã</button>
    </div>
  </div>
</div>

<div class="confirm-overlay" id="renameOverlay" onclick="closeRename()">
  <div class="confirm-modal" onclick="event.stopPropagation()">
    <div class="confirm-icon">‚úèÔ∏è</div>
    <h3>„Éá„ÉÉ„Ç≠Âêç„ÇíÂ§âÊõ¥</h3>
    <input type="text" id="renameInput" class="rename-input" placeholder="Êñ∞„Åó„ÅÑÂêçÂâç" autocomplete="off" autocorrect="off" autocapitalize="off" data-form-type="other" data-1p-ignore>
    <div class="confirm-buttons">
      <button class="confirm-cancel" onclick="closeRename()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="confirm-danger" style="background:var(--orange-500);box-shadow:0 4px 12px rgba(255,140,0,0.3);" id="renameConfirmBtn">Â§âÊõ¥„Åô„Çã</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============ STATE ============
// decks: { id, name, words: [{ english, japanese, level, correctStreak }] }
let decks = [];
let activeDeckId = null;
let currentQuiz = null;
let quizMode = ''; // 'quiz' (4Êäû) or 'flashcard' (‰∏ÄÂïè‰∏ÄÁ≠î)
let selectedRange = 'all';

const LEVELS = {
  unlearned: { label: 'Êú™Â≠¶Áøí', badge: 'badge-unlearned' },
  weak: { label: 'Ëã¶Êâã', badge: 'badge-weak' },
  fuzzy: { label: '„ÅÜ„ÇçË¶ö„Åà', badge: 'badge-fuzzy' },
  mastered: { label: 'Ë¶ö„Åà„Åü', badge: 'badge-mastered' }
};

// ============ AUDIO SYSTEM ============
let audioCtx = null;
let audioEnabled = false;
let soundMuted = false; // Always on

function initAudio() {
  try {
    // If context exists but is in a bad state, destroy it
    if (audioCtx && (audioCtx.state === 'closed' || audioCtx.state === 'suspended')) {
      try { audioCtx.close(); } catch(e) {}
      audioCtx = null;
    }
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
      audioCtx.resume().catch(() => {});
    }
    audioEnabled = true;
  } catch(e) { audioEnabled = false; }
}

function toggleSound() {}

document.addEventListener('DOMContentLoaded', () => {});

// Unlock and keep audio alive on every user interaction (iOS kills AudioContext in background)
document.addEventListener('touchstart', initAudio, { passive: true });
document.addEventListener('touchend', initAudio, { passive: true });
document.addEventListener('click', initAudio);

// Visibility change: force recreate audio context when coming back
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    // Force destroy and recreate on next interaction
    if (audioCtx) {
      try { audioCtx.close(); } catch(e) {}
      audioCtx = null;
      audioEnabled = false;
    }
  }
});

// Periodic check: if context got suspended somehow, fix it
setInterval(() => {
  if (audioCtx && audioCtx.state === 'suspended') {
    audioCtx.resume().catch(() => {});
  }
}, 3000);

function playTone(freq, duration, type, vol) {
  if (soundMuted) return;
  // Always try to ensure audio context is alive
  if (!audioCtx || audioCtx.state === 'closed') {
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      audioEnabled = true;
    } catch(e) { return; }
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume().catch(() => {});
  }
  try {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type || 'sine';
  osc.frequency.value = freq;
  gain.gain.value = vol || 0.15;
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + (duration || 0.2));
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + (duration || 0.2));
  } catch(e) { /* audio context may be in bad state, ignore */ }
}

// Sound effects
function sfxTap() { playTone(800, 0.08, 'sine', 0.18); }
function sfxSelect() { playTone(600, 0.06, 'sine', 0.15); playTone(900, 0.06, 'sine', 0.15); }
function sfxCorrect() {
  playTone(523, 0.12, 'sine', 0.22);
  setTimeout(() => playTone(659, 0.12, 'sine', 0.22), 80);
  setTimeout(() => playTone(784, 0.18, 'sine', 0.22), 160);
}
function sfxWrong() {
  playTone(300, 0.15, 'square', 0.15);
  setTimeout(() => playTone(250, 0.2, 'square', 0.15), 120);
}
function sfxReveal() { playTone(440, 0.1, 'triangle', 0.18); }
function sfxBookmark() {
  playTone(700, 0.08, 'sine', 0.18);
  setTimeout(() => playTone(1050, 0.12, 'sine', 0.2), 60);
}
function sfxStart() {
  playTone(523, 0.1, 'sine', 0.2);
  setTimeout(() => playTone(659, 0.1, 'sine', 0.2), 100);
  setTimeout(() => playTone(784, 0.1, 'sine', 0.2), 200);
  setTimeout(() => playTone(1047, 0.2, 'sine', 0.22), 300);
}
function sfxComplete() {
  [523, 659, 784, 1047].forEach((f, i) => {
    setTimeout(() => playTone(f, 0.2, 'sine', 0.2), i * 120);
  });
  setTimeout(() => {
    [1047, 1319, 1568].forEach((f, i) => {
      setTimeout(() => playTone(f, 0.25, 'sine', 0.18), i * 100);
    });
  }, 500);
}
function sfxBack() { playTone(500, 0.06, 'sine', 0.06); }

// ============ TTS (Text-to-Speech) ============
let ttsVoicesLoaded = false;
let ttsVoiceCache = {};

function loadVoices() {
  if (!('speechSynthesis' in window)) return;
  const voices = window.speechSynthesis.getVoices();
  if (voices.length > 0) {
    ttsVoicesLoaded = true;
    // Cache best voice per language
    ttsVoiceCache['en'] = voices.find(v => v.lang === 'en-US' && !v.localService)
      || voices.find(v => v.lang === 'en-US')
      || voices.find(v => v.lang.startsWith('en'));
    ttsVoiceCache['ja'] = voices.find(v => v.lang === 'ja-JP' && !v.localService)
      || voices.find(v => v.lang === 'ja-JP')
      || voices.find(v => v.lang.startsWith('ja'));
    ttsVoiceCache['ko'] = voices.find(v => v.lang === 'ko-KR' && !v.localService)
      || voices.find(v => v.lang === 'ko-KR')
      || voices.find(v => v.lang.startsWith('ko'));
    ttsVoiceCache['zh'] = voices.find(v => v.lang === 'zh-CN' && !v.localService)
      || voices.find(v => v.lang.startsWith('zh'));
    ttsVoiceCache['fr'] = voices.find(v => v.lang.startsWith('fr'));
    ttsVoiceCache['de'] = voices.find(v => v.lang.startsWith('de'));
    ttsVoiceCache['es'] = voices.find(v => v.lang.startsWith('es'));
  }
}

// Auto-detect language from text
function detectLang(text) {
  if (!text) return 'en';
  // Korean: Hangul block
  if (/[\uAC00-\uD7AF\u1100-\u11FF]/.test(text)) return 'ko';
  // Japanese: Hiragana, Katakana ‚Üí definitely Japanese
  if (/[\u3040-\u309F\u30A0-\u30FF]/.test(text)) return 'ja';
  // CJK ideographs only (kanji only) ‚Üí default to Japanese (this app's primary use)
  // Chinese would need explicit detection via simplified-only chars
  if (/[\u4E00-\u9FFF]/.test(text)) {
    // Check for simplified Chinese-only characters (not used in Japanese)
    if (/[\u4E07\u4E1C\u4E60\u4E66\u4E86\u4EA7\u4EEC\u4F1A\u5173\u51FA\u5BF9\u5C14\u6001\u62A5\u65F6\u8FD9\u8FC7\u8BF7\u8BA9\u8BDD\u7ECF\u8D5E]/.test(text)) return 'zh';
    return 'ja';
  }
  // French common patterns
  if (/[√†√¢√ß√©√®√™√´√Æ√Ø√¥√π√ª√º√ø≈ì√¶]/.test(text.toLowerCase())) return 'fr';
  // German common patterns
  if (/[√§√∂√º√ü]/.test(text.toLowerCase())) return 'de';
  // Spanish
  if (/[√±¬ø¬°]/.test(text)) return 'es';
  // If mostly ASCII letters ‚Üí English
  if (/^[a-zA-Z\s\-'.,;:!?()\d/]+$/.test(text)) return 'en';
  return 'en';
}

function speakText(text) {
  if (soundMuted || !('speechSynthesis' in window) || !text) return;
  // Stop any ongoing speech
  window.speechSynthesis.cancel();
  
  // Clean text: remove emojis, special markers, numbers-only prefixes
  let cleanText = text.replace(/[\u{1F000}-\u{1FFFF}]/gu, '').trim();
  // Skip if text is just numbers or symbols
  if (/^[\d\s.,:;!?()\/\-]+$/.test(cleanText)) return;
  
  const lang = detectLang(cleanText);
  const langMap = { en: 'en-US', ja: 'ja-JP', ko: 'ko-KR', zh: 'zh-CN', fr: 'fr-FR', de: 'de-DE', es: 'es-ES' };
  
  const u = new SpeechSynthesisUtterance(cleanText);
  u.lang = langMap[lang] || 'en-US';
  u.rate = lang === 'en' ? 0.85 : 1.1;
  u.volume = 0.45;
  
  // Set voice from cache
  if (ttsVoiceCache[lang]) {
    u.voice = ttsVoiceCache[lang];
  }
  
  // iOS workaround: speechSynthesis can get stuck, resume it
  if (window.speechSynthesis.paused) {
    window.speechSynthesis.resume();
  }
  
  window.speechSynthesis.speak(u);
  
  // iOS Safari bug workaround: keep alive with periodic resume
  let iosKeepAlive = setInterval(() => {
    if (!window.speechSynthesis.speaking) {
      clearInterval(iosKeepAlive);
    } else {
      window.speechSynthesis.pause();
      window.speechSynthesis.resume();
    }
  }, 5000);
  u.onend = () => clearInterval(iosKeepAlive);
  u.onerror = () => clearInterval(iosKeepAlive);
}

// Convenience aliases
function speakEN(text) { speakText(text); }
function speakJP(text) { speakText(text); }

// Stop all audio (TTS + SFX)
function stopAllAudio() {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
  }
}

// Preload voices
if ('speechSynthesis' in window) {
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;
  // Some browsers need a delay
  setTimeout(loadVoices, 500);
}

function getActiveDeck() {
  return decks.find(d => d.id === activeDeckId) || null;
}
function getActiveWords() {
  const deck = getActiveDeck();
  return deck ? deck.words : [];
}
// For 4-choice quiz, pull distractors from ALL decks
function getAllWords() {
  const all = [];
  decks.forEach(d => d.words.forEach(w => all.push(w)));
  return all;
}

// ============ PERSISTENCE ============
function saveState() {
  try {
    localStorage.setItem('mikan_decks', JSON.stringify(decks));
    localStorage.setItem('mikan_activeDeck', activeDeckId);
  } catch(e) {}
}
function loadState() {
  try {
    // Migration from old format
    const oldWords = localStorage.getItem('mikan_words');
    if (oldWords) {
      const parsed = JSON.parse(oldWords);
      if (parsed.length > 0) {
        decks = [{ id: generateId(), name: '„Ç§„É≥„Éù„Éº„ÉàÊ∏à„Åø', words: parsed }];
        activeDeckId = decks[0].id;
        localStorage.removeItem('mikan_words');
        saveState();
        showScreen('dashboard');
        renderDeckList();
        updateDashboard();
        return;
      }
    }

    const saved = localStorage.getItem('mikan_decks');
    if (saved) {
      decks = JSON.parse(saved);
      activeDeckId = localStorage.getItem('mikan_activeDeck');
      if (decks.length > 0) {
        if (!activeDeckId || !decks.find(d => d.id === activeDeckId)) {
          activeDeckId = decks[0].id;
        }
        showScreen('dashboard');
        renderDeckList();
        updateDashboard();
      }
    }
  } catch(e) {}
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

// ============ CSV IMPORT ============
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    const text = e.target.result;
    const name = file.name.replace(/\.(csv|txt)$/i, '') || '„Ç§„É≥„Éù„Éº„Éà';
    addDeckFromCSV(text, name);
  };
  reader.readAsText(file, 'UTF-8');
}

function handleFileAdd(file) {
  if (!file) return;
  handleFile(file);
  document.getElementById('fileInputAdd').value = '';
}

function addDeckFromCSV(text, deckName) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  const words = [];

  for (const line of lines) {
    const parts = parseCSVLine(line);
    if (parts.length >= 2) {
      const english = parts[0].trim();
      const japanese = parts[1].trim();
      if (english && japanese && english !== 'ÂïèÈ°å' && english !== 'ÈüìÂõΩË™û') {
        words.push({ english, japanese, level: 'unlearned', correctStreak: 0 });
      }
    }
  }

  if (words.length > 0) {
    const deck = { id: generateId(), name: deckName, words };
    decks.push(deck);
    activeDeckId = deck.id;
    saveState();
    showScreen('dashboard');
    renderDeckList();
    updateDashboard();
    showToast(`„Äå${deckName}„Äç„Å´${words.length}Ë™û„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ`);
  } else {
    showToast('ÂçòË™û„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
  }
}

// Parse a single CSV line respecting quoted fields
function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (inQuotes) {
      if (ch === '"' && line[i+1] === '"') {
        current += '"'; i++;
      } else if (ch === '"') {
        inQuotes = false;
      } else {
        current += ch;
      }
    } else {
      if (ch === '"') {
        inQuotes = true;
      } else if (ch === ',' || ch === '\t') {
        result.push(current);
        current = '';
      } else {
        current += ch;
      }
    }
  }
  result.push(current);
  return result;
}

// ============ FORMAT EXAMPLES & HELP ============
const formatExamples = [
  `abandon,Ë¶ãÊç®„Å¶„Çã<br>accomplish,ÈÅîÊàê„Åô„Çã<br>adequate,ÂçÅÂàÜ„Å™`,
  `ÈéåÂÄâÂπïÂ∫ú„ÅÆÊàêÁ´ã,1185Âπ¥<br>Èñ¢„É∂Âéü„ÅÆÊà¶„ÅÑ,1600Âπ¥<br>ÊòéÊ≤ªÁ∂≠Êñ∞,1868Âπ¥`,
  `‰∏âËßíÂΩ¢„ÅÆÈù¢Á©ç„ÅÆÂÖ¨Âºè,Â∫ïËæ∫√óÈ´ò„Åï√∑2<br>ÂÜÜ„ÅÆÈù¢Á©ç„ÅÆÂÖ¨Âºè,œÄ√ór¬≤<br>ÈÄü„Åï„ÅÆÂÖ¨Âºè,Ë∑ùÈõ¢√∑ÊôÇÈñì`,
  `ÊêçÁõäÁÆóÔºöÂéü‰æ°800ÂÜÜ„ÅÆÂìÅ„Å´25%„ÅÆÂà©Áõä„ÇíË¶ãËæº„Çì„Å†ÂÆö‰æ°„ÅØÔºü,1000ÂÜÜ<br>‰ªï‰∫ãÁÆóÔºöA„ÅØ12Êó•„ÉªB„ÅØ6Êó•„ÅßÂÆå‰∫Ü„ÄÇ‰∏ÄÁ∑í„Å´„ÇÑ„Çã„Å®Ôºü,4Êó•`,
  `Ë°åÊîøÊ≥ïÔºöË°åÊîøË°åÁÇ∫„ÅÆÂèñÊ∂à„Åó„Å®Êí§Âõû„ÅÆÈÅï„ÅÑ„ÅØÔºü,ÂèñÊ∂à„Åó„ÅØÈÅ°ÂèäÁöÑ„Å´ÁÑ°Âäπ„ÉªÊí§Âõû„ÅØÂ∞ÜÊù•„Å´Âêë„Åã„Å£„Å¶ÂäπÂäõÊ∂àÊªÖ<br>ÊÜ≤Ê≥ï25Êù°„Åå‰øùÈöú„Åô„ÇãÊ®©Âà©„ÅØÔºü,ÁîüÂ≠òÊ®©`,
  `Á∞øË®òÔºö‰ªïË®≥„ÅßÂÄüÊñπ„Å´Ë®òÂÖ•„Åô„Çã„ÇÇ„ÅÆ„ÅØÔºü,Ë≥áÁî£„ÅÆÂ¢óÂä†„ÉªË≤ªÁî®„ÅÆÁô∫Áîü<br>ÂÆÖÂª∫ÔºöÈáçË¶Å‰∫ãÈ†ÖË™¨Êòé„ÇíË°å„Åà„Çã„ÅÆ„ÅØÔºü,ÂÆÖÂú∞Âª∫Áâ©ÂèñÂºïÂ£´<br>ÂÆÖÂª∫Ôºö„ÇØ„Éº„É™„É≥„Ç∞„Ç™„Éï„ÅÆÊúüÈñì„ÅØÔºü,8Êó•Èñì`
];

function switchFormatTab(index, el) {
  el.parentElement.querySelectorAll('.format-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('formatExample').innerHTML = formatExamples[index];
}

function showHelp() {
  document.getElementById('helpOverlay').classList.add('show');
}
function closeHelp() {
  document.getElementById('helpOverlay').classList.remove('show');
}

function loadDemo() {
  document.getElementById('demoPickerOverlay').classList.add('show');
}

function closeDemoPicker() {
  document.getElementById('demoPickerOverlay').classList.remove('show');
}

function loadDemoData(key) {
  closeDemoPicker();
  const data = DEMO_DECKS[key];
  if (data) {
    addDeckFromCSV(data.csv, data.name);
  }
}

const DEMO_DECKS = {
  korean: {
    name: 'ÈüìÂõΩË™û ‰∏≠Á¥ö',
    csv: `Í≤ΩÏ†ú,ÁµåÊ∏à
ÏÇ¨Ìöå,Á§æ‰ºö
Î¨∏Ìôî,ÊñáÂåñ
Í≤ΩÌóò,ÁµåÈ®ì
Í¥ÄÍ≥Ñ,Èñ¢‰øÇ
Í¥ÄÏã¨,Èñ¢ÂøÉ
ÍµêÌÜµ,‰∫§ÈÄö
ÍµêÏú°,ÊïôËÇ≤
Í∑úÏπô,Ë¶èÂâá
Í≤∞Í≥º,ÁµêÊûú
Í≤∞Ï†ï,Ê±∫ÂÆö
Í≥ºÏ†ï,ÈÅéÁ®ã
ÎÖ∏Î†•,Âä™Âäõ
ÎäêÎÇå,ÊÑü„Åò
Îä•Î†•,ËÉΩÂäõ
Îã§ÏñëÌïòÎã§,Â§öÊßò„Å†
ÎåÄÏã†,‰ª£„Çè„Çä
ÎåÄÏÉÅ,ÂØæË±°
ÎåÄÌöå,Â§ß‰ºö
ÎèÑÏõÄ,Âä©„Åë
ÎèôÍ∏∞,ÂãïÊ©ü
Î™©Ï†Å,ÁõÆÁöÑ
ÎØ∏Îûò,Êú™Êù•
Î∞îÌÉï,Âü∫Á§é„ÉªÂúüÂè∞
Î∞úÏÉùÌïòÎã§,Áô∫Áîü„Åô„Çã
Î∞úÎã¨,Áô∫ÈÅî
Î∞úÏ†Ñ,Áô∫Â±ï
Î∞©Î≤ï,ÊñπÊ≥ï
Î∞©Ìñ•,ÊñπÂêë
Î≥ÄÌôî,Â§âÂåñ
Î≥¥Í¥ÄÌïòÎã§,‰øùÁÆ°„Åô„Çã
Î≥¥Ìò∏ÌïòÎã§,‰øùË≠∑„Åô„Çã
Î∂ÄÏ°±ÌïòÎã§,‰∏çË∂≥„Åô„Çã
Î∂ÑÏïº,ÂàÜÈáé
ÎπÑÏú®,ÊØîÁéá
ÏÇ¨Í±¥,‰∫ã‰ª∂
ÏÇ¨Ïã§,‰∫ãÂÆü
ÏÇ¨ÏóÖ,‰∫ãÊ•≠
ÏÇ¨Ïö©ÌïòÎã§,‰ΩøÁî®„Åô„Çã
ÏÉÅÌÉú,Áä∂ÊÖã
ÏÉÅÌô©,Áä∂Ê≥Å
ÏÉùÌôú,ÁîüÊ¥ª
ÏÑ±Í≥µÌïòÎã§,ÊàêÂäü„Åô„Çã
ÏÑ§Î™ÖÌïòÎã§,Ë™¨Êòé„Åô„Çã
ÏÑ±Í≤©,ÊÄßÊ†º
ÏäµÍ¥Ä,ÁøíÊÖ£
ÏãúÎåÄ,ÊôÇ‰ª£
ÏãúÏÑ§,ÊñΩË®≠
ÏãúÏ≤≠,Ë¶ñËÅ¥„ÉªÂ∏ÇÂΩπÊâÄ
Ïã§Î†•,ÂÆüÂäõ
Ïã§Ïàò,Â§±Êïó„Éª„Éü„Çπ
Ïã§ÏãúÌïòÎã§,ÂÆüÊñΩ„Åô„Çã
Ïã§Ïö©Ï†Å,ÂÆüÁî®ÁöÑ
Ïã¨Í∞ÅÌïòÎã§,Ê∑±Âàª„Å†
ÏïÑÎ¶ÑÎãµÎã§,Áæé„Åó„ÅÑ
ÏïàÎÇ¥ÌïòÎã§,Ê°àÂÜÖ„Åô„Çã
ÏïàÏ†ÑÌïòÎã§,ÂÆâÂÖ®„Å†
ÏïåÏïÑÎ≥¥Îã§,Ë™ø„Åπ„Çã
Ïó∞Íµ¨ÌïòÎã§,Á†îÁ©∂„Åô„Çã
Ïó∞Í∏∞ÌïòÎã§,Âª∂Êúü„Åô„Çã„ÉªÊºîÊäÄ„Åô„Çã
Ïó∞ÎùΩÌïòÎã§,ÈÄ£Áµ°„Åô„Çã
Ïó∞Ï£ºÌïòÎã§,ÊºîÂ•è„Åô„Çã
ÏòàÎ∞©ÌïòÎã§,‰∫àÈò≤„Åô„Çã
ÏòàÏÉÅÌïòÎã§,‰∫àÊÉ≥„Åô„Çã
ÏõêÏù∏,ÂéüÂõ†
ÏúÑÌóòÌïòÎã§,Âç±Èô∫„Å†
Ïú†Î™ÖÌïòÎã§,ÊúâÂêç„Å†
Ïú†ÏßÄÌïòÎã§,Á∂≠ÊåÅ„Åô„Çã
Ïú†ÌñâÌïòÎã§,ÊµÅË°å„Åô„Çã
ÏùòÍ≤¨,ÊÑèË¶ã
ÏùòÎØ∏,ÊÑèÂë≥
Ïù¥ÏÉÅ,‰ª•‰∏ä
Ïù¥Ìïò,‰ª•‰∏ã
Ïù¥Ìï¥ÌïòÎã§,ÁêÜËß£„Åô„Çã
Ïù∏Í∞Ñ,‰∫∫Èñì
Ïù∏Í∏∞,‰∫∫Ê∞ó
Ïù∏Ï†ïÌïòÎã§,Ë™ç„ÇÅ„Çã
ÏùºÏ†ï,Êó•Á®ã
ÏûêÏó∞,Ëá™ÁÑ∂
ÏûêÎ£å,Ë≥áÊñô
ÏûêÏã†,Ëá™‰ø°„ÉªËá™Ë∫´
ÏûêÏú†,Ëá™Áî±
Ïû•Ï†ê,Èï∑ÊâÄ
Îã®Ï†ê,Áü≠ÊâÄ
Ïû¨Î£å,ÊùêÊñô
Ï†ÅÎãπÌïòÎã§,ÈÅ©ÂΩì„Å†
Ï†ÑÎ¨∏Í∞Ä,Â∞ÇÈñÄÂÆ∂
Ï†ÑÌÜµ,‰ºùÁµ±
Ï†ïÎ≥¥,ÊÉÖÂ†±
Ï†ïÏÉÅ,Ê≠£Â∏∏„ÉªÈ†Ç‰∏ä
Ï†ïÌôïÌïòÎã§,Ê≠£Á¢∫„Å†
Ï°∞Í±¥,Êù°‰ª∂
Ï°∞ÏÇ¨ÌïòÎã§,Ë™øÊüª„Åô„Çã
Ï°∞Ïã¨ÌïòÎã§,Ê∞ó„Çí„Å§„Åë„Çã
Ï¢ÖÎ•ò,Á®ÆÈ°û
Ï£ºÏû•ÌïòÎã§,‰∏ªÂºµ„Åô„Çã
Ï§ÄÎπÑÌïòÎã§,Ê∫ñÂÇô„Åô„Çã
Ï¶ùÍ∞ÄÌïòÎã§,Â¢óÂä†„Åô„Çã
Í∞êÏÜåÌïòÎã§,Ê∏õÂ∞ë„Åô„Çã
ÏßÄÏó≠,Âú∞Âüü`
  },
  education_law: {
    name: 'ÊïôËÇ≤Âü∫Êú¨Ê≥ï„ÉªÂ≠¶Ê†°ÊïôËÇ≤Ê≥ï',
    csv: `"ÊïôËÇ≤Âü∫Êú¨Ê≥ïÂâçÊñáÔºöÊ∞ë‰∏ªÁöÑ„ÅßÊñáÂåñÁöÑ„Å™Ôºà„ÄÄÔºâ„ÇíÂª∫Ë®≠„Åó„Å¶‰∏ñÁïå„ÅÆÂπ≥Âíå„Å®‰∫∫È°û„ÅÆÁ¶èÁ•â„Å´Ë≤¢ÁåÆ„Åô„Çã","ÂõΩÂÆ∂"
"ÊïôËÇ≤Âü∫Êú¨Ê≥ïÂâçÊñáÔºöÂÄã‰∫∫„ÅÆÂ∞äÂé≥„ÇíÈáç„Çì„ÅòÔºà„ÄÄÔºâ„Å®Âπ≥Âíå„ÇíÂ∏åÊ±Ç„Åô„Çã‰∫∫Èñì„ÅÆËÇ≤Êàê„ÇíÊúü„Åô„Çã","ÁúüÁêÜ"
"ÊïôËÇ≤Âü∫Êú¨Ê≥ïÁ¨¨1Êù°ÔºöÊïôËÇ≤„ÅØÔºà„ÄÄÔºâ„ÅÆÂÆåÊàê„ÇíÁõÆÊåá„ÅóË°å„Çè„Çå„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑ","‰∫∫Ê†º"
"ÊïôËÇ≤Âü∫Êú¨Ê≥ïÁ¨¨2Êù°ÔºöÔºà„ÄÄÔºâ„Å®ÈÅìÂæ≥ÂøÉ„ÇíÂüπ„ÅÜ„Åì„Å®","Ë±ä„Åã„Å™ÊÉÖÊìç"
"ÊïôËÇ≤Âü∫Êú¨Ê≥ïÁ¨¨4Êù°Ôºö„Åô„Åπ„Å¶ÂõΩÊ∞ë„ÅØÔºà„ÄÄÔºâ„Å´ÊïôËÇ≤„ÇíÂèó„Åë„ÇãÊ©ü‰ºö„Çí‰∏é„Åà„Çâ„Çå„Çã","„Å≤„Å®„Åó„Åè"
"ÊïôËÇ≤Âü∫Êú¨Ê≥ïÁ¨¨5Êù°ÔºöÁæ©ÂãôÊïôËÇ≤„ÅÆÂπ¥Èôê„ÅØÔºà„ÄÄÔºâÂπ¥","9"
"ÊïôËÇ≤Âü∫Êú¨Ê≥ïÁ¨¨6Êù°ÔºöÊ≥ïÂæã„Å´ÂÆö„ÇÅ„ÇãÂ≠¶Ê†°„ÅØÔºà„ÄÄÔºâ„ÅÆÊÄßË≥™„ÇíÊúâ„Åô„Çã„ÇÇ„ÅÆ","ÂÖ¨„ÅÆ"
"ÊïôËÇ≤Âü∫Êú¨Ê≥ïÁ¨¨9Êù°ÔºöÊ≥ïÂæã„Å´ÂÆö„ÇÅ„ÇãÂ≠¶Ê†°„ÅÆÊïôÂì°„ÅØÔºà„ÄÄÔºâ„Å®ÂÆüË∑µÁöÑ„Å™ÊåáÂ∞éÂäõ„ÅÆÂêë‰∏ä„Å´Âä™„ÇÅ„Çã","Áµ∂„Åà„ÅöÁ†îÁ©∂"
"Â≠¶Ê†°ÊïôËÇ≤Ê≥ïÁ¨¨21Êù°„ÅÆÁæ©ÂãôÊïôËÇ≤„ÅÆÁõÆÊ®ô„ÅØÔºà„ÄÄÔºâÂÄã","10"
"Â≠¶Ê†°ÊïôËÇ≤Ê≥ïÁ¨¨37Êù°ÔºöÊ†°Èï∑„ÅØÊ†°Âãô„Çí„Å§„Åã„Åï„Å©„ÇäÔºà„ÄÄÔºâ„ÇíÁõ£Áù£„Åô„Çã","ÊâÄÂ±ûËÅ∑Âì°"`
  },
  curriculum: {
    name: 'Â∞èÂ≠¶Ê†°Â≠¶ÁøíÊåáÂ∞éË¶ÅÈ†ò',
    csv: `"Â≠¶ÁøíÊåáÂ∞éË¶ÅÈ†ò„ÅåËÇ≤Êàê„ÇíÁõÆÊåá„Åô„Éê„É©„É≥„Çπ„ÅÆ„Å®„Çå„ÅüÂäõ„ÅØ‰Ωï„Åã","Áîü„Åç„ÇãÂäõ"
"Â≠¶Ê†°„Å®Á§æ‰ºö„Å®„ÅåÂÖ±Êúâ„Åô„ÇãÊïôËÇ≤Ë™≤Á®ã„Çí‰Ωï„Å®Âëº„Å∂„Åã","Á§æ‰ºö„Å´Èñã„Åã„Çå„ÅüÊïôËÇ≤Ë™≤Á®ã"
"ÊïôËÇ≤Ë™≤Á®ã„ÇíÁ∑®Êàê„ÅóÂÆüÊñΩ„ÅóË©ï‰æ°„Åó„Å¶ÊîπÂñÑ„ÇíÂõ≥„ÇãÂñ∂„Åø„Çí‰Ωï„Å®„ÅÑ„ÅÜ„Åã","„Ç´„É™„Ç≠„É•„É©„É†„Éª„Éû„Éç„Ç∏„É°„É≥„Éà"
"Ôºà„ÄÄÔºâ„ÉªÂØæË©±ÁöÑ„ÅßÊ∑±„ÅÑÂ≠¶„Å≥","‰∏ª‰ΩìÁöÑ"
"Êú™Áü•„ÅÆÁä∂Ê≥Å„Å´„ÇÇÂØæÂøú„Åß„Åç„ÇãÔºà„ÄÄÔºâ„ÉªÂà§Êñ≠Âäõ„ÉªË°®ÁèæÂäõÁ≠â","ÊÄùËÄÉÂäõ"
"Â≠¶„Å≥„Å´Âêë„Åã„ÅÜÂäõ„ÉªÔºà„ÄÄÔºâÁ≠â„ÇíÊ∂µÈ§ä„Åô„Çã","‰∫∫ÈñìÊÄß"
"Ë®ÄË™ûËÉΩÂäõ„ÉªÔºà„ÄÄÔºâËÉΩÂäõ„ÉªÂïèÈ°åÁô∫Ë¶ãËß£Ê±∫ËÉΩÂäõÁ≠â„ÅØÂ≠¶Áøí„ÅÆÂü∫Áõ§„Å®„Å™„ÇãË≥áË≥™ËÉΩÂäõ","ÊÉÖÂ†±Ê¥ªÁî®"
"„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞„Çí‰ΩìÈ®ì„Åó„Å™„Åå„ÇâË´ñÁêÜÁöÑÊÄùËÄÉÂäõ„ÇíË∫´„Å´‰ªò„Åë„ÇãÊïôËÇ≤„ÅØÔºü","„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞ÊïôËÇ≤"
"Â∞èÂ≠¶Ê†°„ÅÆÊéàÊ•≠„ÅÆ1Âçò‰ΩçÊôÇÈñì„ÅØÂéüÂâá„Å®„Åó„Å¶‰ΩïÂàÜ„Åã","45ÂàÜ"
"Â§ñÂõΩË™ûÊ¥ªÂãï„ÅÆÊåáÂ∞éÂØæË±°Â≠¶Âπ¥„ÅØÔºü","Á¨¨3Â≠¶Âπ¥Âèä„Å≥Á¨¨4Â≠¶Âπ¥"`
  },
  student_guidance: {
    name: 'ÁîüÂæíÊåáÂ∞éÊèêË¶Å',
    csv: `"ÁîüÂæíÊåáÂ∞é„Å®„ÅØÂÖêÁ´•ÁîüÂæí„ÅÆËá™Áô∫ÁöÑ„Éª‰∏ª‰ΩìÁöÑ„Å™ÊàêÈï∑„ÇíÊîØ„Åà„ÇãÔºà„ÄÄÔºâ","ÊïôËÇ≤Ê¥ªÂãï"
"ÁîüÂæíÊåáÂ∞é„ÅÆÁõÆÁöÑ„ÅØÂÄãÊÄß„ÅÆÁô∫Ë¶ã„Å®„Çà„Åï„ÇÑÂèØËÉΩÊÄß„ÅÆ‰º∏Èï∑„Å®Ôºà„ÄÄÔºâ„ÅÆËÇ≤Êàê","Á§æ‰ºöÁöÑË≥áË≥™„ÉªË°åÂãïÂäõ"
"ÂÖêÁ´•ÁîüÂæí„ÅåËá™Áô∫ÁöÑ„Éª‰∏ª‰ΩìÁöÑ„Å´Ëá™„Çâ„ÇíÁô∫ÈÅî„Åï„Åõ„Å¶„ÅÑ„ÅèÈÅéÁ®ã„ÇíÔºà„ÄÄÔºâ„Å®„ÅÑ„ÅÜ","Ëá™Â∑±ÊåáÂ∞éËÉΩÂäõ"
"ÁîüÂæíÊåáÂ∞é„ÅÆÂÆüË∑µ‰∏ä„ÅÆË¶ñÁÇπ„Å®„Åó„Å¶Ëá™Â∑±Â≠òÂú®ÊÑü„ÅÆÊÑüÂèó„Å®Ôºà„ÄÄÔºâ„ÅÆ‰øÉÈÄ≤","ÂÖ±ÊÑüÁöÑ„Å™‰∫∫ÈñìÈñ¢‰øÇ"
"Áô∫ÈÅîÊîØÊåÅÁöÑÁîüÂæíÊåáÂ∞é„ÅØÔºà„ÄÄÔºâ„ÅÆÂÖêÁ´•ÁîüÂæí„ÇíÂØæË±°„Å®„Åô„Çã","ÂÖ®„Å¶"
"Ë™≤È°å‰∫àÈò≤ÁöÑÁîüÂæíÊåáÂ∞é„ÅÆÁ¨¨1ÊÆµÈöé„ÅØÔºà„ÄÄÔºâÁöÑ„Å™‰∫àÈò≤ÊïôËÇ≤","ÂÖ®‰Ωì"
"„ÅÑ„Åò„ÇÅÈò≤Ê≠¢ÂØæÁ≠ñÊé®ÈÄ≤Ê≥ï„Å´„Åä„Åë„Çã„ÅÑ„Åò„ÇÅ„ÅÆÂÆöÁæ©Ôºö‰∏ÄÂÆö„ÅÆ‰∫∫ÈñìÈñ¢‰øÇ„Å´„ÅÇ„ÇãÔºà„ÄÄÔºâ","‰ªñ„ÅÆÂÖêÁ´•Á≠â„ÅåË°å„ÅÜÂøÉÁêÜÁöÑÂèà„ÅØÁâ©ÁêÜÁöÑ„Å™ÂΩ±Èüø„Çí‰∏é„Åà„ÇãË°åÁÇ∫"
"„ÅÑ„Åò„ÇÅ„ÅÆË™çÁü•„Å´Èöõ„Åó„ÄåÂøÉË∫´„ÅÆËã¶Áóõ„ÇíÊÑü„Åò„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„Äç„ÅÆÂà§Êñ≠„ÅØÔºà„ÄÄÔºâ„Å´Á´ã„Å§","Ë¢´ÂÆ≥ÂÖêÁ´•ÁîüÂæí„ÅÆÁ´ãÂ†¥"
"‰∏çÁôªÊ†°ÂÖêÁ´•ÁîüÂæí„Å∏„ÅÆÊîØÊè¥„ÅÆÁõÆÊ®ô„ÅØÔºà„ÄÄÔºâÁöÑËá™Á´ã„ÇíÁõÆÊåá„Åô„Åì„Å®","Á§æ‰ºö"
"„ÉÅ„Éº„É†Â≠¶Ê†°„Å®„Åó„Å¶ÁîüÂæíÊåáÂ∞é„ÇíÈÄ≤„ÇÅ„ÇãÈöõ„ÅÆÂ∞ÇÈñÄ„Çπ„Çø„ÉÉ„Éï„ÅÆ‰æã„ÅØÔºü","„Çπ„ÇØ„Éº„É´„Ç´„Ç¶„É≥„Çª„É©„Éº„Éª„Çπ„ÇØ„Éº„É´„ÇΩ„Éº„Ç∑„É£„É´„ÉØ„Éº„Ç´„Éº"`
  },
  pe_exam: {
    name: 'ÊïôÊé° ‰øùÂÅ•‰ΩìËÇ≤',
    csv: `"‰∏≠Â≠¶Ê†°‰øùÂÅ•‰ΩìËÇ≤„ÅÆÁõÆÊ®ôÔºöÔºà„ÄÄÔºâ„ÅÆ‰øùÊåÅÂ¢óÈÄ≤„Å®Ë±ä„Åã„Å™„Çπ„Éù„Éº„ÉÑ„É©„Ç§„Éï„ÅÆÂÆüÁèæ","ÂøÉË∫´"
"‰ΩìËÇ≤ÂàÜÈáé„ÅÆÁõÆÊ®ôÔºöÈÅãÂãï„ÅÆÂêàÁêÜÁöÑ„Å™ÂÆüË∑µ„ÇíÈÄö„Åó„Å¶Ôºà„ÄÄÔºâ„ÇíÂüπ„ÅÜ","ÈÅãÂãï„ÅÆÊ•Ω„Åó„Åï„ÇÑÂñú„Å≥"
"‰øùÂÅ•ÂàÜÈáé„ÅßÂ≠¶Áøí„Åô„ÇãÂÜÖÂÆπ„ÅÆ„ÅÜ„Å°Á¨¨1Â≠¶Âπ¥„ÅØÔºà„ÄÄÔºâ","ÂøÉË∫´„ÅÆÊ©üËÉΩ„ÅÆÁô∫ÈÅî„Å®ÂøÉ„ÅÆÂÅ•Â∫∑"
"‰Ωì„Å§„Åè„ÇäÈÅãÂãï„ÅÆ2„Å§„ÅÆÈ†òÂüü„ÅØ‰Ωì„Åª„Åê„Åó„ÅÆÈÅãÂãï„Å®Ôºà„ÄÄÔºâ","‰Ωì„ÅÆÂãï„Åç„ÇíÈ´ò„ÇÅ„ÇãÈÅãÂãï"
"Âô®Ê¢∞ÈÅãÂãï„ÅÆÁ®ÆÁõÆ„ÅØ4Á®ÆÈ°ûÔºö„Éû„ÉÉ„ÉàÈÅãÂãï„ÉªÈâÑÊ£íÈÅãÂãï„ÉªÂπ≥ÂùáÂè∞ÈÅãÂãï„ÉªÔºà„ÄÄÔºâ","Ë∑≥„Å≥ÁÆ±ÈÅãÂãï"
"Èô∏‰∏äÁ´∂ÊäÄ„ÅÆÁ®ÆÁõÆ„ÅØÁü≠Ë∑ùÈõ¢Ëµ∞„ÉªÈï∑Ë∑ùÈõ¢Ëµ∞„ÉªÔºà„ÄÄÔºâ„ÉªËµ∞„ÇäÂπÖË∑≥„Å≥„ÉªËµ∞„ÇäÈ´òË∑≥„Å≥","„Éè„Éº„Éâ„É´Ëµ∞"
"Ê∞¥Ê≥≥„ÅÆÊ≥≥Ê≥ï„ÅØ„ÇØ„É≠„Éº„É´„ÉªÂπ≥Ê≥≥„Åé„ÉªËÉåÊ≥≥„Åé„ÉªÔºà„ÄÄÔºâ","„Éê„Çø„Éï„É©„Ç§"
"Ê≠¶ÈÅì„Å®„Åó„Å¶‰∏≠Â≠¶Ê†°„ÅßÊåáÂ∞é„Åô„Çã‰∏ª„Å™Á®ÆÁõÆ„ÅØÊüîÈÅì„Å®Ôºà„ÄÄÔºâ","Ââ£ÈÅì"
"„ÉÄ„É≥„Çπ„ÅÆÈ†òÂüü„ÅØÂâµ‰Ωú„ÉÄ„É≥„Çπ„Éª„Éï„Ç©„Éº„ÇØ„ÉÄ„É≥„Çπ„ÉªÔºà„ÄÄÔºâ","Áèæ‰ª£ÁöÑ„Å™„É™„Ç∫„É†„ÅÆ„ÉÄ„É≥„Çπ"
"‰ΩìËÇ≤ÁêÜË´ñ„ÅßÊâ±„ÅÜÂÜÖÂÆπ„ÅÆ‰∏Ä„Å§ÔºöÈÅãÂãï„ÇÑ„Çπ„Éù„Éº„ÉÑ„ÅÆÊÑèÁæ©„ÇÑÂäπÊûú„Å®Ôºà„ÄÄÔºâ","Â≠¶„Å≥Êñπ„ÇÑÂÆâÂÖ®„Å™Ë°å„ÅÑÊñπ"`
  },
  kochi_exam: {
    name: 'ÊïôÊé° ÊïôËÅ∑ÊïôÈ§ä',
    csv: `"„Çπ„Ç≠„Éä„Éº„ÅåÊèêÂî±„Åó„Åü„Çπ„É¢„Éº„É´„Çπ„ÉÜ„ÉÉ„Éó„ÅßÈÄ≤„ÇÅ„ÇãÂ≠¶ÁøíÁêÜË´ñ„ÅØÔºü","„Éó„É≠„Ç∞„É©„É†Â≠¶Áøí"
"„Éñ„É´„Éº„Éä„Éº„ÅåÊèêÂî±„Åó„ÅüÂ≠¶ÁøíËÄÖ„ÅåËá™„ÇâÊ≥ïÂâá„ÇíË¶ã„Å§„Åë„ÇãÂ≠¶ÁøíÁêÜË´ñ„ÅØÔºü","Áô∫Ë¶ãÂ≠¶Áøí"
"„É¥„Ç£„Ç¥„ÉÑ„Ç≠„Éº„ÅÆÁô∫ÈÅî„ÅÆÊúÄËøëÊé•È†òÂüü„ÅÆË™¨Êòé„ÅØÔºü","Ëá™Âäõ„Åß„ÅØËß£Ê±∫„Åß„Åç„Å™„ÅÑ„ÅåÊè¥Âä©„Åå„ÅÇ„Çå„Å∞„Åß„Åç„ÇãÈ†òÂüü"
"„Éî„Ç¢„Ç∏„Çß„ÅÆË™çÁü•Áô∫ÈÅîÊÆµÈöé„ÅßÂÖ∑‰ΩìÁöÑÊìç‰ΩúÊúü„ÅØ‰ΩïÊ≠≥È†É„ÅãÔºü","7„Äú11Ê≠≥È†É"
"„Éû„Ç∫„É≠„Éº„ÅÆÊ¨≤Ê±ÇÊÆµÈöéË™¨„ÅÆÊúÄ‰∏ä‰Ωç„ÅØ‰Ωï„ÅãÔºü","Ëá™Â∑±ÂÆüÁèæ„ÅÆÊ¨≤Ê±Ç"
"„Éñ„É´„Éº„É†„ÅåÊèêÂî±„Åó„ÅüÂÆåÂÖ®ÁøíÂæóÂ≠¶Áøí„Çí‰Ωï„Å®„ÅÑ„ÅÜ„ÅãÔºü","„Éû„Çπ„Çø„É™„Éº„É©„Éº„Éã„É≥„Ç∞"
"„Éá„É•„Éº„Ç§„ÅåÈáçË¶ñ„Åó„ÅüÁµåÈ®ì‰∏ªÁæ©„ÅÆÂ≠¶ÁøíÊñπÊ≥ï„ÅØÔºü","ÂïèÈ°åËß£Ê±∫Â≠¶Áøí"
"„É≠„Ç∏„É£„Éº„Ç∫„ÅåÊèêÂî±„Åó„ÅüÂ≠¶Áøí„Çí‰øÉÈÄ≤„Åô„ÇãÊïôÂ∏´„ÅÆÊÖãÂ∫¶„ÅØÔºü","ÂÖ±ÊÑüÁöÑÁêÜËß£„ÉªÁÑ°Êù°‰ª∂„ÅÆËÇØÂÆöÁöÑÈÖçÊÖÆ„ÉªËá™Â∑±‰∏ÄËá¥"
"„Éê„É≥„Éá„É•„Éº„É©„ÅÆÁ§æ‰ºöÁöÑÂ≠¶ÁøíÁêÜË´ñ„Å´„Åä„Åë„Çã‰∏≠ÂøÉÁöÑÊ¶ÇÂøµ„ÅØÔºü","Ë¶≥ÂØüÂ≠¶ÁøíÔºà„É¢„Éá„É™„É≥„Ç∞Ôºâ"
"PDCA„Çµ„Ç§„ÇØ„É´„ÅÆPDCA„Å®„ÅØ‰Ωï„ÅÆÁï•„ÅãÔºü","Plan„ÉªDo„ÉªCheck„ÉªAction"`
  }
};

// ============ DECK LIST ============
function renderDeckList() {
  if (decks.length === 0) return;
  const container = document.getElementById('deckList');
  container.innerHTML = decks.map(deck => {
    const counts = { unlearned: 0, weak: 0, fuzzy: 0, mastered: 0 };
    deck.words.forEach(w => { if (counts[w.level] !== undefined) counts[w.level]++; });
    const isActive = deck.id === activeDeckId;
    return `
      <div class="deck-item ${isActive ? 'active' : ''}" onclick="selectDeck('${deck.id}')">
        <div class="di-icon">üìñ</div>
        <div class="di-info">
          <div class="di-name">${escapeHtml(deck.name)}</div>
          <div class="di-meta">${deck.words.length}Ë™û „Éª Ë¶ö„Åà„Åü ${counts.mastered}Ë™û</div>
        </div>
        <div class="di-actions">
          <button class="di-btn" onclick="event.stopPropagation();renameDeck('${deck.id}')">‚úèÔ∏è</button>
          <button class="di-btn delete" onclick="event.stopPropagation();deleteDeck('${deck.id}')">‚úï</button>
        </div>
      </div>
    `;
  }).join('');

  const countEl = document.getElementById('deckPickerCount');
  if (countEl) {
    const idx = decks.findIndex(d => d.id === activeDeckId) + 1;
    countEl.textContent = `${idx} / ${decks.length}`;
  }

  // Scroll active item into view
  setTimeout(() => {
    const active = container.querySelector('.deck-item.active');
    if (active) active.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 50);
}

function selectDeck(id) {
  sfxSelect();
  activeDeckId = id;
  saveState();
  renderDeckList();
  updateDashboard();
}

function deleteDeck(id) {
  const deck = decks.find(d => d.id === id);
  if (!deck) return;
  confirmAction('„Éá„ÉÉ„Ç≠„ÇíÂâäÈô§', '„Äå' + deck.name + '„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ', function() {
    decks = decks.filter(d => d.id !== id);
    if (activeDeckId === id) {
      activeDeckId = decks.length > 0 ? decks[0].id : null;
    }
    saveState();
    if (decks.length === 0) {
      showScreen('import');
    } else {
      renderDeckList();
      updateDashboard();
    }
    showToast('„Éá„ÉÉ„Ç≠„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
  }, 'ÂâäÈô§„Åô„Çã');
}

let renamingDeckId = null;

function renameDeck(id) {
  const deck = decks.find(d => d.id === id);
  if (!deck) return;
  renamingDeckId = id;
  document.getElementById('renameInput').value = deck.name;
  document.getElementById('renameOverlay').classList.add('show');
  setTimeout(() => document.getElementById('renameInput').focus(), 100);
  document.getElementById('renameConfirmBtn').onclick = function() {
    const newName = document.getElementById('renameInput').value.trim();
    if (!newName) return;
    deck.name = newName;
    saveState();
    renderDeckList();
    closeRename();
    showToast('„Éá„ÉÉ„Ç≠Âêç„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü');
  };
}

function closeRename() {
  document.getElementById('renameOverlay').classList.remove('show');
  renamingDeckId = null;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ============ SCREENS ============
function showScreen(name) {
  sfxTap();
  stopAllAudio();
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');
}

// ============ DASHBOARD ============
function updateDashboard() {
  const words = getActiveWords();
  const counts = { unlearned: 0, weak: 0, fuzzy: 0, mastered: 0, bookmarked: 0 };
  words.forEach(w => {
    if (w.level === 'almost') w.level = 'mastered';
    if (counts[w.level] !== undefined) counts[w.level]++;
    if (w.bookmarked) counts.bookmarked++;
  });

  ['unlearned', 'weak', 'fuzzy', 'mastered'].forEach(level => {
    const el = document.getElementById(`count-${level}`);
    el.textContent = counts[level];
    const card = el.closest('.stat-card');
    if (card) {
      card.classList.toggle('disabled', counts[level] === 0);
      card.onclick = counts[level] > 0 ? () => showQuizSetupWithLevel(level) : null;
    }
  });
  const bkEl = document.getElementById('count-bookmarked');
  bkEl.textContent = counts.bookmarked;
  const bkCard = bkEl.closest('.stat-card');
  if (bkCard) {
    bkCard.classList.toggle('disabled', counts.bookmarked === 0);
    bkCard.onclick = counts.bookmarked > 0 ? () => showQuizSetupWithLevel('bookmarked') : null;
  }
  const allEl = document.getElementById('count-all');
  allEl.textContent = words.length;
  const allCard = allEl.closest('.stat-card');
  if (allCard) {
    allCard.classList.toggle('disabled', words.length === 0);
    allCard.onclick = words.length > 0 ? () => showQuizSetupWithLevel('all') : null;
  }

  const total = words.length || 1;
  const bar = document.getElementById('progressBar');
  if (bar) {
    bar.innerHTML = '';
    ['mastered', 'fuzzy', 'weak'].forEach(level => {
      if (counts[level] > 0) {
        const seg = document.createElement('div');
        seg.className = `progress-segment ${level}`;
        seg.style.width = `${(counts[level] / total) * 100}%`;
        bar.appendChild(seg);
      }
    });
  }

  // ‚ë† Celebration: all words mastered!
  if (words.length > 0 && counts.mastered === words.length) {
    showCelebration();
  }
}

function showCelebration() {
  // Only show once per deck completion
  const deck = getActiveDeck();
  if (!deck) return;
  const key = 'celebrated_' + deck.id;
  if (localStorage.getItem(key) === String(deck.words.length)) return;
  localStorage.setItem(key, String(deck.words.length));

  const overlay = document.getElementById('celebrationOverlay');
  if (!overlay) return;
  const deckName = deck.name;
  document.getElementById('celebrationDeck').textContent = deckName;
  document.getElementById('celebrationCount').textContent = deck.words.length;
  overlay.classList.add('show');
  sfxComplete();
  setTimeout(() => sfxComplete(), 800);

  // Confetti
  launchConfetti();
}

function closeCelebration() {
  document.getElementById('celebrationOverlay').classList.remove('show');
}

function launchConfetti() {
  const canvas = document.getElementById('confettiCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const colors = ['#FF8C00','#22C55E','#3B82F6','#EF4444','#FACC15','#A855F7','#EC4899'];
  const pieces = [];
  for (let i = 0; i < 100; i++) {
    pieces.push({
      x: Math.random() * canvas.width,
      y: -20 - Math.random() * 200,
      w: 6 + Math.random() * 6,
      h: 4 + Math.random() * 4,
      color: colors[Math.floor(Math.random() * colors.length)],
      vy: 2 + Math.random() * 3,
      vx: (Math.random() - 0.5) * 3,
      rot: Math.random() * 360,
      rotSpeed: (Math.random() - 0.5) * 10
    });
  }
  let frame = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    pieces.forEach(p => {
      p.y += p.vy;
      p.x += p.vx;
      p.rot += p.rotSpeed;
      p.vy += 0.05;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot * Math.PI / 180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    });
    frame++;
    if (frame < 180) requestAnimationFrame(draw);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  draw();
}

// ============ LEVEL SELECT ============
function showLevelSelect() {
  showScreen('level-select');
  const words = getActiveWords();
  const bookmarkedCount = words.filter(w => w.bookmarked).length;
  const counts = { unlearned: 0, weak: 0, fuzzy: 0, mastered: 0 };
  words.forEach(w => {
    if (w.level === 'almost') w.level = 'mastered';
    if (counts[w.level] !== undefined) counts[w.level]++;
  });

  const options = [
    { key: 'all', icon: 'üìö', label: 'ÂÖ®„Å¶', count: words.length, cls: 'all' },
    { key: 'unlearned', icon: '‚¨ú', label: 'Êú™Â≠¶Áøí', count: counts.unlearned, cls: 'unlearned' },
    { key: 'bookmarked', icon: 'üìå', label: '‰øùÂ≠òÊ∏à„Åø', count: bookmarkedCount, cls: 'bookmarked' },
    { key: 'weak', icon: 'üî¥', label: 'Ëã¶Êâã', count: counts.weak, cls: 'weak' },
    { key: 'fuzzy', icon: 'üü°', label: '„ÅÜ„ÇçË¶ö„Åà', count: counts.fuzzy, cls: 'fuzzy' },
    { key: 'mastered', icon: 'üü¢', label: 'Ë¶ö„Åà„Åü', count: counts.mastered, cls: 'mastered' },
  ];

  document.getElementById('levelSelectGrid').innerHTML = options.map(opt => {
    const disabled = opt.count === 0;
    return `
    <div class="level-select-card ${opt.cls} ${disabled ? 'disabled' : ''}" ${disabled ? '' : `onclick="showQuizSetupWithLevel('${opt.key}')"`}>
      <div class="ls-icon">${opt.icon}</div>
      <div class="ls-label">${opt.label}</div>
      <div class="ls-count">${opt.count}Ë™û</div>
    </div>
  `}).join('');
}

// ============ QUIZ SETUP ============
let quizDrillMode = false;
let reviewMode = false;
let reverseMode = false;
let ttsMode = 'question'; // 'question', 'answer', 'both', 'none'

function startMissedReview() {
  const missed = currentQuiz.results.filter(r => !r.correct);
  const seen = new Set();
  const pool = missed.filter(r => {
    if (seen.has(r.word.english)) return false;
    seen.add(r.word.english);
    return true;
  }).map(r => r.word);

  if (pool.length === 0) return;

  pool.sort(() => Math.random() - 0.5);

  reviewMode = true;
  quizMode = 'flashcard';
  quizDrillMode = true;

  // Save current levels (won't be changed)
  const beforeLevels = {};
  pool.forEach(w => { beforeLevels[w.english] = w.level; });

  currentQuiz = {
    words: pool,
    index: 0,
    correct: 0,
    wrong: 0,
    results: [],
    totalCount: pool.length,
    masteredCount: 0,
    beforeLevels: beforeLevels
  };

  showScreen('quiz');
  sfxStart();
  showQuizQuestion();
} // false = normal, true = drill

let quizSetupFrom = 'dashboard';

function showQuizSetupWithLevel(level) {
  // Track where we came from
  const currentScreen = document.querySelector('.screen.active');
  if (currentScreen && currentScreen.id === 'screen-level-select') {
    quizSetupFrom = 'level-select';
  } else {
    quizSetupFrom = 'dashboard';
  }

  quizMode = 'flashcard';
  selectedRange = level;
  quizDrillMode = false;
  reverseMode = false;
  ttsMode = 'question';
  showScreen('quiz-setup');

  // Reset mode toggle UI
  document.querySelectorAll('#modeToggle .mode-toggle-btn').forEach((b, i) => {
    b.classList.toggle('active', i === 0);
  });
  document.getElementById('drillDesc').style.display = 'none';
  document.querySelectorAll('#reverseToggle .mode-toggle-btn').forEach((b, i) => {
    b.classList.toggle('active', i === 0);
  });
  document.querySelectorAll('#ttsToggle .mode-toggle-btn').forEach((b, i) => {
    b.classList.toggle('active', i === 0);
  });

  // Set back button
  document.getElementById('setupBackBtn').onclick = function() {
    showScreen(quizSetupFrom);
    if (quizSetupFrom === 'level-select') showLevelSelect();
  };

  // Title
  const levelNames = {
    all: 'ÂÖ®„Å¶', unlearned: 'Êú™Â≠¶Áøí', weak: 'Ëã¶Êâã', fuzzy: '„ÅÜ„ÇçË¶ö„Åà', mastered: 'Ë¶ö„Åà„Åü', bookmarked: '‰øùÂ≠òÊ∏à„Åø'
  };
  document.getElementById('setupTitle').textContent = levelNames[level] || level;

  // Check pool availability
  const pool = getQuizPool();

  // Reset mode toggle
  document.querySelectorAll('#modeToggle .mode-toggle-btn').forEach((b, i) => {
    b.classList.toggle('active', i === 0);
  });
  document.getElementById('drillDesc').style.display = 'none';
  document.querySelectorAll('#reverseToggle .mode-toggle-btn').forEach((b, i) => {
    b.classList.toggle('active', i === 0);
  });
  document.querySelectorAll('#ttsToggle .mode-toggle-btn').forEach((b, i) => {
    b.classList.toggle('active', i === 0);
  });

  updateStartBtn();
}

function selectMode(mode, el) {
  quizDrillMode = (mode === 'drill');
  el.parentElement.querySelectorAll('.mode-toggle-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('drillDesc').style.display = quizDrillMode ? 'block' : 'none';
}

function selectReverse(isReverse, el) {
  reverseMode = isReverse;
  el.parentElement.querySelectorAll('.mode-toggle-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function selectTTS(mode, el) {
  ttsMode = mode;
  el.parentElement.querySelectorAll('.mode-toggle-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function updateStartBtn() {
  const btn = document.getElementById('startQuizBtn');
  const pool = getQuizPool();
  btn.disabled = pool.length === 0;
  btn.textContent = pool.length === 0 ? 'ÂØæË±°„ÅÆÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' : '„Çπ„Çø„Éº„ÉàÔºÅ';
}

function getQuizPool() {
  const words = getActiveWords();
  if (selectedRange === 'all') return [...words];
  if (selectedRange === 'bookmarked') return words.filter(w => w.bookmarked);
  return words.filter(w => w.level === selectedRange);
}

// ============ QUIZ ============
function startQuiz() {
  reviewMode = false;
  let pool = getQuizPool();
  if (pool.length === 0) return;

  pool = pool.sort(() => Math.random() - 0.5);

  const countSel = document.getElementById('quizCount').value;
  const count = countSel === 'all' ? pool.length : Math.min(parseInt(countSel), pool.length);
  pool = pool.slice(0, count);

  // Save original levels before quiz
  const beforeLevels = {};
  pool.forEach(w => { beforeLevels[w.english] = w.level; });

  currentQuiz = {
    words: pool,
    index: 0,
    correct: 0,
    wrong: 0,
    results: [],
    totalCount: pool.length,
    masteredCount: 0,
    beforeLevels: beforeLevels
  };

  showScreen('quiz');
  sfxStart();
  showQuizQuestion();
}

function showQuizQuestion() {
  const q = currentQuiz;
  const word = q.words[q.index];

  if (quizDrillMode) {
    document.getElementById('quizProgressText').textContent = `${q.masteredCount} / ${q.totalCount}`;
    document.getElementById('quizProgressFill').style.width = `${(q.masteredCount / q.totalCount) * 100}%`;
  } else {
    document.getElementById('quizProgressText').textContent = `${q.index + 1} / ${q.totalCount}`;
    document.getElementById('quizProgressFill').style.width = `${(q.index / q.totalCount) * 100}%`;
  }

  // Migrate old 'almost' level
  if (word.level === 'almost') word.level = 'mastered';

  const badge = document.getElementById('quizBadge');
  const levelInfo = LEVELS[word.level] || LEVELS.unlearned;
  badge.textContent = levelInfo.label;
  badge.className = `level-badge ${levelInfo.badge}`;

  // ‚ë¢ Reverse mode: swap question/answer display
  const questionText = reverseMode ? word.japanese : word.english;
  const answerText = reverseMode ? word.english : word.japanese;

  const quizWordEl = document.getElementById('quizWord');
  quizWordEl.textContent = questionText;

  // ‚ë° Auto-size: shrink font for long text
  autoSizeQuizWord(quizWordEl);

  // Read the question word aloud (respects ttsMode)
  if (ttsMode === 'question' || ttsMode === 'both') {
    speakText(questionText);
  }

  // Reset card state
  const card = document.getElementById('quizCard');
  card.classList.remove('revealed');
  
  // Update bookmark button in card
  const bkmBtn = document.getElementById('bookmarkBtn');
  if (bkmBtn) bkmBtn.classList.toggle('active', !!word.bookmarked);

  const answerReveal = document.getElementById('answerReveal');
  const body = document.getElementById('quizBody');

  // Answer area inside card (hint + hidden answer)
  answerReveal.innerHTML = `
    <div class="answer-tap-hint"><span class="tap-icon">üëÜ</span> „Çø„ÉÉ„Éó„Åó„Å¶Á≠î„Åà„ÇíË¶ã„Çã</div>
    <div class="answer-text-area">${escapeHtml(answerText)}</div>
  `;

  if (quizMode === 'flashcard') {
    body.innerHTML = `
      <div class="know-buttons-wrap">
        <div class="know-buttons" id="knowButtons" style="opacity:0.3;pointer-events:none;">
          <button class="know-btn dont-know" onclick="answerKnowledge(false)">Áü•„Çâ„Å™„ÅÑ</button>
          <button class="know-btn know" onclick="answerKnowledge(true)">Áü•„Å£„Å¶„Çã</button>
        </div>
      </div>
    `;
  } else {
    const choices = generateChoices(word);
    const correctAnswer = word.japanese;
    body.innerHTML = `
      <div class="choices">
        ${choices.map((c, i) => `
          <button class="choice-btn" onclick="answerChoice(this, ${i}, ${c === correctAnswer})">${escapeHtml(c)}</button>
        `).join('')}
      </div>
    `;
  }
}

// ‚ë° Auto-size quiz question text to fit within card
function autoSizeQuizWord(el) {
  el.style.fontSize = '';
  const sizes = [32, 26, 22, 18, 15, 13];
  for (const size of sizes) {
    el.style.fontSize = size + 'px';
    if (el.scrollHeight <= el.clientHeight + 4) return;
  }
}

function revealAnswer() {
  const card = document.getElementById('quizCard');
  if (card.classList.contains('revealed')) return;
  card.classList.add('revealed');
  sfxReveal();
  // Read the answer aloud (respects ttsMode)
  if (currentQuiz && (ttsMode === 'answer' || ttsMode === 'both')) {
    const word = currentQuiz.words[currentQuiz.index];
    const answerText = reverseMode ? word.english : word.japanese;
    setTimeout(() => speakText(answerText), 200);
  }
  // Enable the know/don't-know buttons
  const btns = document.getElementById('knowButtons');
  if (btns) {
    btns.style.opacity = '1';
    btns.style.pointerEvents = 'auto';
  }
}

function toggleBookmark() {
  const word = currentQuiz.words[currentQuiz.index];
  word.bookmarked = !word.bookmarked;
  sfxBookmark();
  const btn = document.getElementById('bookmarkBtn');
  btn.classList.toggle('active', word.bookmarked);
  saveState();
}

function generateChoices(targetWord) {
  const correct = targetWord.japanese;
  // Pull distractors from all decks for better variety
  const allW = getAllWords().filter(w => w.japanese !== correct);
  const shuffled = allW.sort(() => Math.random() - 0.5).slice(0, 3);
  const choices = [correct, ...shuffled.map(w => w.japanese)];
  return choices.sort(() => Math.random() - 0.5);
}

function answerKnowledge(known) {
  const word = currentQuiz.words[currentQuiz.index];

  if (known) {
    sfxCorrect();
    currentQuiz.correct++;
    if (!reviewMode) {
      if (word.level === 'unlearned') {
        word.level = 'fuzzy';
        word.correctStreak = 1;
      } else if (word.level === 'weak') {
        word.level = 'fuzzy';
        word.correctStreak = 1;
      } else if (word.level === 'fuzzy') {
        word.level = 'mastered';
        word.correctStreak = 2;
      }
    }
    currentQuiz.results.push({ word, correct: true });
    if (quizDrillMode) currentQuiz.masteredCount++;
  } else {
    sfxWrong();
    currentQuiz.wrong++;
    if (!reviewMode) {
      word.level = 'weak';
      word.correctStreak = 0;
    }
    currentQuiz.results.push({ word, correct: false });

    // Drill mode: re-queue the word later
    if (quizDrillMode) {
      const remaining = currentQuiz.words.slice(currentQuiz.index + 1);
      const insertPos = Math.min(2 + Math.floor(Math.random() * 4), remaining.length);
      remaining.splice(insertPos, 0, word);
      currentQuiz.words = [...currentQuiz.words.slice(0, currentQuiz.index + 1), ...remaining];
    }
  }

  saveState();
  nextQuestion();
}

function answerChoice(btn, index, isCorrect) {
  const allBtns = btn.parentElement.querySelectorAll('.choice-btn');
  allBtns.forEach(b => b.classList.add('disabled'));

  const word = currentQuiz.words[currentQuiz.index];

  if (isCorrect) {
    btn.classList.add('correct');
    sfxCorrect();
    currentQuiz.correct++;
    word.correctStreak = (word.correctStreak || 0) + 1;
    if (word.correctStreak >= 2) word.level = 'mastered';
    else if (word.correctStreak >= 1) word.level = 'fuzzy';
    currentQuiz.results.push({ word, correct: true });
  } else {
    btn.classList.add('wrong');
    sfxWrong();
    currentQuiz.wrong++;
    word.level = 'weak';
    word.correctStreak = 0;
    allBtns.forEach(b => {
      if (b.textContent === word.japanese) b.classList.add('show-correct');
    });
    currentQuiz.results.push({ word, correct: false });
  }

  saveState();
  setTimeout(() => nextQuestion(), isCorrect ? 600 : 1200);
}

function nextQuestion() {
  currentQuiz.index++;
  if (quizDrillMode) {
    if (currentQuiz.masteredCount >= currentQuiz.totalCount) {
      showResult();
    } else if (currentQuiz.index >= currentQuiz.words.length) {
      showResult();
    } else {
      showQuizQuestion();
    }
  } else {
    if (currentQuiz.index >= currentQuiz.words.length) {
      showResult();
    } else {
      showQuizQuestion();
    }
  }
}

function showResult() {
  // Stop any ongoing speech/audio
  if ('speechSynthesis' in window) window.speechSynthesis.cancel();
  showScreen('result');
  sfxComplete();
  const q = currentQuiz;
  const totalAnswered = quizDrillMode ? q.totalCount : q.words.length;
  const pct = Math.round((q.correct / totalAnswered) * 100);

  let emoji, msg;
  if (pct >= 90) { emoji = 'üéâ'; msg = '„Åô„Å∞„Çâ„Åó„ÅÑÔºÅ'; }
  else if (pct >= 70) { emoji = 'üòä'; msg = '„ÅÑ„ÅÑË™øÂ≠êÔºÅ'; }
  else if (pct >= 50) { emoji = 'üí™'; msg = '„ÇÇ„ÅÜÂ∞ë„ÅóÈ†ëÂºµ„Çç„ÅÜÔºÅ'; }
  else { emoji = 'üìö'; msg = 'Âæ©Áøí„ÅåÂ§ß‰∫ãÔºÅ'; }

  // Calculate cumulative counts (all words in active deck) for AFTER
  const allWords = getActiveWords();
  const afterCumulative = { unlearned: 0, weak: 0, fuzzy: 0, mastered: 0 };
  allWords.forEach(w => {
    if (w.level === 'almost') w.level = 'mastered';
    if (afterCumulative[w.level] !== undefined) afterCumulative[w.level]++;
  });

  // Calculate diffs: what changed during this quiz
  const seenWords = new Set();
  const diffs = { unlearned: 0, weak: 0, fuzzy: 0, mastered: 0 };
  q.words.forEach(w => {
    if (seenWords.has(w.english)) return;
    seenWords.add(w.english);
    const before = q.beforeLevels[w.english] || 'unlearned';
    const after = w.level;
    if (before !== after) {
      if (diffs[before] !== undefined) diffs[before]--;
      if (diffs[after] !== undefined) diffs[after]++;
    }
  });

  const levelNames = { unlearned: 'Êú™Â≠¶Áøí', weak: 'Ëã¶Êâã', fuzzy: '„ÅÜ„ÇçË¶ö„Åà', mastered: 'Ë¶ö„Åà„Åü' };
  const levelColors = { unlearned: 'var(--gray-400)', weak: 'var(--red-500)', fuzzy: 'var(--yellow-500)', mastered: 'var(--green-500)' };
  const levelOrder = ['mastered', 'fuzzy', 'weak', 'unlearned'];

  const totalWords = allWords.length || 1;

  // Build level change bars with animation data
  let levelChangeHtml = '<div class="level-change-section">';
  levelChangeHtml += '<h4>„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÂåñ</h4>';
  levelOrder.forEach((level, idx) => {
    const count = afterCumulative[level];
    const diff = diffs[level];
    const diffStr = diff > 0 ? `<span class="lc-diff plus">+${diff}</span>` : diff < 0 ? `<span class="lc-diff minus">${diff}</span>` : `<span class="lc-diff"></span>`;
    const barWidth = Math.round((count / totalWords) * 100);
    // Before width for animation
    const beforeCount = count - diff;
    const beforeWidth = Math.round((beforeCount / totalWords) * 100);
    levelChangeHtml += `
      <div class="lc-row" style="animation-delay:${idx * 0.15}s">
        <div class="lc-label">${levelNames[level]}</div>
        <div class="lc-bar-wrap">
          <div class="lc-bar" data-before="${beforeWidth}" data-after="${barWidth}" style="width:${beforeWidth}%;background:${levelColors[level]}">
            <span class="lc-count" data-from="${beforeCount}" data-to="${count}">${beforeCount}</span>
          </div>
        </div>
        ${diffStr}
      </div>
    `;
  });
  levelChangeHtml += '</div>';

  // Missed words
  const missed = q.results.filter(r => !r.correct);
  const seenMissed = new Set();
  const uniqueMissed = missed.filter(r => {
    if (seenMissed.has(r.word.english)) return false;
    seenMissed.add(r.word.english);
    return true;
  });

  let missedHtml = '';
  if (uniqueMissed.length > 0) {
    missedHtml = `
      <div class="missed-section">
        <h4>„Åæ„Å°„Åå„Åà„ÅüÂïèÈ°åÔºà${uniqueMissed.length}Ë™ûÔºâ</h4>
        <div class="missed-list">
          ${uniqueMissed.map(r => `
            <div class="missed-item" onclick="speakText('${escapeHtml(r.word.english)}')" style="cursor:pointer;">
              <span class="missed-eng">${escapeHtml(r.word.english)}</span>
              <span class="missed-jpn">${escapeHtml(r.word.japanese)}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  document.getElementById('resultContent').innerHTML = `
    <div class="result-icon">${emoji}</div>
    <h2>${msg}</h2>
    <p>${totalAnswered}Âïè‰∏≠ ${q.correct}ÂïèÊ≠£Ëß£</p>
    <div class="result-stats">
      <div class="result-stat">
        <div class="num" style="color:var(--green-500)">${q.correct}</div>
        <div class="label">Ê≠£Ëß£</div>
      </div>
      <div class="result-stat">
        <div class="num" style="color:var(--red-500)">${q.wrong}</div>
        <div class="label">‰∏çÊ≠£Ëß£</div>
      </div>
      <div class="result-stat">
        <div class="num" style="color:var(--orange-500)">${pct}%</div>
        <div class="label">Ê≠£Á≠îÁéá</div>
      </div>
    </div>
    ${levelChangeHtml}
    ${missedHtml}
    ${uniqueMissed.length > 0 ? '<button class="result-btn review-btn" onclick="startMissedReview()">„Åæ„Å°„Åå„Åà„ÅüÂïèÈ°å„ÇíÂæ©Áøí„Åô„Çã</button>' : ''}
    <button class="result-btn" onclick="showScreen(\'dashboard\'); renderDeckList(); updateDashboard();">„Éõ„Éº„É†„Å´Êàª„Çã</button>
  `;

  // Animate bars and counters after render
  setTimeout(() => animateLevelBars(), 400);
}

function animateLevelBars() {
  document.querySelectorAll('.lc-bar').forEach(bar => {
    const beforeW = parseInt(bar.dataset.before);
    const afterW = parseInt(bar.dataset.after);
    bar.style.transition = 'width 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
    bar.style.width = afterW + '%';

    // Animate counter
    const countEl = bar.querySelector('.lc-count');
    if (countEl) {
      const from = parseInt(countEl.dataset.from);
      const to = parseInt(countEl.dataset.to);
      if (from !== to) {
        const duration = 800;
        const start = performance.now();
        function tick(now) {
          const t = Math.min((now - start) / duration, 1);
          const ease = 1 - Math.pow(1 - t, 3);
          countEl.textContent = Math.round(from + (to - from) * ease);
          if (t < 1) requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      }
    }
  });

  // Animate diff badges
  document.querySelectorAll('.lc-diff').forEach((el, i) => {
    el.style.animation = `diffPop 0.4s ease ${0.6 + i * 0.15}s both`;
  });
}

function showMissedWords() {
  const missed = currentQuiz.results.filter(r => !r.correct);
  if (missed.length === 0) {
    showToast('„Åæ„Å°„Åå„Åà„ÅüÂïèÈ°å„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºÅüéâ');
    return;
  }
  showScreen('wordlist');
  const items = document.getElementById('wordItems');
  document.getElementById('filterTabs').innerHTML = '';
  items.innerHTML = missed.map(r => `
    <div class="word-item" data-eng="${escapeHtml(r.word.english)}" data-jpn="${escapeHtml(r.word.japanese)}" onclick="toggleWordAnswer(this)">
      <div class="level-dot ${r.word.level}"></div>
      <div class="eng">${escapeHtml(r.word.english)}</div>
      <div class="jpn-container"><div class="jpn">${escapeHtml(r.word.japanese)}</div></div>
    </div>
  `).join('');
}

function confirmQuit() {
  confirmAction('„ÇØ„Ç§„Ç∫„Çí‰∏≠Êñ≠', '‰∏≠Êñ≠„Åó„Åæ„Åô„ÅãÔºü„Åì„Åì„Åæ„Åß„ÅÆÈÄ≤Êçó„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ', function() {
    showScreen('dashboard');
    renderDeckList();
    updateDashboard();
  }, '‰∏≠Êñ≠„Åô„Çã');
}

// ============ WORD LIST ============
let wordListDeckId = null; // track which deck is shown in word list

function showWordList() {
  wordListDeckId = activeDeckId;
  showScreen('wordlist');
  answersHidden = false;
  questionsHidden = false;
  const abtn = document.getElementById('answerToggleBtn');
  if (abtn) { abtn.textContent = 'Á≠î„Åà„ÇíÈö†„Åô'; abtn.classList.remove('hiding'); }
  const qbtn = document.getElementById('questionToggleBtn');
  if (qbtn) { qbtn.textContent = 'ÂïèÈ°å„ÇíÈö†„Åô'; qbtn.classList.remove('hiding'); }
  const searchInput = document.getElementById('wordSearchInput');
  if (searchInput) { searchInput.value = ''; }
  document.getElementById('searchClear')?.classList.remove('show');
  currentWordFilter = 'all';
  renderDeckTabs();
  renderFilterTabs();
  renderWordList('all');
}

function renderDeckTabs() {
  const container = document.getElementById('deckTabs');
  container.innerHTML = decks.map(deck => `
    <button class="deck-tab ${deck.id === wordListDeckId ? 'active' : ''}" onclick="switchWordListDeck('${deck.id}', this)">${escapeHtml(deck.name)} (${deck.words.length})</button>
  `).join('');
}

function switchWordListDeck(deckId, el) {
  wordListDeckId = deckId;
  el.parentElement.querySelectorAll('.deck-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderFilterTabs();
  renderWordList('all');
}

function getWordListWords() {
  const deck = decks.find(d => d.id === wordListDeckId);
  return deck ? deck.words : [];
}

function renderFilterTabs() {
  const words = getWordListWords();
  const bookmarkedCount = words.filter(w => w.bookmarked).length;
  const counts = { all: words.length, unlearned: 0, weak: 0, fuzzy: 0, mastered: 0 };
  words.forEach(w => {
    if (counts[w.level] !== undefined) counts[w.level]++;
  });

  const tabs = [
    { key: 'all', label: `„Åô„Åπ„Å¶ (${counts.all})` },
    { key: 'bookmarked', label: `‰øùÂ≠òÊ∏à„Åø (${bookmarkedCount})` },
    { key: 'unlearned', label: `Êú™Â≠¶Áøí (${counts.unlearned})` },
    { key: 'weak', label: `Ëã¶Êâã (${counts.weak})` },
    { key: 'fuzzy', label: `„ÅÜ„ÇçË¶ö„Åà (${counts.fuzzy})` },
    { key: 'mastered', label: `Ë¶ö„Åà„Åü (${counts.mastered})` },
  ];

  document.getElementById('filterTabs').innerHTML = tabs.map((t, i) => `
    <button class="filter-tab ${t.key} ${i === 0 ? 'active' : ''}" onclick="filterWords('${t.key}', this)">${t.label}</button>
  `).join('');
}

let currentWordFilter = 'all';

function onWordSearch() {
  const input = document.getElementById('wordSearchInput');
  const clearBtn = document.getElementById('searchClear');
  clearBtn.classList.toggle('show', input.value.length > 0);
  renderWordList(currentWordFilter);
}

function clearWordSearch() {
  document.getElementById('wordSearchInput').value = '';
  document.getElementById('searchClear').classList.remove('show');
  renderWordList(currentWordFilter);
}

function filterWords(level, el) {
  el.parentElement.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  currentWordFilter = level;
  renderWordList(level);
}

let answersHidden = false;
let questionsHidden = false;

function toggleAllAnswers() {
  answersHidden = !answersHidden;
  const btn = document.getElementById('answerToggleBtn');
  btn.textContent = answersHidden ? 'Á≠î„Åà„ÇíË°®Á§∫' : 'Á≠î„Åà„ÇíÈö†„Åô';
  btn.classList.toggle('hiding', answersHidden);
  document.querySelectorAll('#wordItems .jpn').forEach(el => {
    el.classList.toggle('hidden-answer', answersHidden);
  });
}

function toggleAllQuestions() {
  questionsHidden = !questionsHidden;
  const btn = document.getElementById('questionToggleBtn');
  btn.textContent = questionsHidden ? 'ÂïèÈ°å„ÇíË°®Á§∫' : 'ÂïèÈ°å„ÇíÈö†„Åô';
  btn.classList.toggle('hiding', questionsHidden);
  document.querySelectorAll('#wordItems .eng').forEach(el => {
    el.classList.toggle('hidden-question', questionsHidden);
  });
}

function renderWordList(level) {
  currentWordFilter = level;
  const words = getWordListWords();
  let filtered;
  if (level === 'all') filtered = words;
  else if (level === 'bookmarked') filtered = words.filter(w => w.bookmarked);
  else filtered = words.filter(w => w.level === level);

  // Apply search filter
  const query = (document.getElementById('wordSearchInput')?.value || '').trim().toLowerCase();
  if (query) {
    filtered = filtered.filter(w =>
      w.english.toLowerCase().includes(query) || w.japanese.includes(query)
    );
  }

  const items = document.getElementById('wordItems');

  if (filtered.length === 0) {
    items.innerHTML = '<div style="text-align:center;padding:40px;color:var(--gray-400);">ÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
    return;
  }

  items.innerHTML = filtered.map(w => `
    <div class="word-item" data-eng="${escapeHtml(w.english)}" data-jpn="${escapeHtml(w.japanese)}" onclick="toggleWordAnswer(this)">
      <div class="level-dot ${w.level}"></div>
      <div class="eng ${questionsHidden ? 'hidden-question' : ''}">${escapeHtml(w.english)}</div>
      <div class="jpn-container"><div class="jpn ${answersHidden ? 'hidden-answer' : ''}" data-answer="${escapeHtml(w.japanese)}">${escapeHtml(w.japanese)}</div></div>
    </div>
  `).join('');
}

function toggleWordAnswer(el) {
  const eng = el.querySelector('.eng');
  const jpn = el.querySelector('.jpn');
  if (!jpn) return;
  
  if (answersHidden || questionsHidden) {
    // In hidden mode: tap reveals/hides and speaks the revealed part
    if (answersHidden && jpn.classList.contains('hidden-answer')) {
      jpn.classList.remove('hidden-answer');
      speakText(el.dataset.jpn);
      return;
    }
    if (answersHidden && !jpn.classList.contains('hidden-answer')) {
      jpn.classList.add('hidden-answer');
      return;
    }
    if (questionsHidden && eng && eng.classList.contains('hidden-question')) {
      eng.classList.remove('hidden-question');
      speakText(el.dataset.eng);
      return;
    }
    if (questionsHidden && eng && !eng.classList.contains('hidden-question')) {
      eng.classList.add('hidden-question');
      return;
    }
  } else {
    // Both shown: speak question, then answer sequentially
    speakTextSequence(el.dataset.eng, el.dataset.jpn);
  }
}

// Speak two texts in sequence (wait for first to finish)
function speakTextSequence(text1, text2) {
  if (soundMuted || !('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  
  const speak = (text, onEnd) => {
    let cleanText = text.replace(/[\u{1F000}-\u{1FFFF}]/gu, '').trim();
    if (!cleanText || /^[\d\s.,:;!?()\/\-]+$/.test(cleanText)) {
      if (onEnd) onEnd();
      return;
    }
    const lang = detectLang(cleanText);
    const langMap = { en: 'en-US', ja: 'ja-JP', ko: 'ko-KR', zh: 'zh-CN', fr: 'fr-FR', de: 'de-DE', es: 'es-ES' };
    const u = new SpeechSynthesisUtterance(cleanText);
    u.lang = langMap[lang] || 'en-US';
    u.rate = lang === 'en' ? 0.85 : 1.1;
    u.volume = 0.45;
    if (ttsVoiceCache[lang]) u.voice = ttsVoiceCache[lang];
    
    // iOS keepAlive workaround
    let iosKeepAlive = setInterval(() => {
      if (!window.speechSynthesis.speaking) {
        clearInterval(iosKeepAlive);
      } else {
        window.speechSynthesis.pause();
        window.speechSynthesis.resume();
      }
    }, 5000);
    
    u.onend = () => { clearInterval(iosKeepAlive); if (onEnd) setTimeout(onEnd, 300); };
    u.onerror = () => { clearInterval(iosKeepAlive); if (onEnd) onEnd(); };
    window.speechSynthesis.speak(u);
  };

  speak(text1, () => speak(text2, null));
}

// ============ WORD EDITOR ============
let editingWordIndex = null;
let editorSearchQuery = '';

function showWordEditor() {
  showScreen('word-editor');
  editorSearchQuery = '';
  const si = document.getElementById('editorSearchInput');
  if (si) si.value = '';
  document.getElementById('editorSearchClear')?.classList.remove('show');
  renderEditorList();
}

function onEditorSearch() {
  const input = document.getElementById('editorSearchInput');
  const clearBtn = document.getElementById('editorSearchClear');
  editorSearchQuery = (input?.value || '').trim().toLowerCase();
  clearBtn?.classList.toggle('show', editorSearchQuery.length > 0);
  renderEditorList();
}

function clearEditorSearch() {
  document.getElementById('editorSearchInput').value = '';
  editorSearchQuery = '';
  document.getElementById('editorSearchClear')?.classList.remove('show');
  renderEditorList();
}

function renderEditorList() {
  const words = getActiveWords();
  const el = document.getElementById('editorWordList');
  if (words.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--gray-400);">ÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
    return;
  }

  // Build index-mapped filtered list
  let items = words.map((w, i) => ({ w, i }));
  if (editorSearchQuery) {
    items = items.filter(({ w }) =>
      w.english.toLowerCase().includes(editorSearchQuery) ||
      w.japanese.toLowerCase().includes(editorSearchQuery)
    );
  }

  if (items.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:30px;color:var(--gray-400);font-size:13px;">Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
    return;
  }

  el.innerHTML = items.map(({ w, i }) => `
    <div class="editor-word-item" data-index="${i}">
      <div class="ew-delete-bg" onclick="deleteWord(${i})">ÂâäÈô§</div>
      <div class="ew-inner">
        <div class="ew-drag-handle" data-index="${i}">‚†ø</div>
        <div class="ew-content" onclick="showEditWordModal(${i})">
          <div class="ew-eng">${escapeHtml(w.english)}</div>
          <div class="ew-jpn">${escapeHtml(w.japanese)}</div>
        </div>
      </div>
    </div>
  `).join('');

  // Attach swipe + drag handlers
  el.querySelectorAll('.editor-word-item').forEach(item => {
    initSwipeToDelete(item);
    initDragToReorder(item);
  });
}

// --- Swipe to delete ---
function initSwipeToDelete(item) {
  const inner = item.querySelector('.ew-inner');
  let startX = 0, currentX = 0, swiping = false;

  inner.addEventListener('touchstart', (e) => {
    // Don't swipe if touch started on drag handle
    if (e.target.closest('.ew-drag-handle')) return;
    startX = e.touches[0].clientX;
    currentX = 0;
    swiping = true;
    inner.style.transition = 'none';
  }, { passive: true });

  inner.addEventListener('touchmove', (e) => {
    if (!swiping) return;
    const dx = e.touches[0].clientX - startX;
    currentX = Math.min(0, Math.max(-80, dx));
    inner.style.transform = `translateX(${currentX}px)`;
  }, { passive: true });

  inner.addEventListener('touchend', () => {
    if (!swiping) return;
    swiping = false;
    inner.style.transition = 'transform 0.25s ease';
    if (currentX < -40) {
      inner.style.transform = 'translateX(-80px)';
    } else {
      inner.style.transform = 'translateX(0)';
    }
  });

  inner.addEventListener('click', (e) => {
    if (inner.style.transform === 'translateX(-80px)') {
      e.stopPropagation();
      e.preventDefault();
      inner.style.transform = 'translateX(0)';
    }
  });
}

// --- Drag to reorder (long press on handle) ---
let dragState = null;

function initDragToReorder(item) {
  const handle = item.querySelector('.ew-drag-handle');
  if (!handle) return;
  let longPressTimer = null;

  handle.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    longPressTimer = setTimeout(() => {
      startDrag(item, touch.clientY);
    }, 300);
  });

  handle.addEventListener('touchmove', (e) => {
    if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
    if (dragState && dragState.el === item) {
      e.preventDefault();
      moveDrag(e.touches[0].clientY);
    }
  });

  handle.addEventListener('touchend', (e) => {
    if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
    if (dragState && dragState.el === item) {
      endDrag();
    }
  });
}

function startDrag(item, startY) {
  if (editorSearchQuery) {
    showToast('Ê§úÁ¥¢‰∏≠„ÅØ‰∏¶„ÅπÊõø„Åà„Åß„Åç„Åæ„Åõ„Çì');
    return;
  }
  const list = document.getElementById('editorWordList');
  const items = Array.from(list.querySelectorAll('.editor-word-item'));
  const rect = item.getBoundingClientRect();

  item.classList.add('dragging');
  dragState = {
    el: item,
    fromIndex: parseInt(item.dataset.index),
    startY: startY,
    offsetY: startY - rect.top,
    items: items
  };

  // Haptic feedback if available
  if (navigator.vibrate) navigator.vibrate(30);
}

function moveDrag(clientY) {
  if (!dragState) return;
  const list = document.getElementById('editorWordList');
  const items = Array.from(list.querySelectorAll('.editor-word-item'));

  // Clear all indicators
  items.forEach(it => {
    it.classList.remove('drag-over-top', 'drag-over-bottom');
  });

  // Find which item we're over
  for (const it of items) {
    if (it === dragState.el) continue;
    const rect = it.getBoundingClientRect();
    const mid = rect.top + rect.height / 2;
    if (clientY >= rect.top && clientY <= rect.bottom) {
      if (clientY < mid) {
        it.classList.add('drag-over-top');
      } else {
        it.classList.add('drag-over-bottom');
      }
      break;
    }
  }
}

function endDrag() {
  if (!dragState) return;
  const list = document.getElementById('editorWordList');
  const items = Array.from(list.querySelectorAll('.editor-word-item'));
  const fromIdx = dragState.fromIndex;

  // Find drop target
  let toIdx = fromIdx;
  for (const it of items) {
    if (it === dragState.el) continue;
    const idx = parseInt(it.dataset.index);
    if (it.classList.contains('drag-over-top')) {
      toIdx = idx < fromIdx ? idx : idx;
      break;
    }
    if (it.classList.contains('drag-over-bottom')) {
      toIdx = idx < fromIdx ? idx + 1 : idx;
      break;
    }
  }

  // Clean up visual state
  items.forEach(it => {
    it.classList.remove('drag-over-top', 'drag-over-bottom', 'dragging');
  });

  // Perform the move
  if (toIdx !== fromIdx) {
    const words = getActiveWords();
    const [moved] = words.splice(fromIdx, 1);
    const insertAt = toIdx > fromIdx ? toIdx - 1 : toIdx;
    words.splice(insertAt, 0, moved);
    saveState();
    showToast('‰∏¶„ÅπÊõø„Åà„Åæ„Åó„Åü');
  }

  dragState = null;
  renderEditorList();
}

// --- Add word with position ---
function addWordDirect() {
  editingWordIndex = null;
  document.getElementById('editWordTitle').textContent = 'ÂçòË™û„ÇíËøΩÂä†';
  document.getElementById('editWordEng').value = '';
  document.getElementById('editWordJpn').value = '';

  // Show position selector
  const posRow = document.getElementById('insertPositionRow');
  const posSel = document.getElementById('insertPosition');
  posRow.style.display = 'block';
  const words = getActiveWords();
  let options = '<option value="0">ÂÖàÈ†≠</option>';
  words.forEach((w, i) => {
    const label = w.english.length > 20 ? w.english.slice(0, 20) + '‚Ä¶' : w.english;
    options += `<option value="${i + 1}">${i + 1}. ${escapeHtml(label)} „ÅÆÂæå</option>`;
  });
  posSel.innerHTML = options;
  posSel.value = String(words.length); // default: Êú´Â∞æ

  const overlay = document.getElementById('editWordOverlay');
  overlay.classList.add('show');
  setTimeout(() => document.getElementById('editWordEng').focus(), 300);
}

function showAddWordModal() {
  addWordDirect();
}

function showEditWordModal(index) {
  const words = getActiveWords();
  const word = words[index];
  if (!word) return;
  editingWordIndex = index;
  document.getElementById('editWordTitle').textContent = 'ÂçòË™û„ÇíÁ∑®ÈõÜ';
  document.getElementById('editWordEng').value = word.english;
  document.getElementById('editWordJpn').value = word.japanese;
  // Hide position selector for editing
  document.getElementById('insertPositionRow').style.display = 'none';
  const overlay = document.getElementById('editWordOverlay');
  overlay.classList.add('show');
  setTimeout(() => document.getElementById('editWordEng').focus(), 300);
}

function closeEditWord() {
  document.getElementById('editWordOverlay').classList.remove('show');
}

function saveWord() {
  const eng = document.getElementById('editWordEng').value.trim();
  const jpn = document.getElementById('editWordJpn').value.trim();
  if (!eng || !jpn) {
    showToast('ÂïèÈ°åÊñá„Å®Á≠î„Åà„Çí‰∏°ÊñπÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }
  const words = getActiveWords();
  if (editingWordIndex === null) {
    // Add new word at selected position
    const pos = parseInt(document.getElementById('insertPosition').value) || 0;
    const newWord = { english: eng, japanese: jpn, level: 'unlearned', correctStreak: 0 };
    words.splice(pos, 0, newWord);
    showToast('ËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ');
  } else {
    // Edit existing word
    words[editingWordIndex].english = eng;
    words[editingWordIndex].japanese = jpn;
    showToast('‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
  }
  saveState();
  closeEditWord();
  renderEditorList();
}

function deleteWord(index) {
  const words = getActiveWords();
  const word = words[index];
  confirmAction('ÂçòË™û„ÇíÂâäÈô§', `„Äå${word.english}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`, function() {
    words.splice(index, 1);
    saveState();
    renderEditorList();
    showToast('ÂâäÈô§„Åó„Åæ„Åó„Åü');
  }, 'ÂâäÈô§„Åô„Çã');
}

// ============ RESET ============
// ============ CONFIRM MODAL ============
let pendingConfirmAction = null;

function confirmAction(title, desc, action, btnLabel) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmDesc').textContent = desc;
  document.getElementById('confirmDangerBtn').textContent = btnLabel || '„É™„Çª„ÉÉ„Éà„Åô„Çã';
  pendingConfirmAction = action;
  const btn = document.getElementById('confirmDangerBtn');
  btn.onclick = function() {
    const actionToRun = pendingConfirmAction;
    closeConfirm();
    if (actionToRun) actionToRun();
  };
  document.getElementById('confirmOverlay').classList.add('show');
}

function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('show');
  pendingConfirmAction = null;
}

function doResetCurrentDeck() {
  const deck = getActiveDeck();
  if (!deck) return;
  deck.words.forEach(w => { w.level = 'unlearned'; w.correctStreak = 0; });
  saveState();
  renderDeckList();
  updateDashboard();
  showToast('„Äå' + deck.name + '„Äç„ÅÆÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
}

function doResetAll() {
  decks = [];
  activeDeckId = null;
  localStorage.removeItem('mikan_decks');
  localStorage.removeItem('mikan_activeDeck');
  showScreen('import');
  showToast('„Åô„Åπ„Å¶„ÅÆ„Éá„ÉÉ„Ç≠„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
}

// ============ TOAST ============
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// ============ INIT ============
loadState();

// ============ PWA SERVICE WORKER ============
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(() => {
    console.log('SW registered');
  }).catch(err => console.log('SW error:', err));
}
</script>
</body>
</html>
