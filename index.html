<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<title>ç”°ä¸­ã®ä¸€å•ä¸€ç­”</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ç”°ä¸­ã®ä¸€å•ä¸€ç­”">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#FF8C00">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --orange-50: #FFF8F0;
  --orange-100: #FFECD6;
  --orange-200: #FFD4A8;
  --orange-400: #FFA94D;
  --orange-500: #FF8C00;
  --orange-600: #E67A00;
  --orange-700: #CC6B00;
  --green-400: #4ADE80;
  --green-500: #22C55E;
  --green-600: #16A34A;
  --blue-400: #60A5FA;
  --blue-500: #3B82F6;
  --yellow-400: #FACC15;
  --yellow-500: #EAB308;
  --red-400: #F87171;
  --red-500: #EF4444;
  --gray-100: #F3F4F6;
  --gray-200: #E5E7EB;
  --gray-300: #D1D5DB;
  --gray-400: #9CA3AF;
  --gray-500: #6B7280;
  --gray-600: #4B5563;
  --gray-700: #374151;
  --gray-800: #1F2937;
  --gray-900: #111827;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
  --shadow-xl: 0 16px 50px rgba(0,0,0,0.15);
  --radius: 16px;
  --radius-sm: 10px;
}

body {
  font-family: 'Zen Maru Gothic', sans-serif;
  background: linear-gradient(145deg, #FFF5EB 0%, #FFF0E0 30%, #FFE8D0 100%);
  min-height: 100vh;
  min-height: 100dvh;
  color: var(--gray-800);
  overflow-x: hidden;
  -webkit-tap-highlight-color: transparent;
  -webkit-text-size-adjust: 100%;
  touch-action: manipulation;
}

body::before {
  content: '';
  position: fixed;
  top: -120px;
  right: -120px;
  width: 350px;
  height: 350px;
  background: radial-gradient(circle, rgba(255,140,0,0.12) 0%, transparent 70%);
  border-radius: 50%;
  z-index: 0;
}
body::after {
  content: '';
  position: fixed;
  bottom: -80px;
  left: -80px;
  width: 250px;
  height: 250px;
  background: radial-gradient(circle, rgba(255,169,77,0.1) 0%, transparent 70%);
  border-radius: 50%;
  z-index: 0;
}

.app {
  max-width: 480px;
  margin: 0 auto;
  padding: 20px 16px 100px;
  padding-top: calc(20px + env(safe-area-inset-top));
  padding-bottom: calc(100px + env(safe-area-inset-bottom));
  padding-left: calc(16px + env(safe-area-inset-left));
  padding-right: calc(16px + env(safe-area-inset-right));
  position: relative;
  z-index: 1;
}

/* Header */
.header {
  text-align: center;
  padding: 24px 0 20px;
}
.header h1 {
  font-size: 28px;
  font-weight: 900;
  color: var(--orange-600);
  letter-spacing: -0.5px;
}
.header h1 span { font-size: 32px; }
.header p {
  font-size: 13px;
  color: var(--gray-500);
  margin-top: 4px;
  font-weight: 500;
}
.header { position: relative; }
.sound-toggle {
  position: absolute;
  top: 24px;
  right: 0;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  background: var(--gray-100);
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.sound-toggle.muted { opacity: 0.4; }

/* Screen transitions */
.screen { display: none; animation: fadeIn 0.3s ease; }
.screen.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Import screen */
.import-area {
  background: white;
  border-radius: var(--radius);
  padding: 32px 24px;
  text-align: center;
  box-shadow: var(--shadow-md);
  border: 2px dashed var(--orange-200);
  cursor: pointer;
  transition: all 0.25s;
  position: relative;
  overflow: hidden;
}
.import-area:hover {
  border-color: var(--orange-400);
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}
.import-area.dragover {
  border-color: var(--orange-500);
  background: var(--orange-50);
}
.import-icon {
  width: 64px;
  height: 64px;
  margin: 0 auto 16px;
  background: var(--orange-100);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
}
.import-area h3 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--gray-800);
}
.import-area p {
  font-size: 13px;
  color: var(--gray-400);
  line-height: 1.6;
}
.import-area input { display: none; }

.format-hint {
  margin-top: 20px;
  background: var(--gray-100);
  border-radius: var(--radius-sm);
  padding: 16px;
  text-align: left;
}
.format-hint code {
  display: block;
  font-family: 'DM Sans', monospace;
  font-size: 13px;
  color: var(--gray-600);
  line-height: 1.8;
}

.demo-btn {
  margin-top: 16px;
  background: var(--orange-500);
  color: white;
  border: none;
  padding: 14px 28px;
  border-radius: 50px;
  font-family: inherit;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 15px rgba(255,140,0,0.3);
}
.demo-btn:hover {
  background: var(--orange-600);
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(255,140,0,0.4);
}

/* ===== Deck Selector ===== */
.deck-selector {
  margin-bottom: 20px;
}
.deck-selector h3 {
  font-size: 14px;
  font-weight: 700;
  color: var(--gray-500);
  margin-bottom: 10px;
}
.deck-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.deck-card {
  background: white;
  border: 2px solid var(--gray-200);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 12px;
}
.deck-card:hover {
  border-color: var(--orange-300);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}
.deck-card.active {
  border-color: var(--orange-500);
  background: var(--orange-50);
  box-shadow: 0 0 0 3px rgba(255,140,0,0.12);
}
.deck-card .deck-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--orange-400), var(--orange-600));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}
.deck-card .deck-info {
  flex: 1;
  min-width: 0;
}
.deck-card .deck-name {
  font-size: 14px;
  font-weight: 700;
  color: var(--gray-800);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.deck-card .deck-meta {
  font-size: 11px;
  color: var(--gray-400);
  margin-top: 2px;
}
.deck-card .deck-edit {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: transparent;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}
.deck-card .deck-edit:hover {
  background: var(--orange-100);
}
.deck-card .deck-delete {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: transparent;
  color: var(--gray-300);
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}
.deck-card .deck-delete:hover {
  background: #FEE2E2;
  color: var(--red-500);
}
.deck-mini-progress {
  display: flex;
  gap: 3px;
  margin-top: 4px;
}
.deck-mini-progress .mini-bar {
  height: 4px;
  border-radius: 2px;
  transition: width 0.3s;
}

/* Dashboard */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 20px;
}
.stat-card {
  background: white;
  border-radius: var(--radius-sm);
  padding: 12px 6px;
  text-align: center;
  box-shadow: var(--shadow-sm);
  transition: transform 0.2s;
}
.stat-card:hover { transform: translateY(-2px); }
.stat-num {
  font-size: 22px;
  font-weight: 900;
  font-family: 'DM Sans', sans-serif;
}
.stat-label {
  font-size: 10px;
  font-weight: 700;
  margin-top: 4px;
  letter-spacing: -0.2px;
}
.stat-card.all .stat-num { color: var(--gray-700); }
.stat-card.all .stat-label { color: var(--gray-700); }
.stat-card.unlearned .stat-num { color: var(--gray-400); }
.stat-card.unlearned .stat-label { color: var(--gray-400); }
.stat-card.weak .stat-num { color: var(--red-500); }
.stat-card.weak .stat-label { color: var(--red-500); }
.stat-card.fuzzy .stat-num { color: var(--yellow-500); }
.stat-card.fuzzy .stat-label { color: var(--yellow-500); }
.stat-card.bookmarked .stat-num { color: var(--orange-500); }
.stat-card.bookmarked .stat-label { color: var(--orange-500); }
.stat-card.mastered .stat-num { color: var(--green-500); }
.stat-card.mastered .stat-label { color: var(--green-500); }

/* Progress bar */
.progress-bar-container {
  background: white;
  border-radius: var(--radius-sm);
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}
.progress-bar-container h4 {
  font-size: 13px;
  color: var(--gray-500);
  margin-bottom: 10px;
  font-weight: 500;
}
.progress-bar {
  height: 14px;
  border-radius: 7px;
  background: var(--gray-200);
  overflow: hidden;
  display: flex;
}
.progress-segment {
  height: 100%;
  transition: width 0.5s ease;
}
.progress-segment.mastered { background: var(--green-500); }
.progress-segment.fuzzy { background: var(--yellow-400); }
.progress-segment.weak { background: var(--red-400); }

/* Action buttons */
.action-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}
.action-btn {
  background: white;
  border: none;
  border-radius: var(--radius);
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  cursor: pointer;
  box-shadow: var(--shadow-md);
  transition: all 0.25s;
  text-align: left;
}
.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}
.action-btn:active { transform: scale(0.98); }
.action-btn .icon {
  width: 50px;
  height: 50px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  flex-shrink: 0;
}
.action-btn.study .icon { background: linear-gradient(135deg, var(--orange-400), var(--orange-600)); }
.action-btn.review .icon { background: linear-gradient(135deg, var(--blue-400), var(--blue-500)); }
.action-btn.list .icon { background: linear-gradient(135deg, var(--green-400), var(--green-600)); }
.action-btn .text h3 {
  font-size: 16px;
  font-weight: 700;
  color: var(--gray-800);
}
.action-btn .text p {
  font-size: 12px;
  color: var(--gray-400);
  margin-top: 2px;
}

.secondary-actions {
  display: flex;
  gap: 10px;
}
.secondary-btn {
  flex: 1;
  background: white;
  border: none;
  border-radius: var(--radius-sm);
  padding: 14px;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-600);
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  transition: all 0.2s;
}
.secondary-btn:hover { background: var(--gray-100); }

/* Quiz screen */
.quiz-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}
.quiz-back {
  background: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.quiz-back:hover { background: var(--gray-100); }
.quiz-progress-text {
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-500);
}
.quiz-progress-bar {
  height: 6px;
  background: var(--gray-200);
  border-radius: 3px;
  margin-bottom: 30px;
  overflow: hidden;
}
.quiz-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--orange-400), var(--orange-500));
  border-radius: 3px;
  transition: width 0.4s ease;
}

.quiz-card {
  background: white;
  border-radius: 24px;
  padding: 32px 24px 28px;
  text-align: center;
  box-shadow: var(--shadow-lg);
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
  min-height: 55vh;
  display: flex;
  flex-direction: column;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
}
.quiz-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--orange-400), var(--orange-500));
}
.quiz-card .level-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  margin-bottom: 12px;
  align-self: center;
}
.quiz-card .english-word {
  font-family: 'DM Sans', sans-serif;
  font-size: 32px;
  font-weight: 700;
  color: var(--gray-900);
  margin-bottom: 8px;
  letter-spacing: -0.5px;
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== Answer reveal area ===== */
.answer-reveal {
  margin-top: 16px;
  position: relative;
}
.answer-tap-hint {
  font-size: 14px;
  color: var(--gray-400);
  font-weight: 500;
  padding: 12px 0 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.answer-tap-hint .tap-icon {
  font-size: 18px;
  animation: tapBounce 2s ease infinite;
}
@keyframes tapBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}
.answer-text-area {
  display: none;
  font-size: 24px;
  color: var(--orange-500);
  font-weight: 700;
  padding: 8px 0 4px;
  animation: revealFade 0.3s ease;
}
.quiz-card.revealed .answer-tap-hint { display: none; }
.quiz-card.revealed .answer-text-area { display: block; }
.quiz-card.revealed { cursor: default; }

/* Bookmark button */
.bookmark-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 2px solid var(--gray-200);
  background: white;
  font-size: 20px;
  cursor: pointer;
  z-index: 10;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.6;
  flex-shrink: 0;
}
.bookmark-btn.active {
  background: var(--orange-500);
  border-color: var(--orange-500);
  opacity: 1;
}

@keyframes revealFade {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.choices {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.choice-btn {
  background: white;
  border: 2px solid var(--gray-200);
  border-radius: 14px;
  padding: 16px 20px;
  font-family: inherit;
  font-size: 16px;
  font-weight: 600;
  color: var(--gray-700);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
  position: relative;
  overflow: hidden;
}
.choice-btn:hover:not(.disabled) {
  border-color: var(--orange-400);
  background: var(--orange-50);
}
.choice-btn.correct {
  border-color: var(--green-500);
  background: #F0FFF4;
  color: var(--green-600);
  animation: correctPulse 0.4s ease;
}
.choice-btn.wrong {
  border-color: var(--red-500);
  background: #FFF5F5;
  color: var(--red-500);
  animation: shake 0.4s ease;
}
.choice-btn.disabled { pointer-events: none; }
.choice-btn.show-correct {
  border-color: var(--green-500);
  background: #F0FFF4;
}

@keyframes correctPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  75% { transform: translateX(6px); }
}

/* Know / Don't Know buttons */
.know-buttons-wrap {
  margin-top: 20px;
}
.know-buttons {
  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: center;
}
.know-buttons-wrap .bookmark-btn {
  margin: 12px auto 0;
  display: flex;
}
.know-btn {
  flex: 1;
  padding: 18px;
  border-radius: 14px;
  font-family: inherit;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid;
}
.know-btn.dont-know {
  background: #FFF5F5;
  border-color: var(--red-400);
  color: var(--red-500);
}
.know-btn.dont-know:hover { background: #FEE2E2; }
.know-btn.know {
  background: #F0FFF4;
  border-color: var(--green-400);
  color: var(--green-600);
}
.know-btn.know:hover { background: #DCFCE7; }

/* Quiz result */
.quiz-result {
  background: white;
  border-radius: 24px;
  padding: 40px 24px;
  text-align: center;
  box-shadow: var(--shadow-lg);
}
.quiz-result .result-icon {
  font-size: 56px;
  margin-bottom: 16px;
}
.quiz-result h2 {
  font-size: 24px;
  font-weight: 900;
  color: var(--gray-800);
  margin-bottom: 8px;
}
.quiz-result p {
  font-size: 14px;
  color: var(--gray-500);
  margin-bottom: 24px;
  line-height: 1.6;
}
.result-stats {
  display: flex;
  justify-content: center;
  gap: 24px;
  margin-bottom: 28px;
}
.result-stat {
  text-align: center;
}
.result-stat .num {
  font-family: 'DM Sans', sans-serif;
  font-size: 28px;
  font-weight: 700;
}
.result-stat .label {
  font-size: 12px;
  color: var(--gray-400);
  margin-top: 2px;
}
.result-btn {
  background: var(--orange-500);
  color: white;
  border: none;
  padding: 16px 40px;
  border-radius: 50px;
  font-family: inherit;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(255,140,0,0.3);
  transition: all 0.2s;
}
.result-btn:hover {
  background: var(--orange-600);
  transform: translateY(-1px);
}
.result-btn.review-btn {
  background: white;
  color: var(--orange-500);
  border: 2px solid var(--orange-500);
  box-shadow: none;
  margin-bottom: 10px;
}
.result-btn.review-btn:hover {
  background: var(--orange-50);
}
.missed-section {
  text-align: left;
  margin: 20px 0;
  width: 100%;
}
.missed-section h4 {
  font-size: 14px;
  font-weight: 700;
  color: var(--red-500);
  margin-bottom: 10px;
  text-align: center;
}
.missed-list {
  max-height: 240px;
  overflow-y: auto;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-sm);
  -webkit-overflow-scrolling: touch;
}
.missed-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  border-bottom: 1px solid var(--gray-100);
  font-size: 14px;
}
.missed-item:last-child { border-bottom: none; }
.missed-eng {
  font-weight: 600;
  color: var(--gray-800);
}
.missed-jpn {
  color: var(--red-400);
  font-size: 13px;
}

/* Level change summary */
.level-change-section {
  width: 100%;
  margin: 20px 0;
  text-align: left;
}
.level-change-section h4 {
  font-size: 14px;
  font-weight: 700;
  color: var(--gray-600);
  margin-bottom: 12px;
  text-align: center;
}
.lc-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.lc-label {
  font-size: 13px;
  font-weight: 700;
  color: var(--gray-600);
  width: 60px;
  text-align: right;
  flex-shrink: 0;
}
.lc-bar-wrap {
  flex: 1;
  height: 28px;
  background: var(--gray-100);
  border-radius: 8px;
  overflow: hidden;
  position: relative;
}
.lc-bar {
  height: 100%;
  border-radius: 8px;
  display: flex;
  align-items: center;
  padding-left: 10px;
  font-size: 13px;
  font-weight: 700;
  color: white;
  min-width: 28px;
  transition: width 0.6s ease;
}
.lc-diff {
  font-size: 16px;
  font-weight: 900;
  width: 40px;
  flex-shrink: 0;
}
.lc-diff.plus { color: var(--green-500); }
.lc-diff.minus { color: var(--red-500); }

/* Search bar */
.search-bar {
  display: flex;
  align-items: center;
  background: white;
  border-radius: 12px;
  padding: 10px 14px;
  margin-bottom: 12px;
  box-shadow: var(--shadow-sm);
  border: 2px solid var(--gray-200);
  transition: border-color 0.2s;
}
.search-bar:focus-within { border-color: var(--orange-400); }
.search-bar .search-icon { font-size: 16px; margin-right: 8px; }
.search-bar input {
  flex: 1;
  border: none;
  outline: none;
  font-family: inherit;
  font-size: 15px;
  background: transparent;
  color: var(--gray-800);
}
.search-bar input::placeholder { color: var(--gray-300); }
.search-clear {
  display: none;
  border: none;
  background: var(--gray-200);
  color: var(--gray-500);
  width: 24px;
  height: 24px;
  border-radius: 50%;
  font-size: 12px;
  cursor: pointer;
  align-items: center;
  justify-content: center;
}
.search-clear.show { display: flex; }

/* Deck tabs in word list */
.deck-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
  overflow-x: auto;
  padding-bottom: 4px;
  -webkit-overflow-scrolling: touch;
}
.deck-tabs::-webkit-scrollbar { display: none; }
.deck-tab {
  padding: 8px 16px;
  border-radius: 20px;
  border: 2px solid var(--gray-200);
  background: white;
  font-family: inherit;
  font-size: 13px;
  font-weight: 700;
  color: var(--gray-500);
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
}
.deck-tab:hover { border-color: var(--orange-300); }
.deck-tab.active {
  background: var(--orange-500);
  border-color: var(--orange-500);
  color: white;
}

/* Word list */
.word-list-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}
.word-list-header h2 {
  font-size: 20px;
  font-weight: 900;
  flex: 1;
}
.filter-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.filter-tab {
  padding: 8px 14px;
  border-radius: 20px;
  border: none;
  font-family: inherit;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
  color: var(--gray-500);
  box-shadow: var(--shadow-sm);
}
.filter-tab.active { color: white; }
.filter-tab.all.active { background: var(--gray-700); }
.filter-tab.unlearned.active { background: var(--gray-400); }
.filter-tab.weak.active { background: var(--red-500); }
.filter-tab.fuzzy.active { background: var(--yellow-500); }
.filter-tab.bookmarked.active { background: var(--orange-500); }
.filter-tab.mastered.active { background: var(--green-500); }

.word-items {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 60vh;
  overflow-y: auto;
  padding-right: 4px;
}
.word-items::-webkit-scrollbar { width: 4px; }
.word-items::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 2px; }

.word-item {
  background: white;
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: var(--shadow-sm);
  transition: all 0.2s;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
}
.word-item:hover { transform: translateX(4px); }
.word-item .level-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}
.word-item .level-dot.unlearned { background: var(--gray-300); }
.word-item .level-dot.weak { background: var(--red-500); }
.word-item .level-dot.fuzzy { background: var(--yellow-500); }
.word-item .level-dot.bookmarked { background: var(--orange-500); }
.word-item .level-dot.mastered { background: var(--green-500); }
.word-item .eng {
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  font-weight: 600;
  color: var(--gray-800);
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.word-item .jpn-container {
  position: relative;
  flex-shrink: 0;
  max-width: 45%;
}
.word-item .jpn {
  font-size: 13px;
  color: var(--gray-500);
  transition: all 0.2s;
}
.word-item .jpn.hidden-answer {
  color: transparent;
  background: var(--gray-200);
  border-radius: 4px;
  padding: 2px 8px;
  font-size: 12px;
  position: relative;
  min-width: 60px;
  text-align: center;
}
.word-item .jpn.hidden-answer::after {
  content: 'ã‚¿ãƒƒãƒ—';
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--gray-400);
  font-size: 11px;
  font-weight: 600;
}

/* Quiz mode selector */
#screen-quiz-setup {
  display: none;
  min-height: calc(100vh - 140px);
  flex-direction: column;
  justify-content: center;
}
#screen-quiz-setup.active {
  display: flex;
}
#screen-level-select {
  display: none;
  min-height: calc(100vh - 140px);
  flex-direction: column;
  justify-content: center;
}
#screen-level-select.active {
  display: flex;
}
.mode-selector {
  background: white;
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow-lg);
  margin-bottom: 20px;
}
.mode-selector h3 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  text-align: center;
}
.setup-section-label {
  font-size: 13px;
  font-weight: 700;
  color: var(--gray-500);
  margin-bottom: 8px;
  margin-top: 16px;
}
.setup-word-list {
  max-height: 40vh;
  overflow-y: auto;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  -webkit-overflow-scrolling: touch;
}
.setup-word-item {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  border-bottom: 1px solid var(--gray-100);
  font-size: 14px;
}
.setup-word-item:last-child { border-bottom: none; }
.setup-word-item .sw-eng {
  flex: 1;
  font-weight: 600;
  color: var(--gray-800);
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.setup-word-item .sw-jpn {
  color: var(--gray-400);
  font-size: 13px;
  flex-shrink: 0;
  max-width: 45%;
  text-align: right;
}
.mode-toggle {
  display: flex;
  gap: 0;
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid var(--gray-200);
  margin-bottom: 8px;
}
.mode-toggle-btn {
  flex: 1;
  padding: 14px;
  border: none;
  background: white;
  font-family: inherit;
  font-size: 15px;
  font-weight: 700;
  color: var(--gray-400);
  cursor: pointer;
  transition: all 0.2s;
}
.mode-toggle-btn.active {
  background: var(--orange-500);
  color: white;
}
.drill-desc {
  font-size: 12px;
  color: var(--orange-500);
  text-align: center;
  margin-bottom: 8px;
  font-weight: 600;
}

/* Level select screen */
.level-select-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.level-select-card {
  background: white;
  border-radius: var(--radius);
  padding: 24px 16px;
  text-align: center;
  box-shadow: var(--shadow-md);
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}
.level-select-card:hover { transform: translateY(-2px); }
.level-select-card:active { transform: scale(0.97); }
.level-select-card .ls-icon { font-size: 28px; margin-bottom: 8px; }
.level-select-card .ls-label {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 4px;
}
.level-select-card .ls-count {
  font-size: 22px;
  font-weight: 900;
  font-family: 'DM Sans', sans-serif;
}
.level-select-card.all .ls-label, .level-select-card.all .ls-count { color: var(--gray-700); }
.level-select-card.unlearned .ls-label, .level-select-card.unlearned .ls-count { color: var(--gray-400); }
.level-select-card.bookmarked .ls-label, .level-select-card.bookmarked .ls-count { color: var(--orange-500); }
.level-select-card.weak .ls-label, .level-select-card.weak .ls-count { color: var(--red-500); }
.level-select-card.fuzzy .ls-label, .level-select-card.fuzzy .ls-count { color: var(--yellow-500); }
.level-select-card.mastered .ls-label, .level-select-card.mastered .ls-count { color: var(--green-500); }
.mode-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.mode-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
}
.mode-option:hover { border-color: var(--orange-300); }
.mode-option.selected { border-color: var(--orange-500); background: var(--orange-50); }
.mode-option .mode-icon { font-size: 24px; }
.mode-option .mode-text h4 {
  font-size: 14px;
  font-weight: 700;
}
.mode-option .mode-text p {
  font-size: 11px;
  color: var(--gray-400);
  margin-top: 1px;
}

.count-selector {
  margin-top: 16px;
  text-align: center;
}
.count-selector label {
  font-size: 13px;
  color: var(--gray-500);
  font-weight: 500;
}
.count-selector select {
  margin-left: 8px;
  padding: 6px 12px;
  border: 2px solid var(--gray-200);
  border-radius: 8px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-700);
  cursor: pointer;
}
.start-quiz-btn {
  width: 100%;
  margin-top: 16px;
  background: var(--orange-500);
  color: white;
  border: none;
  padding: 16px;
  border-radius: 50px;
  font-family: inherit;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(255,140,0,0.3);
  transition: all 0.2s;
}
.start-quiz-btn:hover { background: var(--orange-600); }
.start-quiz-btn:disabled {
  background: var(--gray-300);
  box-shadow: none;
  cursor: not-allowed;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--gray-800);
  color: white;
  padding: 14px 24px;
  border-radius: 50px;
  font-size: 14px;
  font-weight: 600;
  z-index: 1000;
  box-shadow: var(--shadow-xl);
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.toast.show {
  opacity: 1;
  visibility: visible;
}

/* Level badge colors */
.badge-unlearned { background: var(--gray-200); color: var(--gray-500); }
.badge-weak { background: #FEE2E2; color: var(--red-500); }
.badge-fuzzy { background: #FEF9C3; color: var(--yellow-500); }
.badge-bookmarked { background: var(--orange-100); color: var(--orange-500); }
.badge-mastered { background: #DCFCE7; color: var(--green-600); }

/* Confirm modal */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 2000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 24px;
  animation: fadeInOverlay 0.2s ease;
}
.confirm-overlay.show { display: flex; }
@keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
.confirm-modal {
  background: white;
  border-radius: 20px;
  padding: 32px 24px 24px;
  text-align: center;
  max-width: 340px;
  width: 100%;
  box-shadow: var(--shadow-xl);
  animation: modalPop 0.25s ease;
}
@keyframes modalPop {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
.confirm-modal .confirm-icon {
  font-size: 40px;
  margin-bottom: 12px;
}
.confirm-modal h3 {
  font-size: 18px;
  font-weight: 900;
  color: var(--gray-800);
  margin-bottom: 8px;
}
.confirm-modal p {
  font-size: 13px;
  color: var(--gray-500);
  line-height: 1.6;
  margin-bottom: 24px;
}
.confirm-buttons {
  display: flex;
  gap: 10px;
}
.confirm-cancel {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  border: 2px solid var(--gray-200);
  background: white;
  font-family: inherit;
  font-size: 15px;
  font-weight: 700;
  color: var(--gray-600);
  cursor: pointer;
  transition: all 0.2s;
}
.confirm-cancel:hover { background: var(--gray-100); }
.confirm-danger {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: var(--red-500);
  font-family: inherit;
  font-size: 15px;
  font-weight: 700;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(239,68,68,0.3);
}
.confirm-danger:hover { background: #DC2626; }
.rename-input {
  width: 100%;
  padding: 12px 14px;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  font-family: inherit;
  font-size: 15px;
  margin-bottom: 16px;
  outline: none;
  transition: border-color 0.2s;
  box-sizing: border-box;
}
.rename-input:focus { border-color: var(--orange-400); }

/* Reset button */
.reset-area {
  margin-top: 20px;
  text-align: center;
}
.reset-btn {
  background: none;
  border: none;
  color: var(--gray-400);
  font-family: inherit;
  font-size: 12px;
  cursor: pointer;
  padding: 8px 16px;
  transition: color 0.2s;
}
.reset-btn:hover { color: var(--red-500); }
</style>
</head>
<body>
<div class="app">

  <!-- Screen: Import -->
  <div id="screen-import" class="screen active">
    <div class="header">
      <h1>ç”°ä¸­ã®ä¸€å•ä¸€ç­”ï¼</h1>
      <p>CSVã§èª­ã¿è¾¼ã¿ãƒ»ä¸€å•ä¸€ç­”ã§è¦šãˆã‚‹</p>
    </div>
    <div class="import-area" id="dropZone">
      <div class="import-icon">ğŸ“„</div>
      <h3>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</h3>
      <p>ã¾ãŸã¯ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br><small>è‹±èª,æ—¥æœ¬èª ã®å½¢å¼</small></p>
      <input type="file" id="fileInput" accept=".csv,.txt">
    </div>
    <div class="format-hint">
      <h4 style="font-size:13px;font-weight:700;margin-bottom:8px;color:var(--gray-600);">ğŸ“‹ CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹</h4>
      <code>
        abandon,è¦‹æ¨ã¦ã‚‹<br>
        accomplish,é”æˆã™ã‚‹<br>
        adequate,ååˆ†ãª
      </code>
    </div>
    <div style="text-align:center;margin-top:20px;">
      <button class="demo-btn" onclick="loadDemo()">ğŸ¯ ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã§è©¦ã™</button>
    </div>
  </div>

  <!-- Screen: Dashboard -->
  <div id="screen-dashboard" class="screen">
    <div class="header">
      <h1>ç”°ä¸­ã®ä¸€å•ä¸€ç­”ï¼</h1>
      <button class="sound-toggle" id="soundToggle" onclick="toggleSound()">ğŸ”Š</button>
    </div>
    <!-- Deck selector -->
    <div class="deck-selector">
      <h3>ğŸ“š ãƒ‡ãƒƒã‚­ä¸€è¦§</h3>
      <div class="deck-list" id="deckList"></div>
      <div style="margin-top:10px;">
        <button class="secondary-btn" style="width:100%;" onclick="document.getElementById('fileInputAdd').click()">ï¼‹ æ–°ã—ã„CSVã‚’è¿½åŠ </button>
        <input type="file" id="fileInputAdd" accept=".csv,.txt" style="display:none" onchange="handleFileAdd(this.files[0])">
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card all" onclick="showQuizSetupWithLevel('all')" style="cursor:pointer;">
        <div class="stat-num" id="count-all">0</div>
        <div class="stat-label">å…¨ã¦</div>
      </div>
      <div class="stat-card unlearned" onclick="showQuizSetupWithLevel('unlearned')" style="cursor:pointer;">
        <div class="stat-num" id="count-unlearned">0</div>
        <div class="stat-label">æœªå­¦ç¿’</div>
      </div>
      <div class="stat-card bookmarked" onclick="showQuizSetupWithLevel('bookmarked')" style="cursor:pointer;">
        <div class="stat-num" id="count-bookmarked">0</div>
        <div class="stat-label">ä¿å­˜æ¸ˆã¿</div>
      </div>
      <div class="stat-card weak" onclick="showQuizSetupWithLevel('weak')" style="cursor:pointer;">
        <div class="stat-num" id="count-weak">0</div>
        <div class="stat-label">è‹¦æ‰‹</div>
      </div>
      <div class="stat-card fuzzy" onclick="showQuizSetupWithLevel('fuzzy')" style="cursor:pointer;">
        <div class="stat-num" id="count-fuzzy">0</div>
        <div class="stat-label">ã†ã‚è¦šãˆ</div>
      </div>
      <div class="stat-card mastered" onclick="showQuizSetupWithLevel('mastered')" style="cursor:pointer;">
        <div class="stat-num" id="count-mastered">0</div>
        <div class="stat-label">è¦šãˆãŸ</div>
      </div>
    </div>

    <div class="action-section">
      <button class="action-btn study" onclick="showLevelSelect()">
        <div class="icon">ğŸ“</div>
        <div class="text">
          <h3>å­¦ç¿’ã‚’å§‹ã‚ã‚‹</h3>
          <p>ç¯„å›²ã‚’é¸ã‚“ã§ä¸€å•ä¸€ç­”ã‚¹ã‚¿ãƒ¼ãƒˆ</p>
        </div>
      </button>
    </div>

    <div class="action-section">
      <button class="action-btn list" onclick="showWordList()">
        <div class="icon">ğŸ“–</div>
        <div class="text">
          <h3>å˜èªä¸€è¦§</h3>
          <p>ã™ã¹ã¦ã®å˜èªã‚’ç¢ºèª</p>
        </div>
      </button>
    </div>

    <div class="reset-area">
      <button class="reset-btn" onclick="confirmAction('ã“ã®ãƒ‡ãƒƒã‚­ã®é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ', 'ã™ã¹ã¦ã®å˜èªãŒã€Œæœªå­¦ç¿’ã€ã«æˆ»ã‚Šã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚', doResetCurrentDeck)">ğŸ—‘ï¸ ã“ã®ãƒ‡ãƒƒã‚­ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="reset-btn" onclick="confirmAction('ã™ã¹ã¦ã®ãƒ‡ãƒƒã‚­ã‚’å‰Šé™¤', 'ã™ã¹ã¦ã®ãƒ‡ãƒƒã‚­ã¨å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚', doResetAll)">ğŸ—‘ï¸ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
    </div>
  </div>

  <!-- Screen: Level Select -->
  <div id="screen-level-select" class="screen">
    <div class="quiz-header">
      <button class="quiz-back" onclick="showScreen('dashboard')">â†</button>
      <span class="quiz-progress-text">å‡ºé¡Œç¯„å›²ã‚’é¸æŠ</span>
      <div style="width:40px"></div>
    </div>
    <div class="level-select-grid" id="levelSelectGrid"></div>
  </div>

  <!-- Screen: Quiz Setup -->
  <div id="screen-quiz-setup" class="screen">
    <div class="quiz-header">
      <button class="quiz-back" id="setupBackBtn" onclick="showScreen('dashboard')">â†</button>
      <span class="quiz-progress-text" id="setupTitle">æœªå­¦ç¿’</span>
      <div style="width:40px"></div>
    </div>
    <div class="mode-selector">
      <div class="setup-word-list" id="setupWordList"></div>
      <h4 class="setup-section-label">ãƒ¢ãƒ¼ãƒ‰</h4>
      <div class="mode-toggle" id="modeToggle">
        <button class="mode-toggle-btn active" onclick="selectMode('normal', this)">ãƒãƒ¼ãƒãƒ«</button>
        <button class="mode-toggle-btn" onclick="selectMode('drill', this)">ç‰¹è¨“</button>
      </div>
      <div class="drill-desc" id="drillDesc" style="display:none;">ã€ŒçŸ¥ã‚‰ãªã„ã€ã‚’é¸ã‚“ã å˜èªã‚’è¦šãˆã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—å‡ºé¡Œã—ã¾ã™</div>
      <div class="count-selector">
        <label>å‡ºé¡Œæ•°ï¼š</label>
        <select id="quizCount">
          <option value="10">10å•</option>
          <option value="20">20å•</option>
          <option value="30">30å•</option>
          <option value="40">40å•</option>
          <option value="50">50å•</option>
          <option value="60">60å•</option>
          <option value="70">70å•</option>
          <option value="80">80å•</option>
          <option value="90">90å•</option>
          <option value="100">100å•</option>
          <option value="110">110å•</option>
          <option value="120">120å•</option>
          <option value="130">130å•</option>
          <option value="140">140å•</option>
          <option value="150">150å•</option>
          <option value="160">160å•</option>
          <option value="170">170å•</option>
          <option value="180">180å•</option>
          <option value="190">190å•</option>
          <option value="200">200å•</option>
          <option value="all">ã™ã¹ã¦</option>
        </select>
      </div>
      <button class="start-quiz-btn" id="startQuizBtn" onclick="startQuiz()">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>
  </div>

  <!-- Screen: Quiz -->
  <div id="screen-quiz" class="screen">
    <div class="quiz-header">
      <button class="quiz-back" onclick="confirmQuit()">â†</button>
      <span class="quiz-progress-text" id="quizProgressText">1 / 10</span>
      <div style="width:40px"></div>
    </div>
    <div class="quiz-progress-bar">
      <div class="quiz-progress-fill" id="quizProgressFill"></div>
    </div>
    <div class="quiz-card" id="quizCard" onclick="revealAnswer()">
      <div class="level-badge" id="quizBadge">æœªå­¦ç¿’</div>
      <div class="english-word" id="quizWord"></div>
      <div class="answer-reveal" id="answerReveal"></div>
    </div>
    <div id="quizBody"></div>
  </div>

  <!-- Screen: Result -->
  <div id="screen-result" class="screen">
    <div class="quiz-result" id="resultContent"></div>
  </div>

  <!-- Screen: Word List -->
  <div id="screen-wordlist" class="screen">
    <div class="word-list-header">
      <button class="quiz-back" onclick="showScreen('dashboard')">â†</button>
      <h2>å˜èªä¸€è¦§</h2>
    </div>
    <div class="search-bar">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="wordSearchInput" placeholder="å˜èªã‚’æ¤œç´¢..." oninput="onWordSearch()">
      <button class="search-clear" id="searchClear" onclick="clearWordSearch()">âœ•</button>
    </div>
    <div class="deck-tabs" id="deckTabs"></div>
    <div class="filter-tabs" id="filterTabs"></div>
    <div class="word-items" id="wordItems"></div>
  </div>
</div>

<div class="confirm-overlay" id="confirmOverlay" onclick="closeConfirm()">
  <div class="confirm-modal" onclick="event.stopPropagation()">
    <div class="confirm-icon">âš ï¸</div>
    <h3 id="confirmTitle">æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</h3>
    <p id="confirmDesc">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
    <div class="confirm-buttons">
      <button class="confirm-cancel" onclick="closeConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="confirm-danger" id="confirmDangerBtn">ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button>
    </div>
  </div>
</div>

<div class="confirm-overlay" id="renameOverlay" onclick="closeRename()">
  <div class="confirm-modal" onclick="event.stopPropagation()">
    <div class="confirm-icon">âœï¸</div>
    <h3>ãƒ‡ãƒƒã‚­åã‚’å¤‰æ›´</h3>
    <input type="text" id="renameInput" class="rename-input" placeholder="æ–°ã—ã„åå‰">
    <div class="confirm-buttons">
      <button class="confirm-cancel" onclick="closeRename()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="confirm-danger" style="background:var(--orange-500);box-shadow:0 4px 12px rgba(255,140,0,0.3);" id="renameConfirmBtn">å¤‰æ›´ã™ã‚‹</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============ STATE ============
// decks: { id, name, words: [{ english, japanese, level, correctStreak }] }
let decks = [];
let activeDeckId = null;
let currentQuiz = null;
let quizMode = ''; // 'quiz' (4æŠ) or 'flashcard' (ä¸€å•ä¸€ç­”)
let selectedRange = 'all';

const LEVELS = {
  unlearned: { label: 'æœªå­¦ç¿’', badge: 'badge-unlearned' },
  weak: { label: 'è‹¦æ‰‹', badge: 'badge-weak' },
  fuzzy: { label: 'ã†ã‚è¦šãˆ', badge: 'badge-fuzzy' },
  mastered: { label: 'è¦šãˆãŸ', badge: 'badge-mastered' }
};

// ============ AUDIO SYSTEM ============
let audioCtx = null;
let audioEnabled = false;
let soundMuted = localStorage.getItem('mikan_muted') === 'true';

function initAudio() {
  if (audioCtx) return;
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    audioEnabled = true;
  } catch(e) { audioEnabled = false; }
}

function toggleSound() {
  soundMuted = !soundMuted;
  localStorage.setItem('mikan_muted', soundMuted);
  const btn = document.getElementById('soundToggle');
  btn.textContent = soundMuted ? 'ğŸ”‡' : 'ğŸ”Š';
  btn.classList.toggle('muted', soundMuted);
  if (!soundMuted) { initAudio(); sfxTap(); }
}

// Initialize toggle button state
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('soundToggle');
  if (btn) {
    btn.textContent = soundMuted ? 'ğŸ”‡' : 'ğŸ”Š';
    btn.classList.toggle('muted', soundMuted);
  }
});

// Unlock audio on first user interaction (required for iOS)
document.addEventListener('touchstart', initAudio, { once: true });
document.addEventListener('click', initAudio, { once: true });

function playTone(freq, duration, type, vol) {
  if (soundMuted || !audioCtx || !audioEnabled) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type || 'sine';
  osc.frequency.value = freq;
  gain.gain.value = vol || 0.15;
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + (duration || 0.2));
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + (duration || 0.2));
}

// Sound effects
function sfxTap() { playTone(800, 0.08, 'sine', 0.1); }
function sfxSelect() { playTone(600, 0.06, 'sine', 0.08); playTone(900, 0.06, 'sine', 0.08); }
function sfxCorrect() {
  playTone(523, 0.12, 'sine', 0.15);
  setTimeout(() => playTone(659, 0.12, 'sine', 0.15), 80);
  setTimeout(() => playTone(784, 0.18, 'sine', 0.15), 160);
}
function sfxWrong() {
  playTone(300, 0.15, 'square', 0.08);
  setTimeout(() => playTone(250, 0.2, 'square', 0.08), 120);
}
function sfxReveal() { playTone(440, 0.1, 'triangle', 0.1); }
function sfxBookmark() {
  playTone(700, 0.08, 'sine', 0.1);
  setTimeout(() => playTone(1050, 0.12, 'sine', 0.12), 60);
}
function sfxStart() {
  playTone(523, 0.1, 'sine', 0.12);
  setTimeout(() => playTone(659, 0.1, 'sine', 0.12), 100);
  setTimeout(() => playTone(784, 0.1, 'sine', 0.12), 200);
  setTimeout(() => playTone(1047, 0.2, 'sine', 0.15), 300);
}
function sfxComplete() {
  [523, 659, 784, 1047].forEach((f, i) => {
    setTimeout(() => playTone(f, 0.2, 'sine', 0.12), i * 120);
  });
  setTimeout(() => {
    [1047, 1319, 1568].forEach((f, i) => {
      setTimeout(() => playTone(f, 0.25, 'sine', 0.1), i * 100);
    });
  }, 500);
}
function sfxBack() { playTone(500, 0.06, 'sine', 0.06); }

// ============ TTS (Text-to-Speech) ============
function speakEN(text) {
  if (soundMuted || !('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  u.rate = 0.9;
  u.volume = 0.8;
  // Try to find English voice
  const voices = window.speechSynthesis.getVoices();
  const enVoice = voices.find(v => v.lang.startsWith('en') && v.name.includes('Samantha'))
    || voices.find(v => v.lang.startsWith('en-US'))
    || voices.find(v => v.lang.startsWith('en'));
  if (enVoice) u.voice = enVoice;
  window.speechSynthesis.speak(u);
}
function speakJP(text) {
  if (soundMuted || !('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ja-JP';
  u.rate = 0.9;
  u.volume = 0.8;
  const voices = window.speechSynthesis.getVoices();
  const jpVoice = voices.find(v => v.lang.startsWith('ja'));
  if (jpVoice) u.voice = jpVoice;
  window.speechSynthesis.speak(u);
}
// Preload voices
if ('speechSynthesis' in window) {
  window.speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
}

function getActiveDeck() {
  return decks.find(d => d.id === activeDeckId) || null;
}
function getActiveWords() {
  const deck = getActiveDeck();
  return deck ? deck.words : [];
}
// For 4-choice quiz, pull distractors from ALL decks
function getAllWords() {
  const all = [];
  decks.forEach(d => d.words.forEach(w => all.push(w)));
  return all;
}

// ============ PERSISTENCE ============
function saveState() {
  try {
    localStorage.setItem('mikan_decks', JSON.stringify(decks));
    localStorage.setItem('mikan_activeDeck', activeDeckId);
  } catch(e) {}
}
function loadState() {
  try {
    // Migration from old format
    const oldWords = localStorage.getItem('mikan_words');
    if (oldWords) {
      const parsed = JSON.parse(oldWords);
      if (parsed.length > 0) {
        decks = [{ id: generateId(), name: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿', words: parsed }];
        activeDeckId = decks[0].id;
        localStorage.removeItem('mikan_words');
        saveState();
        showScreen('dashboard');
        renderDeckList();
        updateDashboard();
        return;
      }
    }

    const saved = localStorage.getItem('mikan_decks');
    if (saved) {
      decks = JSON.parse(saved);
      activeDeckId = localStorage.getItem('mikan_activeDeck');
      if (decks.length > 0) {
        if (!activeDeckId || !decks.find(d => d.id === activeDeckId)) {
          activeDeckId = decks[0].id;
        }
        showScreen('dashboard');
        renderDeckList();
        updateDashboard();
      }
    }
  } catch(e) {}
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

// ============ CSV IMPORT ============
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    const text = e.target.result;
    const name = file.name.replace(/\.(csv|txt)$/i, '') || 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆ';
    addDeckFromCSV(text, name);
  };
  reader.readAsText(file, 'UTF-8');
}

function handleFileAdd(file) {
  if (!file) return;
  handleFile(file);
  document.getElementById('fileInputAdd').value = '';
}

function addDeckFromCSV(text, deckName) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  const words = [];

  for (const line of lines) {
    const parts = line.split(/[,\t]/).map(s => s.trim().replace(/^["']|["']$/g, ''));
    if (parts.length >= 2) {
      const english = parts[0];
      const japanese = parts[1];
      if (english && japanese) {
        words.push({ english, japanese, level: 'unlearned', correctStreak: 0 });
      }
    }
  }

  if (words.length > 0) {
    const deck = { id: generateId(), name: deckName, words };
    decks.push(deck);
    activeDeckId = deck.id;
    saveState();
    showScreen('dashboard');
    renderDeckList();
    updateDashboard();
    showToast(`ã€Œ${deckName}ã€ã«${words.length}èªã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);
  } else {
    showToast('å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  }
}

function loadDemo() {
  const demoData = `abandon,è¦‹æ¨ã¦ã‚‹
abolish,å»ƒæ­¢ã™ã‚‹
absorb,å¸åã™ã‚‹
abstract,æŠ½è±¡çš„ãª
abundant,è±Šå¯Œãª
accelerate,åŠ é€Ÿã™ã‚‹
accommodate,åå®¹ã™ã‚‹
accomplish,é”æˆã™ã‚‹
accumulate,è“„ç©ã™ã‚‹
accurate,æ­£ç¢ºãª
accuse,å‘Šç™ºã™ã‚‹
acquire,ç²å¾—ã™ã‚‹
adapt,é©å¿œã™ã‚‹
adequate,ååˆ†ãª
advocate,æå”±ã™ã‚‹
agriculture,è¾²æ¥­
allocate,å‰²ã‚Šå½“ã¦ã‚‹
ambitious,é‡å¿ƒçš„ãª
analogy,é¡ä¼¼
anticipate,äºˆæƒ³ã™ã‚‹
apparatus,è£…ç½®
appetite,é£Ÿæ¬²
appropriate,é©åˆ‡ãª
arbitrary,ä»»æ„ã®
assign,å‰²ã‚Šå½“ã¦ã‚‹
atmosphere,é›°å›²æ°—
attribute,å±æ€§
authentic,æœ¬ç‰©ã®
authorize,æ¨©é™ã‚’ä¸ãˆã‚‹
autonomy,è‡ªå¾‹`;
  addDeckFromCSV(demoData, 'ãƒ‡ãƒ¢å˜èª');
}

// ============ DECK LIST ============
function renderDeckList() {
  const container = document.getElementById('deckList');
  container.innerHTML = decks.map(deck => {
    const counts = { unlearned: 0, weak: 0, fuzzy: 0, mastered: 0 };
    deck.words.forEach(w => {
      if (counts[w.level] !== undefined) counts[w.level]++;
    });
    const total = deck.words.length || 1;
    const isActive = deck.id === activeDeckId;

    return `
      <div class="deck-card ${isActive ? 'active' : ''}" onclick="selectDeck('${deck.id}')">
        <div class="deck-icon">ğŸ“–</div>
        <div class="deck-info">
          <div class="deck-name">${escapeHtml(deck.name)}</div>
          <div class="deck-meta">${deck.words.length}èª</div>
          <div class="deck-mini-progress">
            <div class="mini-bar" style="width:${(counts.mastered/total)*100}%;background:var(--green-500);"></div>
            <div class="mini-bar" style="width:${(counts.fuzzy/total)*100}%;background:var(--yellow-400);"></div>
            <div class="mini-bar" style="width:${(counts.weak/total)*100}%;background:var(--red-400);"></div>
            <div class="mini-bar" style="width:${(counts.unlearned/total)*100}%;background:var(--gray-300);"></div>
          </div>
        </div>
        <button class="deck-edit" onclick="event.stopPropagation();renameDeck('${deck.id}')">âœï¸</button>
        <button class="deck-delete" onclick="event.stopPropagation();deleteDeck('${deck.id}')">âœ•</button>
      </div>
    `;
  }).join('');
}

function selectDeck(id) {
  sfxSelect();
  activeDeckId = id;
  saveState();
  renderDeckList();
  updateDashboard();
}

function deleteDeck(id) {
  const deck = decks.find(d => d.id === id);
  if (!deck) return;
  confirmAction('ãƒ‡ãƒƒã‚­ã‚’å‰Šé™¤', 'ã€Œ' + deck.name + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚', function() {
    decks = decks.filter(d => d.id !== id);
    if (activeDeckId === id) {
      activeDeckId = decks.length > 0 ? decks[0].id : null;
    }
    saveState();
    if (decks.length === 0) {
      showScreen('import');
    } else {
      renderDeckList();
      updateDashboard();
    }
    showToast('ãƒ‡ãƒƒã‚­ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  }, 'å‰Šé™¤ã™ã‚‹');
}

let renamingDeckId = null;

function renameDeck(id) {
  const deck = decks.find(d => d.id === id);
  if (!deck) return;
  renamingDeckId = id;
  document.getElementById('renameInput').value = deck.name;
  document.getElementById('renameOverlay').classList.add('show');
  setTimeout(() => document.getElementById('renameInput').focus(), 100);
  document.getElementById('renameConfirmBtn').onclick = function() {
    const newName = document.getElementById('renameInput').value.trim();
    if (!newName) return;
    deck.name = newName;
    saveState();
    renderDeckList();
    closeRename();
    showToast('ãƒ‡ãƒƒã‚­åã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
  };
}

function closeRename() {
  document.getElementById('renameOverlay').classList.remove('show');
  renamingDeckId = null;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ============ SCREENS ============
function showScreen(name) {
  sfxTap();
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');
}

// ============ DASHBOARD ============
function updateDashboard() {
  const words = getActiveWords();
  const counts = { unlearned: 0, weak: 0, fuzzy: 0, mastered: 0, bookmarked: 0 };
  words.forEach(w => {
    // migrate old 'almost' words to 'mastered'
    if (w.level === 'almost') w.level = 'mastered';
    if (counts[w.level] !== undefined) counts[w.level]++;
    if (w.bookmarked) counts.bookmarked++;
  });

  ['unlearned', 'weak', 'fuzzy', 'mastered'].forEach(level => {
    document.getElementById(`count-${level}`).textContent = counts[level];
  });
  document.getElementById('count-bookmarked').textContent = counts.bookmarked;
  document.getElementById('count-all').textContent = words.length;

  const total = words.length || 1;
  const bar = document.getElementById('progressBar');
  bar.innerHTML = '';
  ['mastered', 'fuzzy', 'weak'].forEach(level => {
    if (counts[level] > 0) {
      const seg = document.createElement('div');
      seg.className = `progress-segment ${level}`;
      seg.style.width = `${(counts[level] / total) * 100}%`;
      bar.appendChild(seg);
    }
  });
}

// ============ LEVEL SELECT ============
function showLevelSelect() {
  showScreen('level-select');
  const words = getActiveWords();
  const bookmarkedCount = words.filter(w => w.bookmarked).length;
  const counts = { unlearned: 0, weak: 0, fuzzy: 0, mastered: 0 };
  words.forEach(w => {
    if (w.level === 'almost') w.level = 'mastered';
    if (counts[w.level] !== undefined) counts[w.level]++;
  });

  const options = [
    { key: 'all', icon: 'ğŸ“š', label: 'å…¨ã¦', count: words.length, cls: 'all' },
    { key: 'unlearned', icon: 'â¬œ', label: 'æœªå­¦ç¿’', count: counts.unlearned, cls: 'unlearned' },
    { key: 'bookmarked', icon: 'ğŸ“Œ', label: 'ä¿å­˜æ¸ˆã¿', count: bookmarkedCount, cls: 'bookmarked' },
    { key: 'weak', icon: 'ğŸ”´', label: 'è‹¦æ‰‹', count: counts.weak, cls: 'weak' },
    { key: 'fuzzy', icon: 'ğŸŸ¡', label: 'ã†ã‚è¦šãˆ', count: counts.fuzzy, cls: 'fuzzy' },
    { key: 'mastered', icon: 'ğŸŸ¢', label: 'è¦šãˆãŸ', count: counts.mastered, cls: 'mastered' },
  ];

  document.getElementById('levelSelectGrid').innerHTML = options.map(opt => `
    <div class="level-select-card ${opt.cls}" onclick="showQuizSetupWithLevel('${opt.key}')">
      <div class="ls-icon">${opt.icon}</div>
      <div class="ls-label">${opt.label}</div>
      <div class="ls-count">${opt.count}èª</div>
    </div>
  `).join('');
}

// ============ QUIZ SETUP ============
let quizDrillMode = false;
let reviewMode = false; // true = no level changes (å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰)

function startMissedReview() {
  const missed = currentQuiz.results.filter(r => !r.correct);
  const seen = new Set();
  const pool = missed.filter(r => {
    if (seen.has(r.word.english)) return false;
    seen.add(r.word.english);
    return true;
  }).map(r => r.word);

  if (pool.length === 0) return;

  pool.sort(() => Math.random() - 0.5);

  reviewMode = true;
  quizMode = 'flashcard';
  quizDrillMode = true;

  // Save current levels (won't be changed)
  const beforeLevels = {};
  pool.forEach(w => { beforeLevels[w.english] = w.level; });

  currentQuiz = {
    words: pool,
    index: 0,
    correct: 0,
    wrong: 0,
    results: [],
    totalCount: pool.length,
    masteredCount: 0,
    beforeLevels: beforeLevels
  };

  showScreen('quiz');
  sfxStart();
  showQuizQuestion();
} // false = normal, true = drill

let quizSetupFrom = 'dashboard';

function showQuizSetupWithLevel(level) {
  // Track where we came from
  const currentScreen = document.querySelector('.screen.active');
  if (currentScreen && currentScreen.id === 'screen-level-select') {
    quizSetupFrom = 'level-select';
  } else {
    quizSetupFrom = 'dashboard';
  }

  quizMode = 'flashcard';
  selectedRange = level;
  quizDrillMode = false;
  showScreen('quiz-setup');

  // Set back button
  document.getElementById('setupBackBtn').onclick = function() {
    showScreen(quizSetupFrom);
    if (quizSetupFrom === 'level-select') showLevelSelect();
  };

  // Title
  const levelNames = {
    unlearned: 'æœªå­¦ç¿’', weak: 'è‹¦æ‰‹', fuzzy: 'ã†ã‚è¦šãˆ', mastered: 'è¦šãˆãŸ', bookmarked: 'ä¿å­˜æ¸ˆã¿'
  };
  document.getElementById('setupTitle').textContent = levelNames[level] || level;

  // Word list preview
  const pool = getQuizPool();
  const listEl = document.getElementById('setupWordList');
  if (pool.length === 0) {
    listEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--gray-400);font-size:14px;">å˜èªãŒã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    listEl.innerHTML = pool.slice(0, 50).map(w => `
      <div class="setup-word-item">
        <span class="sw-eng">${escapeHtml(w.english)}</span>
        <span class="sw-jpn">${escapeHtml(w.japanese)}</span>
      </div>
    `).join('') + (pool.length > 50 ? `<div style="text-align:center;padding:10px;color:var(--gray-400);font-size:12px;">ä»– ${pool.length - 50} èª...</div>` : '');
  }

  // Reset mode toggle
  document.querySelectorAll('.mode-toggle-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.mode-toggle-btn').classList.add('active');
  document.getElementById('drillDesc').style.display = 'none';

  updateStartBtn();
}

function selectMode(mode, el) {
  quizDrillMode = (mode === 'drill');
  el.parentElement.querySelectorAll('.mode-toggle-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('drillDesc').style.display = quizDrillMode ? 'block' : 'none';
}

function updateStartBtn() {
  const btn = document.getElementById('startQuizBtn');
  const pool = getQuizPool();
  btn.disabled = pool.length === 0;
  btn.textContent = pool.length === 0 ? 'å¯¾è±¡ã®å˜èªãŒã‚ã‚Šã¾ã›ã‚“' : 'ã‚¹ã‚¿ãƒ¼ãƒˆï¼';
}

function getQuizPool() {
  const words = getActiveWords();
  if (selectedRange === 'all') return [...words];
  if (selectedRange === 'bookmarked') return words.filter(w => w.bookmarked);
  return words.filter(w => w.level === selectedRange);
}

// ============ QUIZ ============
function startQuiz() {
  reviewMode = false;
  let pool = getQuizPool();
  if (pool.length === 0) return;

  pool = pool.sort(() => Math.random() - 0.5);

  const countSel = document.getElementById('quizCount').value;
  const count = countSel === 'all' ? pool.length : Math.min(parseInt(countSel), pool.length);
  pool = pool.slice(0, count);

  // Save original levels before quiz
  const beforeLevels = {};
  pool.forEach(w => { beforeLevels[w.english] = w.level; });

  currentQuiz = {
    words: pool,
    index: 0,
    correct: 0,
    wrong: 0,
    results: [],
    totalCount: pool.length,
    masteredCount: 0,
    beforeLevels: beforeLevels
  };

  showScreen('quiz');
  sfxStart();
  showQuizQuestion();
}

function showQuizQuestion() {
  const q = currentQuiz;
  const word = q.words[q.index];

  if (quizDrillMode) {
    document.getElementById('quizProgressText').textContent = `${q.masteredCount} / ${q.totalCount}`;
    document.getElementById('quizProgressFill').style.width = `${(q.masteredCount / q.totalCount) * 100}%`;
  } else {
    document.getElementById('quizProgressText').textContent = `${q.index + 1} / ${q.totalCount}`;
    document.getElementById('quizProgressFill').style.width = `${(q.index / q.totalCount) * 100}%`;
  }

  // Migrate old 'almost' level
  if (word.level === 'almost') word.level = 'mastered';

  const badge = document.getElementById('quizBadge');
  const levelInfo = LEVELS[word.level] || LEVELS.unlearned;
  badge.textContent = levelInfo.label;
  badge.className = `level-badge ${levelInfo.badge}`;
  document.getElementById('quizWord').textContent = word.english;
  // Read the question word aloud
  speakEN(word.english);

  // Reset card state
  const card = document.getElementById('quizCard');
  card.classList.remove('revealed');

  const answerReveal = document.getElementById('answerReveal');
  const body = document.getElementById('quizBody');

  // Answer area inside card (hint + hidden answer)
  answerReveal.innerHTML = `
    <div class="answer-tap-hint"><span class="tap-icon">ğŸ‘†</span> ã‚¿ãƒƒãƒ—ã—ã¦ç­”ãˆã‚’è¦‹ã‚‹</div>
    <div class="answer-text-area">${escapeHtml(word.japanese)}</div>
  `;

  if (quizMode === 'flashcard') {
    body.innerHTML = `
      <div class="know-buttons-wrap">
        <div class="know-buttons" id="knowButtons" style="opacity:0.3;pointer-events:none;">
          <button class="know-btn dont-know" onclick="answerKnowledge(false)">çŸ¥ã‚‰ãªã„ ğŸ˜£</button>
          <button class="know-btn know" onclick="answerKnowledge(true)">çŸ¥ã£ã¦ã‚‹ ğŸ˜Š</button>
        </div>
        <button class="bookmark-btn ${word.bookmarked ? 'active' : ''}" id="bookmarkBtn" onclick="toggleBookmark()">ğŸ“Œ</button>
      </div>
    `;
  } else {
    const choices = generateChoices(word);
    body.innerHTML = `
      <div class="choices">
        ${choices.map((c, i) => `
          <button class="choice-btn" onclick="answerChoice(this, ${i}, ${c === word.japanese})">${escapeHtml(c)}</button>
        `).join('')}
      </div>
    `;
  }
}

function revealAnswer() {
  const card = document.getElementById('quizCard');
  if (card.classList.contains('revealed')) return;
  card.classList.add('revealed');
  sfxReveal();
  // Read the answer aloud
  if (currentQuiz) {
    const word = currentQuiz.words[currentQuiz.index];
    setTimeout(() => speakJP(word.japanese), 200);
  }
  // Enable the know/don't-know buttons
  const btns = document.getElementById('knowButtons');
  if (btns) {
    btns.style.opacity = '1';
    btns.style.pointerEvents = 'auto';
  }
}

function toggleBookmark() {
  const word = currentQuiz.words[currentQuiz.index];
  word.bookmarked = !word.bookmarked;
  sfxBookmark();
  const btn = document.getElementById('bookmarkBtn');
  btn.classList.toggle('active', word.bookmarked);
  saveState();
}

function generateChoices(targetWord) {
  const correct = targetWord.japanese;
  // Pull distractors from all decks for better variety
  const allW = getAllWords().filter(w => w.japanese !== correct);
  const shuffled = allW.sort(() => Math.random() - 0.5).slice(0, 3);
  const choices = [correct, ...shuffled.map(w => w.japanese)];
  return choices.sort(() => Math.random() - 0.5);
}

function answerKnowledge(known) {
  const word = currentQuiz.words[currentQuiz.index];

  if (known) {
    sfxCorrect();
    currentQuiz.correct++;
    if (!reviewMode) {
      if (word.level === 'unlearned') {
        word.level = 'fuzzy';
        word.correctStreak = 1;
      } else if (word.level === 'weak') {
        word.level = 'fuzzy';
        word.correctStreak = 1;
      } else if (word.level === 'fuzzy') {
        word.level = 'mastered';
        word.correctStreak = 2;
      }
    }
    currentQuiz.results.push({ word, correct: true });
    if (quizDrillMode) currentQuiz.masteredCount++;
  } else {
    sfxWrong();
    currentQuiz.wrong++;
    if (!reviewMode) {
      word.level = 'weak';
      word.correctStreak = 0;
    }
    currentQuiz.results.push({ word, correct: false });

    // Drill mode: re-queue the word later
    if (quizDrillMode) {
      const remaining = currentQuiz.words.slice(currentQuiz.index + 1);
      const insertPos = Math.min(2 + Math.floor(Math.random() * 4), remaining.length);
      remaining.splice(insertPos, 0, word);
      currentQuiz.words = [...currentQuiz.words.slice(0, currentQuiz.index + 1), ...remaining];
    }
  }

  saveState();
  nextQuestion();
}

function answerChoice(btn, index, isCorrect) {
  const allBtns = btn.parentElement.querySelectorAll('.choice-btn');
  allBtns.forEach(b => b.classList.add('disabled'));

  const word = currentQuiz.words[currentQuiz.index];

  if (isCorrect) {
    btn.classList.add('correct');
    sfxCorrect();
    currentQuiz.correct++;
    word.correctStreak = (word.correctStreak || 0) + 1;
    if (word.correctStreak >= 2) word.level = 'mastered';
    else if (word.correctStreak >= 1) word.level = 'fuzzy';
    currentQuiz.results.push({ word, correct: true });
  } else {
    btn.classList.add('wrong');
    sfxWrong();
    currentQuiz.wrong++;
    word.level = 'weak';
    word.correctStreak = 0;
    allBtns.forEach(b => {
      if (b.textContent === word.japanese) b.classList.add('show-correct');
    });
    currentQuiz.results.push({ word, correct: false });
  }

  saveState();
  setTimeout(() => nextQuestion(), isCorrect ? 600 : 1200);
}

function nextQuestion() {
  currentQuiz.index++;
  if (quizDrillMode) {
    if (currentQuiz.masteredCount >= currentQuiz.totalCount) {
      showResult();
    } else if (currentQuiz.index >= currentQuiz.words.length) {
      showResult();
    } else {
      showQuizQuestion();
    }
  } else {
    if (currentQuiz.index >= currentQuiz.words.length) {
      showResult();
    } else {
      showQuizQuestion();
    }
  }
}

function showResult() {
  showScreen('result');
  sfxComplete();
  const q = currentQuiz;
  const totalAnswered = quizDrillMode ? q.totalCount : q.words.length;
  const pct = Math.round((q.correct / totalAnswered) * 100);

  let emoji, msg;
  if (pct >= 90) { emoji = 'ğŸ‰'; msg = 'ã™ã°ã‚‰ã—ã„ï¼'; }
  else if (pct >= 70) { emoji = 'ğŸ˜Š'; msg = 'ã„ã„èª¿å­ï¼'; }
  else if (pct >= 50) { emoji = 'ğŸ’ª'; msg = 'ã‚‚ã†å°‘ã—é ‘å¼µã‚ã†ï¼'; }
  else { emoji = 'ğŸ“š'; msg = 'å¾©ç¿’ãŒå¤§äº‹ï¼'; }

  // Calculate level changes
  const levelNames = { unlearned: 'æœªå­¦ç¿’', weak: 'è‹¦æ‰‹', fuzzy: 'ã†ã‚è¦šãˆ', mastered: 'è¦šãˆãŸ' };
  const levelColors = { unlearned: 'var(--gray-400)', weak: 'var(--red-500)', fuzzy: 'var(--yellow-500)', mastered: 'var(--green-500)' };
  const levelOrder = ['mastered', 'fuzzy', 'weak', 'unlearned'];

  // Count before/after per level (deduplicated by word)
  const beforeCounts = { unlearned: 0, weak: 0, fuzzy: 0, mastered: 0 };
  const afterCounts = { unlearned: 0, weak: 0, fuzzy: 0, mastered: 0 };
  const seenWords = new Set();
  // Use unique words from the quiz
  q.words.forEach(w => {
    if (seenWords.has(w.english)) return;
    seenWords.add(w.english);
    const before = q.beforeLevels[w.english] || 'unlearned';
    if (beforeCounts[before] !== undefined) beforeCounts[before]++;
    if (afterCounts[w.level] !== undefined) afterCounts[w.level]++;
  });

  // Build level change bars
  let levelChangeHtml = '<div class="level-change-section">';
  levelChangeHtml += '<h4>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰åŒ–</h4>';
  const totalWords = seenWords.size || 1;
  levelOrder.forEach(level => {
    const before = beforeCounts[level];
    const after = afterCounts[level];
    const diff = after - before;
    const diffStr = diff > 0 ? `<span class="lc-diff plus">+${diff}</span>` : diff < 0 ? `<span class="lc-diff minus">${diff}</span>` : '';
    const barWidth = Math.round((after / totalWords) * 100);
    levelChangeHtml += `
      <div class="lc-row">
        <div class="lc-label">${levelNames[level]}</div>
        <div class="lc-bar-wrap">
          <div class="lc-bar" style="width:${barWidth}%;background:${levelColors[level]}">${after}</div>
        </div>
        ${diffStr}
      </div>
    `;
  });
  levelChangeHtml += '</div>';

  // Missed words
  const missed = q.results.filter(r => !r.correct);
  const seenMissed = new Set();
  const uniqueMissed = missed.filter(r => {
    if (seenMissed.has(r.word.english)) return false;
    seenMissed.add(r.word.english);
    return true;
  });

  let missedHtml = '';
  if (uniqueMissed.length > 0) {
    missedHtml = `
      <div class="missed-section">
        <h4>ã¾ã¡ãŒãˆãŸå•é¡Œï¼ˆ${uniqueMissed.length}èªï¼‰</h4>
        <div class="missed-list">
          ${uniqueMissed.map(r => `
            <div class="missed-item">
              <span class="missed-eng">${escapeHtml(r.word.english)}</span>
              <span class="missed-jpn">${escapeHtml(r.word.japanese)}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  document.getElementById('resultContent').innerHTML = `
    <div class="result-icon">${emoji}</div>
    <h2>${msg}</h2>
    <p>${totalAnswered}å•ä¸­ ${q.correct}å•æ­£è§£</p>
    <div class="result-stats">
      <div class="result-stat">
        <div class="num" style="color:var(--green-500)">${q.correct}</div>
        <div class="label">æ­£è§£</div>
      </div>
      <div class="result-stat">
        <div class="num" style="color:var(--red-500)">${q.wrong}</div>
        <div class="label">ä¸æ­£è§£</div>
      </div>
      <div class="result-stat">
        <div class="num" style="color:var(--orange-500)">${pct}%</div>
        <div class="label">æ­£ç­”ç‡</div>
      </div>
    </div>
    ${levelChangeHtml}
    ${missedHtml}
    ${uniqueMissed.length > 0 ? '<button class="result-btn review-btn" onclick="startMissedReview()">ã¾ã¡ãŒãˆãŸå•é¡Œã‚’å¾©ç¿’ã™ã‚‹</button>' : ''}
    <button class="result-btn" onclick="showScreen('dashboard'); renderDeckList(); updateDashboard();">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  `;
}

function showMissedWords() {
  const missed = currentQuiz.results.filter(r => !r.correct);
  if (missed.length === 0) {
    showToast('ã¾ã¡ãŒãˆãŸå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ï¼ğŸ‰');
    return;
  }
  showScreen('wordlist');
  const items = document.getElementById('wordItems');
  document.getElementById('filterTabs').innerHTML = '';
  items.innerHTML = missed.map(r => `
    <div class="word-item" onclick="toggleWordAnswer(this)">
      <div class="level-dot ${r.word.level}"></div>
      <div class="eng">${escapeHtml(r.word.english)}</div>
      <div class="jpn-container"><div class="jpn">${escapeHtml(r.word.japanese)}</div></div>
    </div>
  `).join('');
}

function confirmQuit() {
  confirmAction('ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­', 'ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿã“ã“ã¾ã§ã®é€²æ—ã¯ä¿å­˜ã•ã‚Œã¾ã™ã€‚', function() {
    showScreen('dashboard');
    renderDeckList();
    updateDashboard();
  }, 'ä¸­æ–­ã™ã‚‹');
}

// ============ WORD LIST ============
let wordListDeckId = null; // track which deck is shown in word list

function showWordList() {
  wordListDeckId = activeDeckId;
  showScreen('wordlist');
  // Reset search
  const searchInput = document.getElementById('wordSearchInput');
  if (searchInput) { searchInput.value = ''; }
  document.getElementById('searchClear')?.classList.remove('show');
  currentWordFilter = 'all';
  renderDeckTabs();
  renderFilterTabs();
  renderWordList('all');
}

function renderDeckTabs() {
  const container = document.getElementById('deckTabs');
  container.innerHTML = decks.map(deck => `
    <button class="deck-tab ${deck.id === wordListDeckId ? 'active' : ''}" onclick="switchWordListDeck('${deck.id}', this)">${escapeHtml(deck.name)} (${deck.words.length})</button>
  `).join('');
}

function switchWordListDeck(deckId, el) {
  wordListDeckId = deckId;
  el.parentElement.querySelectorAll('.deck-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderFilterTabs();
  renderWordList('all');
}

function getWordListWords() {
  const deck = decks.find(d => d.id === wordListDeckId);
  return deck ? deck.words : [];
}

function renderFilterTabs() {
  const words = getWordListWords();
  const bookmarkedCount = words.filter(w => w.bookmarked).length;
  const counts = { all: words.length, unlearned: 0, weak: 0, fuzzy: 0, mastered: 0 };
  words.forEach(w => {
    if (counts[w.level] !== undefined) counts[w.level]++;
  });

  const tabs = [
    { key: 'all', label: `ã™ã¹ã¦ (${counts.all})` },
    { key: 'bookmarked', label: `ä¿å­˜æ¸ˆã¿ (${bookmarkedCount})` },
    { key: 'unlearned', label: `æœªå­¦ç¿’ (${counts.unlearned})` },
    { key: 'weak', label: `è‹¦æ‰‹ (${counts.weak})` },
    { key: 'fuzzy', label: `ã†ã‚è¦šãˆ (${counts.fuzzy})` },
    { key: 'mastered', label: `è¦šãˆãŸ (${counts.mastered})` },
  ];

  document.getElementById('filterTabs').innerHTML = tabs.map((t, i) => `
    <button class="filter-tab ${t.key} ${i === 0 ? 'active' : ''}" onclick="filterWords('${t.key}', this)">${t.label}</button>
  `).join('');
}

let currentWordFilter = 'all';

function onWordSearch() {
  const input = document.getElementById('wordSearchInput');
  const clearBtn = document.getElementById('searchClear');
  clearBtn.classList.toggle('show', input.value.length > 0);
  renderWordList(currentWordFilter);
}

function clearWordSearch() {
  document.getElementById('wordSearchInput').value = '';
  document.getElementById('searchClear').classList.remove('show');
  renderWordList(currentWordFilter);
}

function filterWords(level, el) {
  el.parentElement.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  currentWordFilter = level;
  renderWordList(level);
}

function renderWordList(level) {
  currentWordFilter = level;
  const words = getWordListWords();
  let filtered;
  if (level === 'all') filtered = words;
  else if (level === 'bookmarked') filtered = words.filter(w => w.bookmarked);
  else filtered = words.filter(w => w.level === level);

  // Apply search filter
  const query = (document.getElementById('wordSearchInput')?.value || '').trim().toLowerCase();
  if (query) {
    filtered = filtered.filter(w =>
      w.english.toLowerCase().includes(query) || w.japanese.includes(query)
    );
  }

  const items = document.getElementById('wordItems');

  if (filtered.length === 0) {
    items.innerHTML = '<div style="text-align:center;padding:40px;color:var(--gray-400);">å˜èªãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  items.innerHTML = filtered.map(w => `
    <div class="word-item" onclick="toggleWordAnswer(this)">
      <div class="level-dot ${w.level}"></div>
      <div class="eng">${escapeHtml(w.english)}</div>
      <div class="jpn-container"><div class="jpn hidden-answer" data-answer="${escapeHtml(w.japanese)}">${escapeHtml(w.japanese)}</div></div>
    </div>
  `).join('');
}

function toggleWordAnswer(el) {
  const jpn = el.querySelector('.jpn');
  if (!jpn) return;
  if (jpn.classList.contains('hidden-answer')) {
    jpn.classList.remove('hidden-answer');
  } else {
    jpn.classList.add('hidden-answer');
  }
}

// ============ RESET ============
// ============ CONFIRM MODAL ============
let pendingConfirmAction = null;

function confirmAction(title, desc, action, btnLabel) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmDesc').textContent = desc;
  document.getElementById('confirmDangerBtn').textContent = btnLabel || 'ãƒªã‚»ãƒƒãƒˆã™ã‚‹';
  pendingConfirmAction = action;
  const btn = document.getElementById('confirmDangerBtn');
  btn.onclick = function() {
    const actionToRun = pendingConfirmAction;
    closeConfirm();
    if (actionToRun) actionToRun();
  };
  document.getElementById('confirmOverlay').classList.add('show');
}

function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('show');
  pendingConfirmAction = null;
}

function doResetCurrentDeck() {
  const deck = getActiveDeck();
  if (!deck) return;
  deck.words.forEach(w => { w.level = 'unlearned'; w.correctStreak = 0; });
  saveState();
  renderDeckList();
  updateDashboard();
  showToast('ã€Œ' + deck.name + 'ã€ã®é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
}

function doResetAll() {
  decks = [];
  activeDeckId = null;
  localStorage.removeItem('mikan_decks');
  localStorage.removeItem('mikan_activeDeck');
  showScreen('import');
  showToast('ã™ã¹ã¦ã®ãƒ‡ãƒƒã‚­ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

// ============ TOAST ============
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// ============ INIT ============
loadState();

// ============ PWA SERVICE WORKER ============
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(() => {
    console.log('SW registered');
  }).catch(err => console.log('SW error:', err));
}
</script>
</body>
</html>
